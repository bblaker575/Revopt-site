<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Revopt — Choice Configurator (v7, CSV-driven)</title>
  <style>
    :root{--bg:#0B1020;--card:#12162A;--ink:#E6E9F5;--muted:#9CA3AF;--line:#1E2450;--line2:#242947;--btn:#0E1530;--primary:#4F46E5;}
    html,body{margin:0;height:100%} body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px} h1{margin:0 0 12px 0}
    .card{background:var(--card);border:1px solid var(--line2);border-radius:14px;padding:14px;margin:10px 0}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    label{display:inline-flex;gap:8px;align-items:center}
    select,button{background:var(--btn);border:1px solid var(--line2);border-radius:10px;color:var(--ink);padding:8px 10px}
    button.primary{background:var(--primary);border:none;font-weight:700;color:var(--bg)}
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid var(--line);padding:8px;font-size:14px;text-align:left;vertical-align:top}
    th{color:#C7CBF5} small{color:var(--muted)}
    .kpi{display:inline-block;margin-right:12px;background:var(--btn);border:1px solid var(--line);border-radius:12px;padding:8px 10px}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px} .items-cell{max-width:800px}
    .warn{color:#ffd966}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Revopt — Choice Configurator</h1>

    <div class="card">
      <small>Data-driven: loads <code>vsp_choice_master_v7.csv</code> (with exclusivity & track rules baked in).</small>
      <div id="csvStatus" class="warn" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <div class="row">
        <label>Track
          <select id="track">
            <option value="SV">SV</option>
            <option value="MF">Progressive (MF)</option>
            <option value="OCC">Occupational</option>
          </select>
        </label>

        <label>Sun
          <select id="sun">
            <option value="Clear">Clear</option>
            <option value="SolidTint">Tint – Solid</option>
            <option value="GradientTint">Tint – Gradient</option>
            <option value="Mirror">Mirror</option>
            <option value="Photochromic">Photochromic</option>
            <option value="Polarized">Polarized</option>
          </select>
        </label>

        <label>Oversize
          <select id="over">
            <option>None</option>
            <option>80% of U&C</option>
          </select>
        </label>

        <label>Rimless
          <select id="rim">
            <option>None</option>
            <option>Drill</option>
            <option>Groove</option>
          </select>
        </label>

        <button class="primary" id="build">Build tiers</button>
        <button id="csv">Download Quote CSV</button>
      </div>
    </div>

    <div class="card" id="tiers" style="display:none">
      <div id="kpis" class="badges"></div>
      <table>
        <thead>
          <tr>
            <th>Tier</th>
            <th>Items</th>
            <th style="text-align:right">Copay</th>
            <th style="text-align:right">VSP</th>
            <th style="text-align:right">Chargeback</th>
            <th style="text-align:right">Revenue</th>
          </tr>
        </thead>
        <tbody id="tierbody"></tbody>
      </table>
    </div>

    <div class="card">
      <details open>
        <summary>Master rows (v7 CSV)</summary>
        <table>
          <thead>
            <tr>
              <th>Group</th><th>Subtype</th><th>Enhancement</th><th>Code</th><th>Notes</th>
              <th style="text-align:right">Copay</th>
              <th style="text-align:right">VSP</th>
              <th style="text-align:right">Chargeback</th>
              <th>Exclusive</th><th>Applies</th>
            </tr>
          </thead>
          <tbody id="master"></tbody>
        </table>
      </details>
    </div>
  </div>

  <script>
    // --------- CSV LOADER ----------
    async function loadCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("CSV not found");
      const text = await res.text();
      return parseCSV(text);
    }
    function parseCSV(text){
      // simple CSV parser that handles quotes
      const rows = [];
      const lines = text.replace(/\r/g,"").split("\n").filter(x=>x.trim().length);
      const headers = splitCSVLine(lines[0]);
      for (let i=1; i<lines.length; i++){
        const cells = splitCSVLine(lines[i]);
        const row = {};
        headers.forEach((h,idx)=> row[h] = cells[idx] ?? "");
        rows.push(row);
      }
      return rows;
    }
    function splitCSVLine(line){
      const out=[]; let cur=""; let inQ=false;
      for (let i=0;i<line.length;i++){
        const ch=line[i];
        if (inQ){
          if (ch==='"' && line[i+1]==='"'){ cur+='"'; i++; }
          else if (ch === '"'){ inQ=false; }
          else cur+=ch;
        } else {
          if (ch === ','){ out.push(cur); cur=""; }
          else if (ch === '"'){ inQ=true; }
          else cur+=ch;
        }
      }
      out.push(cur);
      return out;
    }

    const fmtCurrency = (n)=> Number(n||0).toLocaleString("en-US",{style:"currency",currency:"USD"});

    // --------- GLOBAL DATA ----------
    let MASTER = []; // v7 rows

    function renderMasterTable(){
      const tb = document.getElementById("master");
      tb.innerHTML = "";
      MASTER.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.group||""}</td>
          <td>${r.subtype||""}</td>
          <td>${r.enhancement||""}</td>
          <td>${r.code||""}</td>
          <td>${r.notes||""}</td>
          <td style="text-align:right">${fmtCurrency(r.copay)}</td>
          <td style="text-align:right">${fmtCurrency(r.vsp)}</td>
          <td style="text-align:right">${fmtCurrency(r.chargeback)}</td>
          <td>${r.exclusive_key||""}</td>
          <td>${r.applies_to||""}</td>`;
        document.getElementById("master").appendChild(tr);
      });
    }

    // --------- PICKERS (DATA-DRIVEN, NO REGEX) ----------
    function chooseMaterial(level){
      const mats = MASTER.filter(r=>r.group==="Material");
      const pick = (filter)=> {
        const rows = mats.filter(filter);
        return rows.sort((a,b)=> b.copay - a.copay)[0] || null;
      };
      if (level==="BASIC") return pick(r=>r.subtype==="Poly" || r.subtype==="CR");
      if (level==="MID")   return pick(r=>r.subtype==="Mid" || r.subtype==="Poly");
      // BEST
      return pick(r=>r.subtype==="Hi70" || r.subtype==="Hi67" || r.subtype==="Mid" || r.subtype==="Poly" || r.subtype==="CR");
    }

    function chooseProgressive(level){
      const progs = MASTER.filter(r=>r.group==="Progressive");
      const families = level==="BEST" ? ["N","O","F"] : level==="MID" ? ["O","F","J"] : ["K","J","F"];
      for (const fam of families){
        const rows = progs.filter(r=>r.subtype===fam);
        if (rows.length) return rows.sort((a,b)=> b.copay - a.copay)[0];
      }
      return progs.sort((a,b)=> b.copay - a.copay)[0] || null;
    }

    function chooseAR(level){
      const ars = MASTER.filter(r=>r.group==="AR");
      if (!ars.length) return null;
      ars.sort((a,b)=> b.copay - a.copay);
      if (level==="BEST") return ars[0];
      if (level==="BASIC") return ars[ars.length-1];
      return ars[Math.max(0, Math.floor(ars.length/2)-1)];
    }

    function chooseSun(choice){
      if (!choice || choice==="Clear") return null;
      const row = MASTER.find(r=>r.group==="Sun" && r.subtype===choice);
      return row || null;
    }

    function enforceExclusivity(items){
      const seen = new Set();
      return items.filter(r=>{
        const key = (r.exclusive_key||"").trim();
        if (!key) return true;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    function totals(items){
      const sum = (k)=> items.reduce((s,r)=> s + Number(r[k]||0), 0);
      const copay = sum("copay"), vsp = sum("vsp"), cb = sum("chargeback");
      return { copay, vsp, cb, revenue: copay + vsp - cb };
    }

    function appliesToTrack(row, track){
      const a = (row.applies_to||"ALL").toUpperCase();
      if (a==="ALL") return true;
      return a.split(/\s*,\s*/).includes(track.toUpperCase());
    }

    function buildTier(track, sun, level){
      const items = [];
      if (track==="MF"){
        const p = chooseProgressive(level); if (p && appliesToTrack(p, "MF")) items.push(p);
      } else if (track==="SV" || track==="OCC"){
        const m = chooseMaterial(level); if (m && appliesToTrack(m, track)) items.push(m);
      }
      const ar = chooseAR(level); if (ar && appliesToTrack(ar, track)) items.push(ar);
      const s = chooseSun(sun);  if (s && appliesToTrack(s, track)) items.push(s);
      return enforceExclusivity(items);
    }

    function renderTiers(tiers){
      document.getElementById("tiers").style.display = "block";
      const tb = document.getElementById("tierbody"); tb.innerHTML = "";
      const k = document.getElementById("kpis"); k.innerHTML = "";
      tiers.forEach(tt=>{
        const x = totals(tt.items);
        const list = tt.items.map(i=> i.enhancement).join(", ");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${tt.name}</b></td>
          <td class="items-cell">${list}</td>
          <td style="text-align:right">${fmtCurrency(x.copay)}</td>
          <td style="text-align:right">${fmtCurrency(x.vsp)}</td>
          <td style="text-align:right">${fmtCurrency(x.cb)}</td>
          <td style="text-align:right"><b>${fmtCurrency(x.revenue)}</b></td>`;
        tb.appendChild(tr);

        const badge = document.createElement("span");
        badge.className = "kpi";
        badge.innerHTML = `<small>${tt.name} revenue</small> <b>${fmtCurrency(x.revenue)}</b>`;
        k.appendChild(badge);
      });
    }

    // --------- EVENTS ----------
    document.getElementById("build").addEventListener("click", ()=>{
      const track = document.getElementById("track").value;      // SV | MF | OCC
      const sun   = document.getElementById("sun").value;        // Clear | subtype
      const over  = document.getElementById("over").value;
      const rim   = document.getElementById("rim").value;

      const tiers = [
        { name:"BEST",  items: buildTier(track, sun, "BEST")  },
        { name:"MID",   items: buildTier(track, sun, "MID")   },
        { name:"BASIC", items: buildTier(track, sun, "BASIC") }
      ];

      // Optional add-ons that aren't exclusive to track
      if (over !== "None"){
        const os = MASTER.find(r=>r.group==="Oversize");
        if (os) tiers.forEach(tt=> tt.items.push(os));
      }
      if (rim !== "None"){
        const rl = MASTER.find(r=> r.group==="Rimless" && r.subtype===rim);
        if (rl) tiers.forEach(tt=> tt.items.push(rl));
      }

      // Final exclusivity pass
      tiers.forEach(tt=> tt.items = enforceExclusivity(tt.items));
      renderTiers(tiers);
    });

    document.getElementById("csv").addEventListener("click", ()=>{
      const track = document.getElementById("track").value;
      const sun   = document.getElementById("sun").value;
      const tiers = [
        { name:"BEST",  items: buildTier(track, sun, "BEST")  },
        { name:"MID",   items: buildTier(track, sun, "MID")   },
        { name:"BASIC", items: buildTier(track, sun, "BASIC") }
      ];
      const rows = [["Tier","Group","Subtype","Enhancement","Code","Copay","VSP","Chargeback"]];
      tiers.forEach(tt=>{
        tt.items.forEach(i=>{
          rows.push([tt.name, i.group, i.subtype, i.enhancement, i.code, i.copay||0, i.vsp||0, i.chargeback||0]);
        })
      });
      const csv = rows.map(r=> r.map(x=> `"${String(x??"").replace(/"/g,'""')}"`).join(",")).join("\n");
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
      a.download = "revopt_quote.csv";
      a.click();
    });

    // --------- BOOT ---------
    (async function boot(){
      const status = document.getElementById("csvStatus");
      try{
        MASTER = await loadCSV("./vsp_choice_master_v7.csv");
        // Coerce numerics
        MASTER = MASTER.map(r=>({
          ...r,
          copay: Number(r.copay||0),
          vsp: Number(r.vsp||0),
          chargeback: Number(r.chargeback||0)
        }));
        status.textContent = "Loaded v7 CSV.";
      }catch(e){
        status.textContent = "Could not find vsp_choice_master_v7.csv in this repo. Upload it to the repo root.";
        MASTER = [];
      }
      renderMasterTable();
    })();
  </script>
</body>
</html>
