<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Revopt — Choice Configurator (v6 embedded)</title>
<style>
:root{--bg:#0B1020;--ink:#E6E9F5;--muted:#9AA3B2;--card:#12162A;--line:#242947;--brand:#111827;--pri:#4F46E5}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
.container{max-width:1100px;margin:0 auto;padding:16px}
h1{font-size:26px;margin:10px 0 6px}
.section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:10px 0}
.row{display:flex;gap:10px;flex-wrap:wrap}
label{font-size:14px;color:var(--muted);display:block;margin:6px 0}
select{background:#0E1530;border:1px solid #273057;border-radius:10px;color:#E6E9F5;padding:8px 10px}
.btn{padding:10px 14px;border-radius:10px;border:1px solid #2A2F4A;background:#141A2E;color:#E6E9F5;cursor:pointer}
.btn.primary{background:var(--pri);color:#0B1020;border:none;font-weight:700}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #1E2450;padding:8px;font-size:14px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0F1732;border:1px solid #22284A;color:#9AA3B2;font-size:12px}
.total{display:flex;gap:20px;flex-wrap:wrap}
.kpi{background:#0E1530;border:1px solid #1E2450;border-radius:12px;padding:10px 12px}
.kpi b{font-size:18px}
small{color:#9AA3B2}
</style>
</head>
<body>
<div class="container">
  <h1>Revopt — Choice Configurator</h1>
  <div class="section">
    <div class="row">
      <div><span class="badge" id="masterBadge">VSP Choice Master v6 embedded</span></div>
      <div style="margin-left:auto"><button class="btn" id="btnCSV">Download CSV</button></div>
    </div>
    <small>Fields: Category, Enhancement, Code, Notes, Patient Copay, VSP Reimbursement, Chargeback</small>
  </div>

  <div class="section">
    <div class="row">
      <div><label>Track</label><select id="track"><option>SV</option><option>Progressive</option><option>Occupational</option></select></div>
      <div><label>Sun Path</label><select id="sun"><option>Clear</option><option>Photochromic</option><option>Polarized</option><option>Tint</option></select></div>
      <div><label>Oversize</label><select id="oversize"><option>None</option><option>80% of U&C</option></select></div>
      <div><label>Rimless</label><select id="rimless"><option>None</option><option>Drill</option><option>Groove</option></select></div>
      <div style="align-self:end"><button class="btn primary" id="btnBuild">Build tiers</button></div>
    </div>
  </div>

  <div class="section" id="tiersSection" style="display:none">
    <h3 style="margin:0 0 8px">Tiers</h3>
    <div class="row total" id="kpis"></div>
    <table class="table" id="tierTable">
      <thead><tr><th>Tier</th><th>Items</th><th style="text-align:right">Patient Copay</th><th style="text-align:right">VSP Reimb</th><th style="text-align:right">Chargeback</th><th style="text-align:right">Revenue</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <details open>
      <summary>Master rows (v6)</summary>
      <table class="table" id="masterTable">
        <thead><tr><th>Category</th><th>Enhancement</th><th>Code</th><th>Notes/Rules</th><th style="text-align:right">Copay</th><th style="text-align:right">VSP</th><th style="text-align:right">Chargeback</th></tr></thead>
        <tbody></tbody>
      </table>
    </details>
  </div>
</div>

<script>
window.__MASTER__ = [{"Category": "Material", "Enhancement": "Aspheric Plastic 1.50", "Notes": "nan", "Copay": 31.0, "VSP": 0.0, "Chargeback": 10.0, "Code": "AA"}, {"Category": "Material", "Enhancement": "Aspheric Plastic 1.50", "Notes": "nan", "Copay": 35.0, "VSP": 0.0, "Chargeback": 14.0, "Code": "AA"}, {"Category": "Material", "Enhancement": "High-index Plastic 1.53\u20131.60/Trivex", "Notes": "nan", "Copay": 56.0, "VSP": 0.0, "Chargeback": 29.0, "Code": "AB"}, {"Category": "Material", "Enhancement": "High-index Plastic 1.53\u20131.60/Trivex", "Notes": "nan", "Copay": 60.0, "VSP": 0.0, "Chargeback": 33.0, "Code": "AB"}, {"Category": "Material", "Enhancement": "High-index Plastic 1.66/1.67", "Notes": "nan", "Copay": 83.0, "VSP": 0.0, "Chargeback": 48.0, "Code": "AH"}, {"Category": "Material", "Enhancement": "High-index Plastic 1.66/1.67", "Notes": "nan", "Copay": 98.0, "VSP": 0.0, "Chargeback": 58.0, "Code": "AH"}, {"Category": "Material", "Enhancement": "High-index Plastic 1.70 and Above", "Notes": "nan", "Copay": 111.0, "VSP": 0.0, "Chargeback": 68.0, "Code": "AJ"}, {"Category": "Material", "Enhancement": "High-index Plastic 1.70 and Above", "Notes": "nan", "Copay": 118.0, "VSP": 0.0, "Chargeback": 78.0, "Code": "AJ"}, {"Category": "Material", "Enhancement": "Polycarbonate", "Notes": "Note: No Service Fee for covered polycarbonate for children/handicapped/Federal Plan.", "Copay": 35.0, "VSP": 0.0, "Chargeback": 14.0, "Code": "AD"}, {"Category": "Material", "Enhancement": "Polycarbonate", "Notes": "Note: No Service Fee for covered polycarbonate for children/handicapped/Federal Plan.", "Copay": 35.0, "VSP": 0.0, "Chargeback": 14.0, "Code": "AD"}, {"Category": "Material", "Enhancement": "High-index Glass 1.60\u20131.80 (Clear)", "Notes": "nan", "Copay": 60.0, "VSP": 0.0, "Chargeback": 35.0, "Code": "AF"}, {"Category": "Material", "Enhancement": "High-index Glass 1.60\u20131.80 (Clear)", "Notes": "nan", "Copay": 138.0, "VSP": 0.0, "Chargeback": 85.0, "Code": "AF"}, {"Category": "Material", "Enhancement": "Digital Aspheric Lenses \u2013 Plastic", "Notes": "nan", "Copay": 45.0, "VSP": 0.0, "Chargeback": 24.0, "Code": "BA"}, {"Category": "Material", "Enhancement": "Digital Aspheric Lenses \u2013 Plastic", "Notes": "nan", "Copay": 55.0, "VSP": 0.0, "Chargeback": 34.0, "Code": "BA"}, {"Category": "Material", "Enhancement": "Digital Aspheric \u2013 High-index Plastic 1.53\u20131.60/Trivex", "Notes": "Copay = 45+28 (SV) / 55+28 (MF)", "Copay": 73.0, "VSP": 0.0, "Chargeback": 16.0, "Code": "BA+BB"}, {"Category": "Material", "Enhancement": "Digital Aspheric \u2013 High-index Plastic 1.53\u20131.60/Trivex", "Notes": "Copay = 45+28 (SV) / 55+28 (MF)", "Copay": 83.0, "VSP": 0.0, "Chargeback": 16.0, "Code": "BA+BB"}, {"Category": "Material", "Enhancement": "Digital Aspheric \u2013 High-index Plastic 1.66/1.67", "Notes": "Copay = 45+58 (SV) / 55+68 (MF)", "Copay": 103.0, "VSP": 0.0, "Chargeback": 37.0, "Code": "BA+BH"}, {"Category": "Material", "Enhancement": "Digital Aspheric \u2013 High-index Plastic 1.66/1.67", "Notes": "Copay = 45+58 (SV) / 55+68 (MF)", "Copay": 123.0, "VSP": 0.0, "Chargeback": 40.0, "Code": "BA+BH"}, {"Category": "Material", "Enhancement": "Digital Aspheric \u2013 High-index Plastic 1.70 and Above", "Notes": "Copay = 45+86 (SV)", "Copay": 131.0, "VSP": 0.0, "Chargeback": 57.0, "Code": "BA+BJ"}, {"Category": "Material", "Enhancement": "Digital Aspheric \u2013 Polycarbonate", "Notes": "Copay = 45+10 (SV) / 55+10 (MF)", "Copay": 55.0, "VSP": 0.0, "Chargeback": 10.0, "Code": "BA+BD"}, {"Category": "Material", "Enhancement": "Digital Aspheric \u2013 Polycarbonate", "Notes": "Copay = 45+10 (SV) / 55+10 (MF)", "Copay": 65.0, "VSP": 0.0, "Chargeback": 10.0, "Code": "BA+BD"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized Lenses \u2013 Plastic A", "Notes": "nan", "Copay": 57.0, "VSP": 0.0, "Chargeback": 36.0, "Code": "DA"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized Lenses \u2013 Plastic A", "Notes": "nan", "Copay": 77.0, "VSP": 0.0, "Chargeback": 48.0, "Code": "DA"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized \u2013 High-index Plastic 1.53\u20131.60/Trivex", "Notes": "Copay = 57+76 (SV) / 77+95 (MF)", "Copay": 133.0, "VSP": 0.0, "Chargeback": 47.0, "Code": "DA+DB"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized \u2013 High-index Plastic 1.53\u20131.60/Trivex", "Notes": "Copay = 57+76 (SV) / 77+95 (MF)", "Copay": 172.0, "VSP": 0.0, "Chargeback": 59.0, "Code": "DA+DB"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized \u2013 High-index Plastic 1.66/1.67", "Notes": "Copay = 57+89 (SV) / 77+108 (MF)", "Copay": 146.0, "VSP": 0.0, "Chargeback": 55.0, "Code": "DA+DH"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized \u2013 High-index Plastic 1.66/1.67", "Notes": "Copay = 57+89 (SV) / 77+108 (MF)", "Copay": 185.0, "VSP": 0.0, "Chargeback": 67.0, "Code": "DA+DH"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized \u2013 High-index Plastic 1.70 and Above", "Notes": "Copay = 57+108 (SV)", "Copay": 165.0, "VSP": 0.0, "Chargeback": 70.0, "Code": "DA+DJ"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized \u2013 Polycarbonate", "Notes": "Copay = 57+31 (SV) / 77+31 (MF)", "Copay": 88.0, "VSP": 0.0, "Chargeback": 13.0, "Code": "DA+DD"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized \u2013 Polycarbonate", "Notes": "Copay = 57+31 (SV) / 77+31 (MF)", "Copay": 108.0, "VSP": 0.0, "Chargeback": 13.0, "Code": "DA+DD"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized/Laminated Lenses \u2013 Glass", "Notes": "nan", "Copay": 78.0, "VSP": 0.0, "Chargeback": 49.0, "Code": "DE"}, {"Category": "Sun/Polarized", "Enhancement": "Polarized/Laminated Lenses \u2013 Glass", "Notes": "nan", "Copay": 101.0, "VSP": 0.0, "Chargeback": 63.0, "Code": "DE"}, {"Category": "Bifocal/Occupational", "Enhancement": "Near Variable Focus \u2013 Plastic", "Notes": "nan", "Copay": 50.0, "VSP": 0.0, "Chargeback": 26.0, "Code": "IA"}, {"Category": "Bifocal/Occupational", "Enhancement": "Near Variable Focus \u2013 High-index Plastic 1.53\u20131.60/Trivex", "Notes": "Copay = 50+24 (MF)", "Copay": 74.0, "VSP": 0.0, "Chargeback": 11.0, "Code": "IA+IB"}, {"Category": "Bifocal/Occupational", "Enhancement": "Near Variable Focus \u2013 High-index Plastic 1.66/1.67", "Notes": "Copay = 50+50 (MF)", "Copay": 100.0, "VSP": 0.0, "Chargeback": 27.0, "Code": "IA+II"}, {"Category": "Bifocal/Occupational", "Enhancement": "Near Variable Focus \u2013 High-index Plastic 1.70 and Above", "Notes": "Copay = 50+60 (MF)", "Copay": 110.0, "VSP": 0.0, "Chargeback": 36.0, "Code": "IA+IJ"}, {"Category": "Bifocal/Occupational", "Enhancement": "Near Variable Focus \u2013 Polycarbonate", "Notes": "Copay = 50+20 (MF)", "Copay": 70.0, "VSP": 0.0, "Chargeback": 7.0, "Code": "IA+ID"}, {"Category": "Bifocal/Occupational", "Enhancement": "Blended Bifocal \u2013 Plastic", "Notes": "nan", "Copay": 30.0, "VSP": 0.0, "Chargeback": 14.0, "Code": "GA"}, {"Category": "Tint", "Enhancement": "Plastic Dyes \u2013 Solid Color (Except Pink I and II)", "Notes": "nan", "Copay": 15.0, "VSP": 0.0, "Chargeback": 5.0, "Code": "MN"}, {"Category": "Tint", "Enhancement": "Plastic Dyes \u2013 Solid Color (Except Pink I and II)", "Notes": "nan", "Copay": 15.0, "VSP": 0.0, "Chargeback": 5.0, "Code": "MN"}, {"Category": "Tint", "Enhancement": "Plastic Dyes \u2013 Gradient", "Notes": "nan", "Copay": 17.0, "VSP": 0.0, "Chargeback": 7.0, "Code": "MP"}, {"Category": "Tint", "Enhancement": "Plastic Dyes \u2013 Gradient", "Notes": "nan", "Copay": 17.0, "VSP": 0.0, "Chargeback": 7.0, "Code": "MP"}, {"Category": "Tint (Glass)", "Enhancement": "Glass Tints Solid (Except Pink I and II and Yellow)", "Notes": "nan", "Copay": 34.0, "VSP": 0.0, "Chargeback": 16.0, "Code": "MR"}, {"Category": "Tint (Glass)", "Enhancement": "Glass Tints Solid (Except Pink I and II and Yellow)", "Notes": "nan", "Copay": 44.0, "VSP": 0.0, "Chargeback": 24.0, "Code": "MR"}, {"Category": "Tint (Glass)", "Enhancement": "Glass Color Coatings \u2013 Solid", "Notes": "nan", "Copay": 42.0, "VSP": 0.0, "Chargeback": 22.0, "Code": "MS"}, {"Category": "Tint (Glass)", "Enhancement": "Glass Color Coatings \u2013 Solid", "Notes": "nan", "Copay": 42.0, "VSP": 0.0, "Chargeback": 22.0, "Code": "MS"}, {"Category": "Tint (Glass)", "Enhancement": "Glass Color Coatings \u2013 Gradient", "Notes": "nan", "Copay": 46.0, "VSP": 0.0, "Chargeback": 25.0, "Code": "MT"}, {"Category": "Tint (Glass)", "Enhancement": "Glass Color Coatings \u2013 Gradient", "Notes": "nan", "Copay": 46.0, "VSP": 0.0, "Chargeback": 25.0, "Code": "MT"}, {"Category": "Photochromic", "Enhancement": "Photochromics \u2013 Glass", "Notes": "nan", "Copay": 33.0, "VSP": 0.0, "Chargeback": 15.0, "Code": "PM"}, {"Category": "Photochromic", "Enhancement": "Photochromics \u2013 Glass", "Notes": "nan", "Copay": 41.0, "VSP": 0.0, "Chargeback": 23.0, "Code": "PM"}, {"Category": "Photochromic", "Enhancement": "Photochromics \u2013 Plastic", "Notes": "nan", "Copay": 75.0, "VSP": 0.0, "Chargeback": 45.0, "Code": "PR"}, {"Category": "Photochromic", "Enhancement": "Photochromics \u2013 Plastic", "Notes": "nan", "Copay": 75.0, "VSP": 0.0, "Chargeback": 45.0, "Code": "PR"}, {"Category": "Coating", "Enhancement": "Anti-reflective Coating A", "Notes": "nan", "Copay": 41.0, "VSP": 0.0, "Chargeback": 21.0, "Code": "QM"}, {"Category": "Coating", "Enhancement": "Anti-reflective Coating A", "Notes": "nan", "Copay": 41.0, "VSP": 0.0, "Chargeback": 21.0, "Code": "QM"}, {"Category": "Coating", "Enhancement": "Anti-reflective Coating C", "Notes": "nan", "Copay": 68.0, "VSP": 0.0, "Chargeback": 41.0, "Code": "QT"}, {"Category": "Coating", "Enhancement": "Anti-reflective Coating C", "Notes": "nan", "Copay": 68.0, "VSP": 0.0, "Chargeback": 41.0, "Code": "QT"}, {"Category": "Coating", "Enhancement": "Anti-reflective Coating D", "Notes": "nan", "Copay": 85.0, "VSP": 0.0, "Chargeback": 52.0, "Code": "QV"}, {"Category": "Coating", "Enhancement": "Anti-reflective Coating D", "Notes": "nan", "Copay": 85.0, "VSP": 0.0, "Chargeback": 52.0, "Code": "QV"}, {"Category": "Coating", "Enhancement": "Mirror \u2013 Solid and Single Gradient (Includes Base Color)", "Notes": "nan", "Copay": 49.0, "VSP": 0.0, "Chargeback": 26.0, "Code": "QP"}, {"Category": "Coating", "Enhancement": "Mirror \u2013 Solid and Single Gradient (Includes Base Color)", "Notes": "nan", "Copay": 49.0, "VSP": 0.0, "Chargeback": 26.0, "Code": "QP"}, {"Category": "Coating", "Enhancement": "Ski Type (Includes Base Tint and Backside Color)", "Notes": "nan", "Copay": 55.0, "VSP": 0.0, "Chargeback": 30.0, "Code": "QR"}, {"Category": "Coating", "Enhancement": "Ski Type (Includes Base Tint and Backside Color)", "Notes": "nan", "Copay": 55.0, "VSP": 0.0, "Chargeback": 30.0, "Code": "QR"}, {"Category": "Coating", "Enhancement": "Scratch-resistant Coating A \u2013 Factory Applied", "Notes": "nan", "Copay": 17.0, "VSP": 0.0, "Chargeback": 7.0, "Code": "QQ"}, {"Category": "Coating", "Enhancement": "Scratch-resistant Coating A \u2013 Factory Applied", "Notes": "nan", "Copay": 17.0, "VSP": 0.0, "Chargeback": 7.0, "Code": "QQ"}, {"Category": "Coating", "Enhancement": "Scratch-resistant Coating B \u2013 Other Approved Coatings", "Notes": "nan", "Copay": 33.0, "VSP": 0.0, "Chargeback": 15.0, "Code": "QS"}, {"Category": "Coating", "Enhancement": "Scratch-resistant Coating B \u2013 Other Approved Coatings", "Notes": "nan", "Copay": 33.0, "VSP": 0.0, "Chargeback": 15.0, "Code": "QS"}, {"Category": "Oversize", "Enhancement": "Frames Stamped 61mm Eye Size or Greater \u2013 Plastic", "Notes": "nan", "Copay": 11.0, "VSP": 0.0, "Chargeback": 5.0, "Code": "RM"}, {"Category": "Oversize", "Enhancement": "Frames Stamped 61mm Eye Size or Greater \u2013 Plastic", "Notes": "nan", "Copay": 14.0, "VSP": 0.0, "Chargeback": 6.0, "Code": "RM"}, {"Category": "Oversize", "Enhancement": "Frames Stamped 61mm Eye Size or Greater \u2013 Glass", "Notes": "nan", "Copay": 13.0, "VSP": 0.0, "Chargeback": 7.0, "Code": "RN"}, {"Category": "Oversize", "Enhancement": "Frames Stamped 61mm Eye Size or Greater \u2013 Glass", "Notes": "nan", "Copay": 18.0, "VSP": 0.0, "Chargeback": 10.0, "Code": "RN"}, {"Category": "Misc", "Enhancement": "High Luster Edge Polish", "Notes": "nan", "Copay": 16.0, "VSP": 0.0, "Chargeback": 6.0, "Code": "SP"}, {"Category": "Misc", "Enhancement": "High Luster Edge Polish", "Notes": "nan", "Copay": 16.0, "VSP": 0.0, "Chargeback": 6.0, "Code": "SP"}, {"Category": "Misc", "Enhancement": "Edge Coating", "Notes": "nan", "Copay": 36.0, "VSP": 0.0, "Chargeback": 17.0, "Code": "SQ"}, {"Category": "Misc", "Enhancement": "Edge Coating", "Notes": "nan", "Copay": 36.0, "VSP": 0.0, "Chargeback": 17.0, "Code": "SQ"}, {"Category": "Misc", "Enhancement": "Faceted Lenses (Includes Polishing)", "Notes": "nan", "Copay": 66.0, "VSP": 0.0, "Chargeback": 41.0, "Code": "SR"}, {"Category": "Misc", "Enhancement": "Faceted Lenses (Includes Polishing)", "Notes": "nan", "Copay": 66.0, "VSP": 0.0, "Chargeback": 41.0, "Code": "SR"}, {"Category": "Misc", "Enhancement": "Rimless Drill", "Notes": "nan", "Copay": 30.0, "VSP": 0.0, "Chargeback": 25.0, "Code": "SW"}, {"Category": "Misc", "Enhancement": "Rimless Drill", "Notes": "nan", "Copay": 30.0, "VSP": 0.0, "Chargeback": 25.0, "Code": "SW"}, {"Category": "Misc", "Enhancement": "UV Protection", "Notes": "nan", "Copay": 16.0, "VSP": 0.0, "Chargeback": 6.0, "Code": "SV"}, {"Category": "Misc", "Enhancement": "UV Protection", "Notes": "nan", "Copay": 16.0, "VSP": 0.0, "Chargeback": 6.0, "Code": "SV"}, {"Category": "Misc", "Enhancement": "UV Protection \u2013 Backside", "Notes": "nan", "Copay": 10.0, "VSP": 0.0, "Chargeback": 7.0, "Code": "BV"}, {"Category": "Misc", "Enhancement": "UV Protection \u2013 Backside", "Notes": "nan", "Copay": 10.0, "VSP": 0.0, "Chargeback": 7.0, "Code": "BV"}, {"Category": "Misc", "Enhancement": "Light Filter", "Notes": "nan", "Copay": 15.0, "VSP": 0.0, "Chargeback": 11.0, "Code": "LF"}, {"Category": "Misc", "Enhancement": "Light Filter", "Notes": "nan", "Copay": 15.0, "VSP": 0.0, "Chargeback": 11.0, "Code": "LF"}, {"Category": "Misc", "Enhancement": "Technical Add-On", "Notes": "nan", "Copay": 10.0, "VSP": 0.0, "Chargeback": 8.0, "Code": "TA"}, {"Category": "Doctor Supplied", "Enhancement": "Plastic Dyes \u2013 Solid Color (Pink I and II)", "Notes": "nan", "Copay": 0.0, "VSP": 0.0, "Chargeback": 5.0, "Code": "IM"}, {"Category": "Doctor Supplied", "Enhancement": "Plastic Dyes \u2013 Solid Color (Pink I and II)", "Notes": "nan", "Copay": 0.0, "VSP": 0.0, "Chargeback": 5.0, "Code": "IM"}, {"Category": "Doctor Supplied", "Enhancement": "Plastic Dyes \u2013 Solid Color (Except Pink I and II)", "Notes": "nan", "Copay": 15.0, "VSP": 0.0, "Chargeback": 5.0, "Code": "IN"}, {"Category": "Doctor Supplied", "Enhancement": "Plastic Dyes \u2013 Solid Color (Except Pink I and II)", "Notes": "nan", "Copay": 15.0, "VSP": 0.0, "Chargeback": 5.0, "Code": "IN"}, {"Category": "Doctor Supplied", "Enhancement": "Plastic Dyes \u2013 Gradient", "Notes": "nan", "Copay": 17.0, "VSP": 0.0, "Chargeback": 7.0, "Code": "IP"}, {"Category": "Doctor Supplied", "Enhancement": "Plastic Dyes \u2013 Gradient", "Notes": "nan", "Copay": 17.0, "VSP": 0.0, "Chargeback": 7.0, "Code": "IP"}, {"Category": "Doctor Supplied", "Enhancement": "UV Protection", "Notes": "nan", "Copay": 16.0, "VSP": 0.0, "Chargeback": 6.0, "Code": "IV"}, {"Category": "Doctor Supplied", "Enhancement": "UV Protection", "Notes": "nan", "Copay": 16.0, "VSP": 0.0, "Chargeback": 6.0, "Code": "IV"}, {"Category": "Progressive", "Enhancement": "Custom Measurements (on Eligible Progressive N or O) Lenses", "Notes": "nan", "Copay": 10.0, "VSP": 0.0, "Chargeback": 2.0, "Code": "CM"}, {"Category": "Progressive", "Enhancement": "Progressive N \u2013 Plastic", "Notes": "nan", "Copay": 175.0, "VSP": 0.0, "Chargeback": 95.0, "Code": "nan"}, {"Category": "Progressive", "Enhancement": "Progressive N \u2013 High-index Plastic 1.53\u20131.60/Trivex", "Notes": "Copay = 175+47", "Copay": 222.0, "VSP": 0.0, "Chargeback": 25.0, "Code": "NA+NB"}, {"Category": "Progressive", "Enhancement": "Progressive N \u2013 High-index Plastic 1.66/1.67", "Notes": "Copay = 175+78", "Copay": 253.0, "VSP": 0.0, "Chargeback": 48.0, "Code": "NA+NH"}, {"Category": "Progressive", "Enhancement": "Progressive N \u2013 High-index Plastic 1.70 and Above", "Notes": "Copay = 175+125", "Copay": 300.0, "VSP": 0.0, "Chargeback": 77.0, "Code": "NA+NJ"}, {"Category": "Progressive", "Enhancement": "Progressive N \u2013 Polycarbonate", "Notes": "Copay = 175+35", "Copay": 210.0, "VSP": 0.0, "Chargeback": 15.0, "Code": "NA+ND"}, {"Category": "Progressive", "Enhancement": "Progressive N \u2013 Polarized", "Notes": "Copay = 175+82", "Copay": 257.0, "VSP": 0.0, "Chargeback": 51.0, "Code": "NA+NP"}, {"Category": "Progressive", "Enhancement": "Progressive O \u2013 Plastic", "Notes": "nan", "Copay": 150.0, "VSP": 0.0, "Chargeback": 79.0, "Code": "OA"}, {"Category": "Progressive", "Enhancement": "Progressive O \u2013 High-index Plastic 1.53\u20131.60/Trivex", "Notes": "Copay = 150+47", "Copay": 197.0, "VSP": 0.0, "Chargeback": 25.0, "Code": "OA+OB"}, {"Category": "Progressive", "Enhancement": "Progressive O \u2013 High-index Plastic 1.66/1.67", "Notes": "Copay = 150+78", "Copay": 228.0, "VSP": 0.0, "Chargeback": 48.0, "Code": "OA+OH"}, {"Category": "Progressive", "Enhancement": "Progressive O \u2013 High-index Plastic 1.70 and Above", "Notes": "Copay = 150+125", "Copay": 275.0, "VSP": 0.0, "Chargeback": 77.0, "Code": "OA+OJ"}, {"Category": "Progressive", "Enhancement": "Progressive O \u2013 Polycarbonate", "Notes": "Copay = 150+35", "Copay": 185.0, "VSP": 0.0, "Chargeback": 15.0, "Code": "OA+OD"}, {"Category": "Progressive", "Enhancement": "Progressive O \u2013 Polarized", "Notes": "Copay = 150+82", "Copay": 232.0, "VSP": 0.0, "Chargeback": 51.0, "Code": "OA+OP"}, {"Category": "Progressive", "Enhancement": "Progressive F \u2013 Plastic", "Notes": "nan", "Copay": 105.0, "VSP": 0.0, "Chargeback": 54.0, "Code": "FA"}, {"Category": "Progressive", "Enhancement": "Progressive F \u2013 High-index Plastic 1.53\u20131.60/Trivex", "Notes": "Copay = 105+47", "Copay": 152.0, "VSP": 0.0, "Chargeback": 25.0, "Code": "FA+FB"}, {"Category": "Progressive", "Enhancement": "Progressive F \u2013 High-index Plastic 1.66/1.67", "Notes": "Copay = 105+78", "Copay": 183.0, "VSP": 0.0, "Chargeback": 48.0, "Code": "FA+FH"}, {"Category": "Progressive", "Enhancement": "Progressive F \u2013 High-index Plastic 1.70 and Above", "Notes": "Copay = 105+125", "Copay": 230.0, "VSP": 0.0, "Chargeback": 77.0, "Code": "FA+FJ"}, {"Category": "Progressive", "Enhancement": "Progressive F \u2013 Polycarbonate", "Notes": "Copay = 105+35", "Copay": 140.0, "VSP": 0.0, "Chargeback": 15.0, "Code": "FA+FD"}, {"Category": "Progressive", "Enhancement": "Progressive F \u2013 Polarized", "Notes": "Copay = 105+82", "Copay": 187.0, "VSP": 0.0, "Chargeback": 51.0, "Code": "FA+FP"}, {"Category": "Progressive", "Enhancement": "Progressive F \u2013 Glass/High-index Glass (Clear)", "Notes": "nan", "Copay": 110.0, "VSP": 0.0, "Chargeback": 59.0, "Code": "FE"}, {"Category": "Progressive", "Enhancement": "Progressive J \u2013 Plastic", "Notes": "nan", "Copay": 95.0, "VSP": 0.0, "Chargeback": 46.0, "Code": "JA"}, {"Category": "Progressive", "Enhancement": "Progressive J \u2013 High-index Plastic 1.53\u20131.60/Trivex", "Notes": "Copay = 95+47", "Copay": 142.0, "VSP": 0.0, "Chargeback": 25.0, "Code": "JA+JB"}, {"Category": "Progressive", "Enhancement": "Progressive J \u2013 High-index Plastic 1.66/1.67", "Notes": "Copay = 95+78", "Copay": 173.0, "VSP": 0.0, "Chargeback": 48.0, "Code": "JA+JH"}, {"Category": "Progressive", "Enhancement": "Progressive J \u2013 High-index Plastic 1.70 and Above", "Notes": "Copay = 95+125", "Copay": 220.0, "VSP": 0.0, "Chargeback": 77.0, "Code": "JA+JJ"}, {"Category": "Progressive", "Enhancement": "Progressive J \u2013 Polycarbonate", "Notes": "Copay = 95+35", "Copay": 130.0, "VSP": 0.0, "Chargeback": 15.0, "Code": "JA+JD"}, {"Category": "Progressive", "Enhancement": "Progressive J \u2013 Polarized", "Notes": "Copay = 95+82", "Copay": 177.0, "VSP": 0.0, "Chargeback": 51.0, "Code": "JA+JP"}, {"Category": "Progressive", "Enhancement": "Progressive J \u2013 Glass/High-index Glass (Clear)", "Notes": "nan", "Copay": 105.0, "VSP": 0.0, "Chargeback": 56.0, "Code": "JE"}, {"Category": "Progressive", "Enhancement": "Progressive K \u2013 Plastic", "Notes": "nan", "Copay": 55.0, "VSP": 0.0, "Chargeback": 28.0, "Code": "KA"}, {"Category": "Progressive", "Enhancement": "Progressive K \u2013 High-index Plastic 1.53\u20131.60/Trivex", "Notes": "Copay = 55+47", "Copay": 102.0, "VSP": 0.0, "Chargeback": 25.0, "Code": "KA+KB"}, {"Category": "Progressive", "Enhancement": "Progressive K \u2013 High-index Plastic 1.66/1.67", "Notes": "Copay = 55+78", "Copay": 133.0, "VSP": 0.0, "Chargeback": 48.0, "Code": "KA+KH"}, {"Category": "Progressive", "Enhancement": "Progressive K \u2013 High-index Plastic 1.70 and Above", "Notes": "Copay = 55+125", "Copay": 180.0, "VSP": 0.0, "Chargeback": 77.0, "Code": "KA+KJ"}, {"Category": "Progressive", "Enhancement": "Progressive K \u2013 Polycarbonate", "Notes": "Copay = 55+35", "Copay": 90.0, "VSP": 0.0, "Chargeback": 15.0, "Code": "KA+KD"}, {"Category": "Progressive", "Enhancement": "Progressive K \u2013 Polarized", "Notes": "Copay = 55+82", "Copay": 137.0, "VSP": 0.0, "Chargeback": 51.0, "Code": "KA+KP"}, {"Category": "Progressive", "Enhancement": "Progressive K \u2013 Glass/High-index Glass (Clear)", "Notes": "nan", "Copay": 80.0, "VSP": 0.0, "Chargeback": 53.0, "Code": "KE"}];

function num(n){ n = Number(n||0); return n.toLocaleString('en-US',{style:'currency',currency:'USD'}); }
function renderMaster(){
  const tb = document.querySelector("#masterTable tbody"); tb.innerHTML="";
  window.__MASTER__.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.Category||""}</td><td>${r.Enhancement||""}</td><td>${r.Code||""}</td><td>${r.Notes||""}</td>
    <td style="text-align:right">${num(r.Copay)}</td><td style="text-align:right">${num(r.VSP)}</td><td style="text-align:right">${num(r.Chargeback||0)}</td>`;
    tb.appendChild(tr);
  });
}
renderMaster();

function find(cat,name){ return window.__MASTER__.find(r=>r.Category===cat && r.Enhancement===name); }
function dedupe(items){ const seen=new Set(); return items.filter(i=>{const k=i.Category+'|'+i.Enhancement; if(seen.has(k)) return false; seen.add(k); return true;}); }
function replaceCategory(items,cat,newItem){ return dedupe([newItem, ...items.filter(i=>i.Category!==cat)]); }

function pickBase(track, sun){
  let items = [];
  if(track==='SV'){ items.push(find('Material','Polycarbonate') || window.__MASTER__.find(r=>r.Category==='Material')); }
  else if(track==='Progressive'){ items.push(find('Material','High Index 1.60') || find('Material','Polycarbonate')); items.push(find('Progressive','Premium Progressive') || find('Progressive','Standard Progressive')); }
  else { items.push(find('Material','Polycarbonate')); }
  if(sun==='Photochromic') items.push(window.__MASTER__.find(r=>/photo/i.test(r.Enhancement||'')));
  if(sun==='Polarized') items.push(window.__MASTER__.find(r=>/polar/i.test(r.Enhancement||'')));
  if(sun==='Tint') items.push(window.__MASTER__.find(r=>/tint/i.test(r.Enhancement||'')));
  items.push(find('Coating','Premium AR') || find('Coating','Standard AR') || window.__MASTER__.find(r=>r.Category==='Coating'));
  return dedupe(items.filter(Boolean));
}
function pickTier(track,sun,level){
  let items = pickBase(track,sun);
  if(level==='BEST'){
    const hi = find('Material','High Index 1.67') || find('Material','High Index 1.60');
    if(hi) items = replaceCategory(items,'Material',hi);
    const ultra = find('Coating','Elite/Ultra AR') || find('Coating','Premium AR'); if(ultra) items = replaceCategory(items,'Coating',ultra);
    if(track==='Progressive'){ const prem = find('Progressive','Premium Progressive'); if(prem) items = replaceCategory(items,'Progressive',prem); }
  }
  if(level==='BASIC'){
    const cr = find('Material','CR-39 (Standard Plastic)') || find('Material','Polycarbonate');
    if(cr) items = replaceCategory(items,'Material',cr);
    const std = find('Coating','Standard AR'); if(std) items = replaceCategory(items,'Coating',std);
    if(track==='Progressive'){ const stdp = find('Progressive','Standard Progressive'); if(stdp) items = replaceCategory(items,'Progressive',stdp); }
  }
  return dedupe(items.filter(Boolean));
}
function totals(items){ const copay=items.reduce((s,r)=>s+Number(r.Copay||0),0); const vsp=items.reduce((s,r)=>s+Number(r.VSP||0),0); const cb=items.reduce((s,r)=>s+Number(r.Chargeback||0),0); return {copay,vsp,cb,revenue:copay+vsp-cb}; }

document.getElementById('btnBuild').addEventListener('click', ()=>{
  const track = document.getElementById('track').value;
  const sun = document.getElementById('sun').value;
  const over = document.getElementById('oversize').value;
  const rim = document.getElementById('rimless').value;

  const tiers = [
    {name:'BEST', items: pickTier(track,sun,'BEST')},
    {name:'MID', items: pickTier(track,sun,'MID')},
    {name:'BASIC', items: pickTier(track,sun,'BASIC')},
  ];
  if(over!=='None'){ const os = window.__MASTER__.find(r=>/oversize/i.test(r.Enhancement||'') || r.Category==='Misc' && /oversize/i.test(r.Enhancement||'')); if(os) tiers.forEach(t=>t.items.push(os)); }
  if(rim==='Drill'){ const rl = window.__MASTER__.find(r=>/rimless/i.test(r.Enhancement||'') || /drill/i.test(r.Enhancement||'')); if(rl) tiers.forEach(t=>t.items.push(rl)); }

  document.getElementById('tiersSection').style.display='block';
  const tb = document.querySelector('#tierTable tbody'); tb.innerHTML='';
  const kpis = document.getElementById('kpis'); kpis.innerHTML='';
  tiers.forEach(t=>{
    const ttot = totals(t.items);
    const itemsList = t.items.map(i=>i.Enhancement).join(', ');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><b>${t.name}</b></td>
      <td>${itemsList}</td>
      <td style='text-align:right'>${num(ttot.copay)}</td>
      <td style='text-align:right'>${num(ttot.vsp)}</td>
      <td style='text-align:right'>${num(ttot.cb)}</td>
      <td style='text-align:right'><b>${num(ttot.revenue)}</b></td>`;
    tb.appendChild(tr);

    const div = document.createElement('div');
    div.className='kpi';
    div.innerHTML = `<div><small>${t.name} revenue</small></div><b>${num(ttot.revenue)}</b>`;
    kpis.appendChild(div);
  });
});

document.getElementById('btnCSV').addEventListener('click', ()=>{
  const rows=[["Tier","Category","Enhancement","Code","Copay","VSP","Chargeback"]];
  const track = document.getElementById('track').value;
  const sun = document.getElementById('sun').value;
  const tiers = [
    {name:'BEST', items: pickTier(track,sun,'BEST')},
    {name:'MID', items: pickTier(track,sun,'MID')},
    {name:'BASIC', items: pickTier(track,sun,'BASIC')},
  ];
  tiers.forEach(t=> t.items.forEach(i=> rows.push([t.name,i.Category||"",i.Enhancement||"",i.Code||"",i.Copay||0,i.VSP||0,i.Chargeback||0])) );
  const csv = rows.map(r=>r.map(x=>`"${(x??"").toString().replace(/"/g,'""')}"`).join(",")).join("\n");
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = 'revopt_quote.csv'; a.click();
});
</script>
</body>
</html>
