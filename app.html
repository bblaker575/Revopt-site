<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Revopt — Profit-First Choice Configurator (v7 CSV)</title>
  <style>
    :root{--bg:#0B1020;--card:#12162A;--ink:#E6E9F5;--muted:#9CA3AF;--line:#1E2450;--line2:#242947;--btn:#0E1530;--primary:#4F46E5;}
    html,body{margin:0;height:100%}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0 0 12px 0}
    .card{background:var(--card);border:1px solid var(--line2);border-radius:14px;padding:14px;margin:10px 0}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    label{display:inline-flex;gap:8px;align-items:center}
    select,button{background:var(--btn);border:1px solid var(--line2);border-radius:10px;color:var(--ink);padding:8px 10px}
    button.primary{background:var(--primary);border:none;font-weight:700;color:var(--bg)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px;font-size:14px;text-align:left;vertical-align:top}
    th{color:#C7CBF5}
    small{color:var(--muted)}
    .kpi{display:inline-block;margin-right:12px;background:var(--btn);border:1px solid var(--line);border-radius:12px;padding:8px 10px}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px}
    .items-cell{max-width:800px}
    .warn{color:#ffd966}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Revopt — Profit-First Choice Configurator</h1>

    <div class="card">
      <small>Data-driven: loads <code>vsp_choice_master_v7_full_fixed.csv</code>. AR is always included. “Custom Measurement” rows are hidden. Tiers: BEST = highest profit, BASIC = lowest copay, MID = next-best profit.</small>
      <div id="csvStatus" class="warn" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <div class="row">
        <label>Track
          <select id="track">
            <option value="SV">SV</option>
            <option value="MF">Progressive (MF)</option>
            <option value="OCC">Occupational</option>
          </select>
        </label>

        <label>Sun
          <select id="sun">
            <option value="Clear">Clear</option>
            <option value="SolidTint">Tint – Solid</option>
            <option value="GradientTint">Tint – Gradient</option>
            <option value="Mirror">Mirror</option>
            <option value="Photochromic">Photochromic</option>
            <option value="Polarized">Polarized</option>
          </select>
        </label>

        <label>Oversize
          <select id="over">
            <option>None</option>
            <option>80% of U&C</option>
          </select>
        </label>

        <label>Rimless
          <select id="rim">
            <option>None</option>
            <option>Drill</option>
            <option>Groove</option>
          </select>
        </label>

        <button class="primary" id="build">Build tiers</button>
        <button id="csv">Download Quote CSV</button>
      </div>
    </div>

    <div class="card" id="tiers" style="display:none">
      <div id="kpis" class="badges"></div>
      <table>
        <thead>
          <tr>
            <th>Tier</th>
            <th>Items</th>
            <th style="text-align:right">Copay</th>
            <th style="text-align:right">VSP</th>
            <th style="text-align:right">Chargeback</th>
            <th style="text-align:right">Revenue</th>
          </tr>
        </thead>
        <tbody id="tierbody"></tbody>
      </table>
    </div>

    <div class="card">
      <details>
        <summary>Master rows (from CSV)</summary>
        <table>
          <thead>
            <tr>
              <th>Group</th><th>Subtype</th><th>Enhancement</th><th>Code</th><th>Notes</th>
              <th style="text-align:right">Copay</th>
              <th style="text-align:right">VSP</th>
              <th style="text-align:right">Chargeback</th>
              <th>Exclusive</th><th>Applies</th>
            </tr>
          </thead>
          <tbody id="master"></tbody>
        </table>
      </details>
    </div>
  </div>

  <script>
    /* ======= CONFIG ======= */
    const DATA_CSV = "./vsp_choice_master_v7_full_fixed.csv";

    /* ======= Ignore business rules (temporary) ======= */
    const SHOULD_IGNORE = (row) => {
      const txt = `${row.enhancement||""} ${row.notes||""}`.toLowerCase();
      if (txt.includes("custom measurement")) return true;
      return false;
    };

    /* ======= CSV loader ======= */
    async function loadCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("CSV not found");
      const text = await res.text();
      return parseCSV(text);
    }
    function parseCSV(text){
      const rows=[]; const lines=text.replace(/\r/g,"").split("\n").filter(x=>x.trim().length);
      const headers = splitCSVLine(lines[0]);
      for (let i=1;i<lines.length;i++){
        const cells = splitCSVLine(lines[i]);
        const row = {};
        headers.forEach((h,idx)=> row[h] = cells[idx] ?? "");
        rows.push(row);
      }
      return rows;
    }
    function splitCSVLine(line){
      const out=[]; let cur=""; let inQ=false;
      for (let i=0;i<line.length;i++){
        const ch=line[i];
        if (inQ){
          if (ch==='"' && line[i+1]==='"'){ cur+='"'; i++; }
          else if (ch === '"'){ inQ=false; }
          else cur+=ch;
        } else {
          if (ch === ','){ out.push(cur); cur=""; }
          else if (ch === '"'){ inQ=true; }
          else cur+=ch;
        }
      }
      out.push(cur);
      return out;
    }
    const money = (n)=> Number(n||0).toLocaleString("en-US",{style:"currency",currency:"USD"});

    /* ======= Global ======= */
    let MASTER = [];

    function renderMasterTable(){
      const tb = document.getElementById("master");
      tb.innerHTML = "";
      MASTER.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.group||""}</td>
          <td>${r.subtype||""}</td>
          <td>${r.enhancement||""}</td>
          <td>${r.code||""}</td>
          <td>${r.notes||""}</td>
          <td style="text-align:right">${money(r.copay)}</td>
          <td style="text-align:right">${money(r.vsp)}</td>
          <td style="text-align:right">${money(r.chargeback)}</td>
          <td>${r.exclusive_key||""}</td>
          <td>${(r.applies_to_tokens||[]).join(", ")}</td>`;
        tb.appendChild(tr);
      });
    }

    /* ======= Helpers ======= */
    const sum = (arr,k) => arr.reduce((s,r)=> s + Number(r[k]||0), 0);
    const totals = (items)=> {
      const copay = sum(items,"copay"), vsp = sum(items,"vsp"), cb = sum(items,"chargeback");
      return { copay, vsp, cb, revenue: copay + vsp - cb };
    };
    const appliesTo = (row, track) => {
      if (!row || !row.applies_to_tokens) return true;
      const T = track.toUpperCase();
      return row.applies_to_tokens.includes("ALL") || row.applies_to_tokens.includes(T);
    };
    const enforceExclusive = (items)=>{
      const seen = new Set();
      return items.filter(r=>{
        const key = (r.exclusive_key||"").trim();
        if (!key) return true;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    };

    /* ======= AR selection (always included) ======= */
    function pickARForTier(level){
      const ars = MASTER.filter(r=> r.group === "AR");
      if (!ars.length) return null;
      const sorted = [...ars].sort((a,b)=> b.copay - a.copay);
      if (level==="BEST")  return sorted[0];
      if (level==="BASIC") return sorted[sorted.length-1];
      return sorted[Math.max(0, Math.floor(sorted.length/2)-1)];
    }

    /* ======= Base candidates per track ======= */
    function candidatesForTrack(track){
      let cands = [];
      if (track==="MF")       cands = MASTER.filter(r=> r.group==="PROGRESSIVE"  && appliesTo(r,"MF"));
      else if (track==="OCC") cands = MASTER.filter(r=> r.group==="OCCUPATIONAL" && appliesTo(r,"OCC"));
      else                    cands = MASTER.filter(r=> r.group==="MATERIAL"     && appliesTo(r,"SV"));
      if (cands.length === 0) {
        if (track==="MF")  cands = MASTER.filter(r=> r.group==="PROGRESSIVE");
        if (track==="OCC") cands = MASTER.filter(r=> r.group==="OCCUPATIONAL");
        if (track==="SV")  cands = MASTER.filter(r=> r.group==="MATERIAL");
      }
      return cands.filter(r => !SHOULD_IGNORE(r));
    }

    /* ======= Shared add-ons (sun/oversize/rimless) ======= */
    function pickSunRow(subtype){
      if (!subtype || subtype==="Clear") return null;
      return MASTER.find(r=> r.group==="SUN" && (r.subtype||"")===subtype) || null;
    }
    function pickOversizeRow(overSel){
      if (overSel==="80% of U&C") return MASTER.find(r=> r.group==="OVERSIZE") || null;
      return null;
    }
    function pickRimlessRow(rimSel){
      if (rimSel==="Drill")  return MASTER.find(r=> r.group==="RIMLESS" && /drill/i.test(r.subtype||"")) || null;
      if (rimSel==="Groove") return MASTER.find(r=> r.group==="RIMLESS" && /groove/i.test(r.subtype||"")) || null;
      return null;
    }

    /* ======= Bundles ======= */
    function buildBundle(base, ar, sharedAddons){
      const items = [base].concat(ar ? [ar] : []).concat(sharedAddons.filter(Boolean));
      return enforceExclusive(items);
    }
    function bundleStats(base, ar, sharedAddons){
      const items = buildBundle(base, ar, sharedAddons);
      return { items, ...totals(items) };
    }
    function bundleKey(stats){
      // Use base enhancement+code to identify uniqueness among choices
      const b = stats.items.find(x=> x.group==="MATERIAL" || x.group==="PROGRESSIVE" || x.group==="OCCUPATIONAL") || {};
      return `${b.group||""}|${b.subtype||""}|${b.enhancement||""}|${b.code||""}`;
    }

    /* ======= Profit-first tiering ======= */
    function buildProfitTiers(track, sunSel, overSel, rimSel){
      const bases = candidatesForTrack(track);
      const shared = [
        pickSunRow(sunSel),
        pickOversizeRow(overSel),
        pickRimlessRow(rimSel)
      ].filter(Boolean);

      const arBest  = pickARForTier("BEST");
      const arMid   = pickARForTier("MID");
      const arBasic = pickARForTier("BASIC");

      if (bases.length === 0){
        return [
          { name:"BEST", items:[], copay:0, vsp:0, cb:0, revenue:0 },
          { name:"MID",  items:[], copay:0, vsp:0, cb:0, revenue:0 },
          { name:"BASIC",items:[], copay:0, vsp:0, cb:0, revenue:0 }
        ];
      }

      // Stats for each tier's AR selection
      const bestStats  = bases.map(b => ({ base:b, tier:"BEST",  ...bundleStats(b, arBest,  shared) }));
      const midStats   = bases.map(b => ({ base:b, tier:"MID",   ...bundleStats(b, arMid,   shared) }));
      const basicStats = bases.map(b => ({ base:b, tier:"BASIC", ...bundleStats(b, arBasic, shared) }));

      // BEST = highest profit
      bestStats.sort((a,b)=> b.revenue - a.revenue);
      const best = bestStats[0];
      const bestKey = bundleKey(best);

      // BASIC = lowest copay
      basicStats.sort((a,b)=> a.copay - b.copay);
      let basic = basicStats[0];
      // ensure BASIC isn't identical base as BEST (rare but possible if min copay==max profit)
      if (bundleKey(basic) === bestKey && basicStats.length > 1) basic = basicStats[1];
      const basicKey = bundleKey(basic);

      // MID = next-best profit (not the same as BEST or BASIC)
      midStats.sort((a,b)=> b.revenue - a.revenue);
      let mid = null;
      for (const m of midStats){
        const k = bundleKey(m);
        if (k !== bestKey && k !== basicKey){ mid = m; break; }
      }
      // fallback if everything collided
      if (!mid) mid = midStats[0];

      return [
        { name:"BEST",  items:best.items,  ...totals(best.items)  },
        { name:"MID",   items:mid.items,   ...totals(mid.items)   },
        { name:"BASIC", items:basic.items, ...totals(basic.items) }
      ];
    }

    /* ======= Render ======= */
    function renderTiers(tiers){
      document.getElementById("tiers").style.display = "block";
      const tb = document.getElementById("tierbody"); tb.innerHTML = "";
      const k = document.getElementById("kpis"); k.innerHTML = "";
      tiers.forEach(tt=>{
        const list = tt.items.map(i=> i.enhancement).join(", ");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${tt.name}</b></td>
          <td class="items-cell">${list}</td>
          <td style="text-align:right">${money(tt.copay)}</td>
          <td style="text-align:right">${money(tt.vsp)}</td>
          <td style="text-align:right">${money(tt.cb)}</td>
          <td style="text-align:right"><b>${money(tt.revenue)}</b></td>`;
        tb.appendChild(tr);

        const badge = document.createElement("span");
        badge.className = "kpi";
        badge.innerHTML = `<small>${tt.name} revenue</small> <b>${money(tt.revenue)}</b>`;
        k.appendChild(badge);
      });
    }

    /* ======= CSV export ======= */
    function exportQuoteCSV(tiers){
      const rows = [["Tier","Group","Subtype","Enhancement","Code","Copay","VSP","Chargeback"]];
      tiers.forEach(tt=>{
        tt.items.forEach(i=>{
          rows.push([tt.name, i.group||"", i.subtype||"", i.enhancement||"", i.code||"", i.copay||0, i.vsp||0, i.chargeback||0]);
        });
      });
      const csv = rows.map(r=> r.map(x=> `"${String(x??"").replace(/"/g,'""')}"`).join(",")).join("\n");
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
      a.download = "revopt_quote.csv";
      a.click();
    }

    /* ======= Events ======= */
    document.getElementById("build").addEventListener("click", ()=>{
      const track = document.getElementById("track").value;
      const sun   = document.getElementById("sun").value;
      const over  = document.getElementById("over").value;
      const rim   = document.getElementById("rim").value;

      const tiers = buildProfitTiers(track, sun, over, rim);
      renderTiers(tiers);
    });

    document.getElementById("csv").addEventListener("click", ()=>{
      const track = document.getElementById("track").value;
      const sun   = document.getElementById("sun").value;
      const over  = document.getElementById("over").value;
      const rim   = document.getElementById("rim").value;
      const tiers = buildProfitTiers(track, sun, over, rim);
      exportQuoteCSV(tiers);
    });

    /* ======= Boot ======= */
    (async function boot(){
      const status = document.getElementById("csvStatus");
      try{
        const rows = await loadCSV(DATA_CSV);
        const norm = (s)=> (s==null ? "" : String(s).trim());
        const up   = (s)=> norm(s).toUpperCase();

        MASTER = rows.map(r=>{
          const atokens = up(r.applies_to || "ALL").split(/[, ]+/).filter(Boolean);
          if (atokens.length === 0) atokens.push("ALL");
          return {
            ...r,
            group: up(r.group),
            subtype: norm(r.subtype),
            enhancement: norm(r.enhancement),
            code: norm(r.code),
            notes: norm(r.notes),
            exclusive_key: norm(r.exclusive_key).toLowerCase(),
            applies_to_tokens: atokens,
            copay: Number(norm(r.copay).replace(/[^0-9.\-]/g,"")) || 0,
            vsp: Number(norm(r.vsp).replace(/[^0-9.\-]/g,"")) || 0,
            chargeback: Number(norm(r.chargeback).replace(/[^0-9.\-]/g,"")) || 0
          };
        }).filter(r => !SHOULD_IGNORE(r));

        status.textContent = `Loaded ${DATA_CSV}.`;
      }catch(e){
        status.textContent = `Could not find ${DATA_CSV}. Upload it next to app.html.`;
        MASTER = [];
      }
      renderMasterTable();
    })();
  </script>
</body>
</html>
