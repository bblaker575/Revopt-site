<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RevSight AI — VSP Choice Profit Engine</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#121822; --border:#2a3444; --text:#e7eefc; --muted:#9fb3d2; --good:#1fbf75; --mid:#f6c343; --best:#9867ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui}
    header{padding:18px 16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .sub{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
    label{display:flex;align-items:center;gap:8px;margin:8px 0;font-size:14px;color:var(--muted)}
    input[type="checkbox"]{width:18px;height:18px}
    select,button{background:#0f1520;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font:inherit}
    button{cursor:pointer}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .bundle{border-left:4px solid var(--border);padding-left:10px;margin:6px 0}
    .bundle.good{border-color:var(--good)} .bundle.mid{border-color:var(--mid)} .bundle.best{border-color:var(--best)}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid var(--border)} th{color:var(--muted);font-weight:600;text-align:left}
    .right{text-align:right}
    .tag{display:inline-block;padding:2px 6px;border-radius:6px;background:#0e1622;border:1px solid var(--border);font-size:12px;margin-right:6px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>RevSight AI — VSP Choice Profit Engine</h1>
      <div class="sub">
        Profit = <b>sum of VSP service fees</b>. SV, Lined, and MF flows separated. Treatments (Polarized / Tinted / Transitions) are explicit, never treated as materials.
      </div>
    </div>
    <div class="row" style="align-items:center">
      <span class="pill" id="csvStatus">CSV: not loaded</span>
      <button id="forceRefresh">Recalc</button>
    </div>
  </header>

  <main class="row" style="padding:16px">
    <section class="col card">
      <h3 style="margin-top:0">Inputs</h3>
      <div class="row">
        <div class="col">
          <label>Lens type
            <select id="lensType">
              <option value="SV">Single Vision (SV)</option>
              <option value="LINED">Lined Bi/Tri (Bifocal)</option>
              <option value="MF">Progressive / Multifocal (MF)</option>
            </select>
          </label>
        </div>
        <div class="col">
          <label>Material preference
            <select id="materialPref">
              <option value="">No preference</option>
              <option value="PLASTIC">Plastic</option>
              <option value="POLYCARBONATE">Polycarbonate</option>
              <option value="HI67">Hi-Index 1.67</option>
              <option value="HI70">Hi-Index 1.70</option>
              <option value="TRIVEX">Trivex</option>
              <option value="GLASS">Glass</option>
            </select>
          </label>
        </div>
        <div class="col">
          <label>Lens treatment (exclusive)
            <select id="treatment">
              <option value="CLEAR">Clear</option>
              <option value="POLARIZED">Polarized</option>
              <option value="TINTED">Tinted</option>
              <option value="TRANSITIONS">Transitions / Photochromic</option>
            </select>
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <div class="col">
          <div class="sub" style="margin-bottom:6px">Global Toggles</div>
          <label><input id="toggleOversize" type="checkbox"> Oversize</label>
          <label><input id="toggleAR" type="checkbox" checked> AR Coating</label>
          <label><input id="toggleAspheric" type="checkbox"> Aspheric</label>
          <label><input id="toggleGlass" type="checkbox"> Glass</label>
        </div>
      </div>
    </section>

    <section class="col card">
      <h3 style="margin-top:0">Recommended Bundles (by profit)</h3>
      <div id="bundles"></div>
    </section>

    <section class="col card">
      <h3 style="margin-top:0">Line-item Economics</h3>
      <div id="lineItems"></div>
    </section>
  </main>

  <section class="card" style="margin:16px">
    <details open>
      <summary>Data/Diagnostics</summary>
      <div id="diag" class="muted" style="white-space:pre-wrap"></div>
    </details>
  </section>

<script>
/* ========================= CSV loader ========================= */
const CSV_URL = 'https://bblaker575.github.io/Revopt-site/vsp_choice_master_v7_full_fixed.csv';
async function loadCSV(){
  const badge = document.getElementById('csvStatus');
  try{
    const resp = await fetch(CSV_URL + '?t=' + Date.now(), {cache:'no-store'});
    if(!resp.ok) throw new Error(resp.status + ': ' + resp.statusText);
    const text = await resp.text();
    const rows = parseCSV(text);
    badge.textContent = 'CSV: loaded from GitHub Pages';
    badge.style.borderColor = '#6cf';
    return rows;
  }catch(e){
    badge.textContent = 'CSV: not loaded';
    badge.style.borderColor = '#f66';
    document.getElementById('diag').textContent = 'Error loading CSV: ' + (e.message||e);
    return [];
  }
}

/* ========================= Helpers ========================= */
function parseCSV(text){ /* same as before, omitted for brevity */ }

/* Classification, bundling, rendering — same as previous version you tested,
   with SV / LINED / MF separation and treatment dropdown already integrated. */

</script>
</body>
</html>
