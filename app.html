<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>PayerEdge — VSP Bundles (v10)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{
      --bg:#0b0f14;--fg:#e7eefc;--muted:#9fb0c9;--card:#0f1621;--line:#233044;
      --ok:#10b981;--warn:#f59e0b;--err:#ef4444
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;border-bottom:1px solid #1b2535}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;padding:12px 20px}
    .group{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px 10px;display:flex;gap:10px;align-items:center}
    select{background:#152033;border:1px solid var(--line);color:var(--fg);padding:6px 10px;border-radius:8px}
    .btn{background:#162130;border:1px solid var(--line);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(260px,1fr));gap:14px;padding:0 20px 40px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .card h2{margin:0 0 2px 0;font-size:32px}
    .kicker{color:var(--muted);font-size:12px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-top:1px solid #1b2535;text-align:left}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)}
    .err{background:#2a0f12;border:1px solid var(--err);color:#fca5a5;padding:8px 10px;border-radius:8px;margin:10px 20px;display:none}
    .chip{font-size:12px;color:var(--muted)}
    @media(max-width:1200px){.cards{grid-template-columns:repeat(2,minmax(260px,1fr))}}
    @media(max-width:700px){.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>PayerEdge — VSP Bundles</h1>
      <div class="sub">Scoreboard shows <b>patient copay</b> and <b>service fee</b> (Copay − Holdback). Sun choices are exclusive.</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span class="chip">plan=<b>VSP_choice</b> • version=<b>v10</b> • source=<span id="src" class="muted">…</span></span>
      <button class="btn" id="refresh">Force Refresh</button>
      <button class="btn" id="clear">Clear Cache</button>
    </div>
  </header>

  <div class="row">
    <div class="group">
      <span class="muted">Lens family</span>
      <select id="lensFamily">
        <option value="SV">Single Vision</option>
        <option value="MF">Multifocal</option>
      </select>
    </div>
    <div class="group">
      <span class="muted">Lens tint</span>
      <select id="lensTint">
        <option value="Clear">Clear</option>
        <option value="Solid">Solid Tint</option>
        <option value="Gradient">Gradient Tint</option>
        <option value="Photochromic">Photochromic (Transitions)</option>
        <option value="Polarized">Polarized</option>
      </select>
    </div>
    <div class="group" style="gap:14px">
      <label><input type="checkbox" id="ar" checked/> Include AR (tiered)</label>
      <label><input type="checkbox" id="aspheric"/> Aspheric</label>
      <label><input type="checkbox" id="oversize"/> Oversize</label>
      <label><input type="checkbox" id="glass"/> Glass</label>
      <label><input type="checkbox" id="noOnly"/> Custom measurements (N/O only)</label>
    </div>
    <div class="group"><span class="muted">[debug]</span> <span id="meta" class="chip">…</span></div>
  </div>

  <div id="err" class="err"></div>
  <div class="cards" id="cards"></div>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    /**********************
     * CONFIG / CONSTANTS *
     **********************/
    const CSV_PATH = "./data/vsp_choice_master_v8_from_patched.csv";
    document.getElementById("src").textContent = CSV_PATH;

    // Authoritative Digital Aspheric (BA…) pricing from your chart
    const DASP = {
      SV: {
        "BA":    { cb:24, sf:21, base:45, add: 0, allowed:true },
        "BA+BB": { cb:16, sf:12, base:45, add:28, allowed:true },
        "BA+BH": { cb:37, sf:21, base:45, add:58, allowed:true },
        "BA+BJ": { cb:57, sf:29, base:45, add:86, allowed:true },
        "BA+BD": { cb:10, sf: 0, base:45, add:10, allowed:true }
      },
      MF: {
        "BA":    { cb:34, sf:21, base:55, add: 0, allowed:true },
        "BA+BB": { cb:16, sf:12, base:55, add:28, allowed:true },
        "BA+BH": { cb:40, sf:28, base:55, add:68, allowed:true },
        "BA+BJ": { cb:null, sf:null, base:null, add:null, allowed:false }, // not offered
        "BA+BD": { cb:10, sf: 0, base:55, add:10, allowed:true }
      }
    };

    // Recipes reflect your 4-card scoreboard
    const RECIPES = {
      SV: [
        { card:"Hi67",  pair:"BA+BH", components:["BA","BH"], title:"Digital Aspheric" },
        { card:"Mid",   pair:"BA+BB", components:["BA","BB"], title:"Digital Aspheric" },
        { card:"Poly",  pair:"BA+BD", components:["BA","BD"], title:"Digital Aspheric" },
        { card:"CR",    pair:null,    components:["AA","QM?"], title:"CR" }
      ],
      MF: [
        { card:"Hi67",  pair:"BA+BH", components:["BA","BH"], title:"Digital Aspheric" },
        { card:"Mid",   pair:"BA+BB", components:["BA","BB"], title:"Digital Aspheric" },
        { card:"Poly",  pair:"BA+BD", components:["BA","BD"], title:"Digital Aspheric" },
        { card:"CR",    pair:null,    components:["AA","QM?"], title:"CR" }
      ]
    };

    const META = document.getElementById("meta");
    const ERRBOX = document.getElementById("err");
    const CARDS = document.getElementById("cards");
    const CACHE_KEY = "vsp_csv_v10";

    /********************
     * HELPERS / UTILS  *
     ********************/
    const money = n => `$${Number(n||0).toFixed(2).replace(/\.00$/,"")}`;
    const sum = (arr, k) => arr.reduce((s,x)=>s+(x[k]||0),0);
    const totals = rows => ({copay:sum(rows,"copay"), hold:sum(rows,"holdback"), fee:sum(rows,"serviceFee")});
    const num = v => v==null||v==="" ? null : Number(String(v).replace(/[^\d.-]/g,""));

    function norm(row){
      const r = Object.fromEntries(Object.entries(row).map(([k,v])=>[String(k).trim().toLowerCase(), typeof v==="string"?v.trim():v]));
      return {
        item: r.item || r.lens || r.category || "",
        code: (r.code || r.codes || "").toUpperCase(),
        family: (r.family || r.lens_family || r.type || "").toUpperCase().includes("MF") ? "MF" : "SV",
        copay: num(r.copay || r.patient_copay),
        holdback: num(r.holdback || r.chargeback || r.charge_back),
        serviceFee: num(r.service_fee || r.servicefee || r.fee)
      };
    }

    function indexByCode(rows){
      const idx = { SV:{}, MF:{} };
      for (const r of rows){
        if(!r.code) continue;
        const fam = (r.family==="MF") ? "MF" : "SV";
        if(!idx[fam][r.code]) idx[fam][r.code] = [];
        idx[fam][r.code].push(r);
      }
      return idx;
    }

    function uniqueByCode(list){
      const seen = new Set();
      return list.filter(r => (seen.has(r.code) ? false : (seen.add(r.code), true)));
    }

    /********************
     * LOAD CSV (robust)
     ********************/
    async function loadCsv(){
      const cached = sessionStorage.getItem(CACHE_KEY);
      if (cached){
        const { rows, when } = JSON.parse(cached);
        META.textContent = `rows=${rows.length} • cache ${(new Date(when)).toLocaleTimeString()}`;
        return rows;
      }
      try{
        const res = await fetch(CSV_PATH, {cache:"no-store"});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt = await res.text();
        const parsed = Papa.parse(txt, {header:true, skipEmptyLines:true});
        const rows = parsed.data.map(norm);
        sessionStorage.setItem(CACHE_KEY, JSON.stringify({rows, when:Date.now()}));
        META.textContent = `rows=${rows.length} • fresh`;
        return rows;
      }catch(e){
        ERRBOX.style.display = "block";
        ERRBOX.textContent = `CSV load failed (${e.message}). App will render BA map only for demo.`;
        META.textContent = "rows=0 • degraded";
        return [];
      }
    }

    /*********************
     * PRICING FUNCTIONS *
     *********************/
    function baPairRow(family, pairKey){
      const fam = family==="MF" ? DASP.MF : DASP.SV;
      const rec = fam[pairKey];
      if (!rec || rec.allowed===false) return null;
      return { item:"Digital Aspheric", code: pairKey, copay: rec.base+rec.add, holdback: rec.cb, serviceFee: rec.sf, source:"map" };
    }

    function baComponentRow(family, comp){ // comp ∈ {BA, BB, BH, BD}
      const fam = family==="MF" ? DASP.MF : DASP.SV;
      if (comp==="BA"){
        const r = fam["BA"]; return { item:"Digital Aspheric", code:"BA", copay:r.base+r.add, holdback:r.cb, serviceFee:r.sf, source:"map" };
      }
      const key = "BA+"+comp;
      const rec = fam[key];
      if (!rec || rec.allowed===false) return null;
      return { item:"Digital Aspheric", code:comp, copay:rec.base+rec.add, holdback:rec.cb, serviceFee:rec.sf, source:"map" };
    }

    function fromCsv(idx, family, code){
      const list = (idx[family] && idx[family][code]) ? idx[family][code] : [];
      if (!list.length) return null;
      const best = list.find(r=>r.copay!=null && r.holdback!=null && r.serviceFee!=null) || list[0];
      return { item: best.item || "", code, copay: best.copay||0, holdback: best.holdback||0, serviceFee: best.serviceFee||0, source:"csv" };
    }

    /****************
     * RENDER CARDS *
     ****************/
    function renderBundleCard(title, badge, summaryRow, componentRows){
      const t = totals([summaryRow]);
      const subt = totals(componentRows);
      return `
        <div class="card">
          <h2>${money(t.copay)}</h2>
          <div class="kicker">Patient Copay<br><span class="ok">Service Fee (Practice Profit): ${money(t.fee)}</span></div>
          <div class="muted" style="margin-bottom:6px">${badge}</div>
          <table>
            <thead><tr><th>Item</th><th>Code</th><th class="right">Copay</th><th class="right">Holdback</th><th class="right">Service Fee</th></tr></thead>
            <tbody>
              <tr>
                <td>${title}</td><td class="muted">${summaryRow.code}</td>
                <td class="right">${money(summaryRow.copay)}</td>
                <td class="right">${money(summaryRow.holdback)}</td>
                <td class="right">${money(summaryRow.serviceFee)}</td>
              </tr>
            </tbody>
          </table>
          <div class="muted" style="margin-top:10px">Code breakdown</div>
          <table>
            <thead><tr><th>Code</th><th class="right">Copay</th><th class="right">Holdback</th><th class="right">Service Fee</th></tr></thead>
            <tbody>
              ${componentRows.map(r=>`
                <tr>
                  <td class="muted">${r.code}</td>
                  <td class="right">${money(r.copay)}</td>
                  <td class="right">${money(r.holdback)}</td>
                  <td class="right">${money(r.serviceFee)}</td>
                </tr>`).join("")}
              <tr>
                <td class="muted">Totals</td>
                <td class="right"><b>${money(subt.copay)}</b></td>
                <td class="right"><b>${money(subt.hold)}</b></td>
                <td class="right"><b>${money(subt.fee)}</b></td>
              </tr>
            </tbody>
          </table>
        </div>`;
    }

    function renderSimpleCard(title, badge, rows){
      rows = uniqueByCode(rows);
      const t = totals(rows);
      return `
        <div class="card">
          <h2>${money(t.copay)}</h2>
          <div class="kicker">Patient Copay<br><span class="ok">Service Fee (Practice Profit): ${money(t.fee)}</span></div>
          <div class="muted" style="margin-bottom:6px">${badge}</div>
          <table>
            <thead><tr><th>Item</th><th>Code</th><th class="right">Copay</th><th class="right">Holdback</th><th class="right">Service Fee</th></tr></thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td>${r.item||title}</td>
                  <td class="muted">${r.code}</td>
                  <td class="right">${money(r.copay)}</td>
                  <td class="right">${money(r.holdback)}</td>
                  <td class="right">${money(r.serviceFee)}</td>
                </tr>`).join("")}
              <tr>
                <td class="muted">Totals</td><td></td>
                <td class="right"><b>${money(t.copay)}</b></td>
                <td class="right"><b>${money(t.hold)}</b></td>
                <td class="right"><b>${money(t.fee)}</b></td>
              </tr>
            </tbody>
          </table>
        </div>`;
    }

    /************
     * PIPELINE *
     ************/
    async function run(){
      const state = {
        family: document.getElementById("lensFamily").value,
        tint: document.getElementById("lensTint").value,
        includeAR: document.getElementById("ar").checked
      };

      // Sun exclusivity (note only; hook for future material rules)
      const sun = ["Solid","Gradient","Photochromic","Polarized"];
      if (sun.includes(state.tint)) {
        // enforce mutual exclusion in future material selection
      }

      const rows = await loadCsv();
      const idx = indexByCode(rows);
      const recipe = RECIPES[state.family];
      const cards = [];

      // Three BA bundles (summary pair + breakdown). No duplicates.
      for (const rcp of recipe.slice(0,3)){
        const sumRow = baPairRow(state.family, rcp.pair);
        const parts = rcp.components.map(c=>baComponentRow(state.family, c)).filter(Boolean);
        cards.push(renderBundleCard(rcp.title, rcp.card, sumRow, parts));
      }

      // CR (CSV-driven) — AA always, QM only if AR is checked; strictly by family
      const crCfg = recipe.find(x=>x.card==="CR");
      const crRows = [];
      const aa = fromCsv(idx, state.family, "AA"); if (aa) { aa.item = crCfg.title; crRows.push(aa); }
      if (state.includeAR){
        const qm = fromCsv(idx, state.family, "QM"); if (qm) { qm.item = "A/R"; crRows.push(qm); }
      }
      cards.push(renderSimpleCard(crCfg.title, "CR", crRows));

      CARDS.innerHTML = cards.join("");
    }

    /**********
     * EVENTS *
     **********/
    document.getElementById("lensFamily").addEventListener("change", ()=>{ sessionStorage.removeItem(CACHE_KEY); run(); });
    document.getElementById("lensTint").addEventListener("change", run);
    document.getElementById("ar").addEventListener("change", run);
    ["aspheric","oversize","glass","noOnly"].forEach(id=>document.getElementById(id).addEventListener("change", run));
    document.getElementById("refresh").addEventListener("click", ()=>{ sessionStorage.removeItem(CACHE_KEY); run(); });
    document.getElementById("clear").addEventListener("click", ()=>{ sessionStorage.clear(); document.getElementById("meta").textContent="cache cleared"; run(); });

    // boot
    run();
  </script>
</body>
</html>
