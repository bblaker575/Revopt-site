<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>RevSight AI — VSP Choice (Resilient)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg:#0b0f14; --fg:#e7eefc; --card:#0f1621; --border:#253146;
      --muted:#93a4bd; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body { background:var(--bg); color:var(--fg); font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:16px 20px; border-bottom:1px solid #1e2734;}
    h1 { font-size:18px; margin:0; }
    .sub { color:var(--muted); font-size:12px;}
    .pill { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#121a25; white-space:nowrap;}
    .ok   { color:#a7f3d0; border-color:#064e3b; background:#06251d;}
    .warn { color:#fde68a; border-color:#845c16; background:#3b2a08;}
    .err  { color:#fecaca; border-color:#7f1d1d; background:#2a0d0d;}
    .container{ max-width:1200px; margin:0 auto; padding:16px;}
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; margin:16px 0; }
    .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button { background:#1b2738; color:var(--fg); border:1px solid var(--border); border-radius:8px; padding:8px 12px; cursor:pointer;}
    button:disabled{opacity:.5; cursor:not-allowed}
    input[type="search"]{ background:#0c121b; color:var(--fg); border:1px solid var(--border); border-radius:8px; padding:8px 12px; min-width:260px;}
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    th, td{ text-align:left; padding:10px 8px; border-bottom:1px solid var(--border); font-size:14px;}
    th{ position:sticky; top:0; background:#101827; z-index:1; }
    .muted{ color:var(--muted); }
    .right{ text-align:right; }
    .small{ font-size:12px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .footer{ color:var(--muted); font-size:12px; padding:16px 0 24px; }
  </style>
  <!-- PapaParse for CSV parsing -->
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<header>
  <div>
    <h1>RevSight AI <span class="sub">• VSP Choice Data</span></h1>
  </div>
  <div id="status" class="pill">initializing…</div>
</header>

<div class="container">
  <div class="card">
    <div class="controls">
      <button id="btn-refresh" title="Force a full reload">Force Refresh</button>
      <button id="btn-clear" title="Clear Last-Known-Good cache">Clear Local Cache</button>
      <input id="search" type="search" placeholder="Filter rows (e.g., progressive, AR, poly)…"/>
      <span id="meta" class="muted small"></span>
    </div>
    <div id="log" class="mono small muted" style="margin-top:8px; max-height:140px; overflow:auto;"></div>
  </div>

  <div class="card">
    <div class="muted small" style="margin-bottom:8px">
      Showing <span id="count">0</span> rows
    </div>
    <div style="overflow:auto; max-height:65vh;">
      <table id="tbl">
        <thead>
          <tr id="thead"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    Resilient loader with checksum + schema guard. If data fetch fails, we fall back to the last-known-good (LKG) cache and show a warning.
  </div>
</div>

<script>
/* ========================= Resilient Loader (inline) =========================
   Exposes:
     - window.revoptDataPromise -> Promise<rows[]>
     - window.revoptData        -> rows[] (after resolved)
     - window.revoptDataMeta    -> { source, manifest }
   Looks for:
     - data/manifest.json
     - data/schema_v1.json
     - manifest.url (CSV path)
============================================================================= */
(function(){
  const MANIFEST_URL = "data/manifest.json";
  const SCHEMA_URL   = "data/schema_v1.json";
  const LKG_KEY      = "revopt:lkg:data";
  const LKG_META_KEY = "revopt:lkg:meta";

  async function sha256(text) {
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  function saveLKG(meta, rows){
    try{
      localStorage.setItem(LKG_KEY, JSON.stringify(rows));
      localStorage.setItem(LKG_META_KEY, JSON.stringify(meta));
    }catch(e){ /* quota issues */ }
  }
  function loadLKG(){
    try{
      const rows = JSON.parse(localStorage.getItem(LKG_KEY) || "null");
      const meta = JSON.parse(localStorage.getItem(LKG_META_KEY) || "null");
      if(!rows || !meta) return null;
      return { rows, meta };
    }catch(e){ return null; }
  }

  function validateSchema(rows, schema){
    if(!rows || !rows.length) throw new Error("empty dataset");
    const cols = Object.keys(rows[0] || {});
    const missing = (schema.required_columns || []).filter(c => !cols.includes(c));
    if(missing.length) throw new Error("missing columns: " + missing.join(", "));
    // numeric warn only
    const numCols = schema.numeric_columns || [];
    for(const col of numCols){
      for(let i=0;i<Math.min(rows.length,50);i++){
        const v = rows[i][col];
        if(v!==null && v!==undefined && v!==""){
          const vv = String(v).replace(/[$,%]/g,"").replace(/,/g,"");
          if(Number.isNaN(Number(vv))){
            console.warn("[revopt] Non-numeric sample for", col, "→", v);
            break;
          }
        }
      }
    }
  }

  async function fetchText(url, version){
    const final = version ? `${url}?v=${encodeURIComponent(version)}` : url;
    const res = await fetch(final, { cache: "reload" });
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${final}`);
    return await res.text();
  }

  function parseCSV(text){
    return new Promise((resolve,reject)=>{
      if(!window.Papa){ return reject(new Error("PapaParse not loaded")); }
      Papa.parse(text, {
        header:true,
        dynamicTyping:false,
        skipEmptyLines:"greedy",
        transformHeader: h => (h || "").trim(),
        complete: (r)=> resolve(r.data),
        error: reject
      });
    });
  }

  async function loadNetwork(){
    const manifestText = await fetchText(MANIFEST_URL);
    const manifest = JSON.parse(manifestText);
    const schemaText = await fetchText(SCHEMA_URL, manifest.schema_version || "");
    const schema = JSON.parse(schemaText);
    const csvText = await fetchText(manifest.url, manifest.version);
    const hash = await sha256(csvText);
    if(manifest.sha256 && manifest.sha256.toLowerCase() !== hash.toLowerCase()){
      throw new Error(`Checksum mismatch. Expected ${manifest.sha256} got ${hash}`);
    }
    const rows = await parseCSV(csvText);
    validateSchema(rows, schema);
    saveLKG({ source:"network", manifest }, rows);
    return { rows, meta: { source:"network", manifest } };
  }

  async function loadData(){
    try{
      const net = await loadNetwork();
      return net;
    }catch(e){
      console.warn("[revopt] network path failed:", e.message);
      const lkg = loadLKG();
      if(lkg){ return lkg; }
      throw new Error("No data available (network failed and no LKG). " + e.message);
    }
  }

  window.revoptDataPromise = (async ()=>{
    const { rows, meta } = await loadData();
    window.revoptData = rows;
    window.revoptDataMeta = meta;
    return rows;
  })();
})();
</script>

<script>
/* ======================== Minimal App Wiring ======================== */
const $ = sel => document.querySelector(sel);
const statusEl = $("#status");
const metaEl = $("#meta");
const logEl = $("#log");
const thead = $("#thead");
const tbody = $("#tbody");
const countEl = $("#count");
const searchEl = $("#search");

function setStatus(kind, msg){
  statusEl.className = "pill " + (kind||"");
  statusEl.textContent = msg;
}
function logLine(msg){
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}
function toNum(v){
  if(v==null || v==="") return null;
  return Number(String(v).replace(/[$,%]/g,"").replace(/,/g,""));
}
function renderTable(rows){
  if(!rows || !rows.length){
    thead.innerHTML = "";
    tbody.innerHTML = `<tr><td class="muted">No rows</td></tr>`;
    countEl.textContent = "0";
    return;
  }
  const cols = Object.keys(rows[0]);
  thead.innerHTML = cols.map(c=>`<th>${c}</th>`).join("");
  const html = rows.map(r=>{
    return `<tr>${cols.map(c=>`<td>${(r[c]??"")}</td>`).join("")}</tr>`;
  }).join("");
  tbody.innerHTML = html;
  countEl.textContent = String(rows.length);
}

function filterRows(rows, q){
  if(!q) return rows;
  const s = q.trim().toLowerCase();
  return rows.filter(r => Object.values(r).some(v => String(v||"").toLowerCase().includes(s)));
}

// Wire buttons
$("#btn-refresh").onclick = ()=> location.reload();
$("#btn-clear").onclick = ()=>{
  localStorage.removeItem("revopt:lkg:data");
  localStorage.removeItem("revopt:lkg:meta");
  location.reload();
};

// Initialize
(async ()=>{
  try{
    const rows = await window.revoptDataPromise;
    const meta = window.revoptDataMeta || {};
    const manifest = meta.manifest || {};
    const source = meta.source || "network";

    // Status + meta
    setStatus(source==="network" ? "ok" : "warn",
      source==="network" ? `Active: ${manifest.version || "?"} (network)` : `Using LKG: ${manifest.version || "unknown"}`);
    metaEl.innerHTML = `
      <span class="mono small">plan=${manifest.plan||"?"}</span>&nbsp;•&nbsp;
      <span class="mono small">version=${manifest.version||"?"}</span>&nbsp;•&nbsp;
      <span class="mono small">source=${source}</span>
    `;

    // Coerce numeric fields we know about
    const data = rows.map(r=>({
      ...r,
      copay: toNum(r.copay),
      vsp: toNum(r.vsp),
      chargeback: toNum(r.chargeback)
    }));

    // Render + search
    renderTable(data);
    searchEl.addEventListener("input", ()=>{
      const filtered = filterRows(data, searchEl.value);
      renderTable(filtered);
    });

    logLine(`[ok] loaded ${rows.length} rows`);
    if(source!=="network") logLine("[warn] network failed; using Last-Known-Good cache");

  }catch(err){
    console.error(err);
    setStatus("err","No data available");
    logLine("[fatal] " + err.message);
  }
})();
</script>
</body>
</html>
