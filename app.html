<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>RevSight AI — VSP Choice Bundles (v9)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{
      --bg:#0b0f14;--fg:#e7eefc;--muted:#9fb0c9;--card:#101722;--line:#233044;
      --ok:#0f6a52;--warn:#7c5c19;--err:#b91c1c;--chip:#172234
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;border-bottom:1px solid #1b2535}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;padding:12px 20px}
    .btn{background:#162130;border:1px solid var(--line);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .group{background:#0f1621;border:1px solid var(--line);border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center}
    .chip{background:var(--chip);padding:6px 9px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .ctrl{display:flex;align-items:center;gap:8px}
    select{background:#152033;border:1px solid var(--line);color:var(--fg);padding:6px 10px;border-radius:8px}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(260px,1fr));gap:14px;padding:0 20px 40px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .card h2{margin:0 0 2px 0;font-size:32px}
    .kicker{color:var(--muted);font-size:12px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-top:1px solid #1b2535;text-align:left}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .ok{color:#10b981}
    .err{background:#2a0f12;border:1px solid var(--err);color:#fca5a5;padding:8px 10px;border-radius:8px;margin:10px 20px}
    .pill{display:inline-flex;gap:6px;align-items:center;font-size:12px;background:#122238;border:1px solid var(--line);padding:4px 8px;border-radius:999px}
    .headergrid{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    @media(max-width:1200px){.cards{grid-template-columns:repeat(2,minmax(260px,1fr))}}
    @media(max-width:700px){.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="headergrid">
        <h1>PayerEdge — VSP Bundles</h1>
        <span class="pill">plan=<b>VSP_choice</b> • version=<b>v9</b> • source=<span id="src" class="muted">…</span></span>
      </div>
      <div class="sub">Scoreboard shows <b>patient copay</b> and <b>service fee</b> (Copay − Holdback). Sun choices are exclusive.</div>
    </div>
    <div class="ctrl">
      <button class="btn" id="refresh">Force Refresh</button>
      <button class="btn" id="clear">Clear Cache</button>
    </div>
  </header>

  <div class="row">
    <div class="group">
      <span class="muted">Lens family</span>
      <select id="lensFamily">
        <option value="SV">Single Vision</option>
        <option value="MF">Multifocal</option>
      </select>
    </div>
    <div class="group">
      <span class="muted">Lens tint</span>
      <select id="lensTint">
        <option value="Clear">Clear</option>
        <option value="Solid">Solid Tint</option>
        <option value="Gradient">Gradient Tint</option>
        <option value="Photochromic">Photochromic (Transitions)</option>
        <option value="Polarized">Polarized</option>
      </select>
    </div>
    <div class="group">
      <label><input type="checkbox" id="ar" checked/> Include AR (tiered)</label>
      <label><input type="checkbox" id="aspheric" /> Aspheric</label>
      <label><input type="checkbox" id="oversize" /> Oversize</label>
      <label><input type="checkbox" id="glass" /> Glass</label>
      <label><input type="checkbox" id="noOnly" /> Custom measurements (N/O only)</label>
    </div>
    <div class="group"><span class="muted">[debug]</span><span id="meta" class="chip">…</span></div>
  </div>

  <div id="err" class="err" style="display:none"></div>
  <div class="cards" id="cards"></div>

  <!-- PapaParse (fixed: no SRI) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /***************
     * CONFIG/VERS *
     ***************/
    const CSV_PATH = "./data/vsp_choice_master_v8_from_patched.csv";
    document.getElementById("src").textContent = CSV_PATH;

    // Authoritative Digital Aspheric (BA…) pricing from the chart you provided
    const DIGITAL_ASPHERIC = {
      SV: {
        "BA":    { cb:24, sf:21, base:45, add:0,  allowed:true },
        "BA+BB": { cb:16, sf:12, base:45, add:28, allowed:true },
        "BA+BH": { cb:37, sf:21, base:45, add:58, allowed:true },
        "BA+BJ": { cb:57, sf:29, base:45, add:86, allowed:true },
        "BA+BD": { cb:10, sf: 0, base:45, add:10, allowed:true }
      },
      MF: {
        "BA":    { cb:34, sf:21, base:55, add:0,  allowed:true },
        "BA+BB": { cb:16, sf:12, base:55, add:28, allowed:true },
        "BA+BH": { cb:40, sf:28, base:55, add:68, allowed:true },
        "BA+BJ": { cb:null, sf:null, base:null, add:null, allowed:false }, // not offered
        "BA+BD": { cb:10, sf: 0, base:55, add:10, allowed:true }
      }
    };

    // Exclusivity note (UI state only; pricing rules handled elsewhere if needed)
    function enforceExclusivity(state){
      state.notes = [];
      const t = state.tint;
      if (["Solid","Gradient","Photochromic","Polarized"].includes(t)) {
        state.notes.push("Sun choices exclusive.");
      }
      if (t === "Polarized" && state.family === "MF") {
        state.notes.push("Polarized = material for MF; exclude other materials.");
      }
      return state;
    }

    // Cache + DOM refs
    const CACHE_KEY = "vsp_csv_v9";
    const META = document.getElementById("meta");
    const ERRBOX = document.getElementById("err");
    const CARDS = document.getElementById("cards");

    /*****************
     * LOAD CSV SAFE *
     *****************/
    async function loadCsv(){
      const cached = sessionStorage.getItem(CACHE_KEY);
      if (cached){
        const { rows, when } = JSON.parse(cached);
        META.textContent = `rows=${rows.length} • cache ${(new Date(when)).toLocaleTimeString()}`;
        return rows;
      }
      try{
        const res = await fetch(CSV_PATH, { cache: "no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
        const rows = parsed.data;
        sessionStorage.setItem(CACHE_KEY, JSON.stringify({rows, when:Date.now()}));
        META.textContent = `rows=${rows.length} • fresh`;
        return rows;
      }catch(e){
        ERRBOX.style.display="block";
        ERRBOX.textContent = `CSV load failed (${e.message}). Using fallback sample so UI keeps working.`;
        META.textContent = "rows=sample • degraded";
        return sampleRows();
      }
    }

    function sampleRows(){
      return [
        { item:"Digital Aspheric", code:"BA+BH", family:"SV", copay:"", holdback:"37", service_fee:"21" },
        { item:"Digital Aspheric", code:"BA+BD", family:"SV", copay:"", holdback:"10", service_fee:"0" },
        { item:"CR", code:"AA", family:"SV", copay:"31", holdback:"10", service_fee:"21" }
      ];
    }

    // Normalizer
    const num = (v)=> v==null||v==="" ? null : Number(String(v).replace(/[^\d.-]/g,""));
    function norm(row){
      const r = Object.fromEntries(Object.entries(row).map(([k,v])=>[String(k).trim().toLowerCase(), typeof v==="string"?v.trim():v]));
      return {
        item: r.item || r.lens || r.category || "",
        code: (r.code || r.codes || "").toUpperCase(),
        family: (r.family || r.lens_family || r.type || "").toUpperCase().includes("MF") ? "MF" : "SV",
        copay: num(r.copay || r.patient_copay),
        holdback: num(r.holdback || r.chargeback || r.charge_back),
        serviceFee: num(r.service_fee || r.servicefee || r.fee)
      };
    }

    /*********************
     * PRICING OVERRIDES *
     *********************/
    function priceDigitalAspheric(lensFamily, code){
      const fam = lensFamily==="MF" ? DIGITAL_ASPHERIC.MF : DIGITAL_ASPHERIC.SV;
      const rec = fam[code];
      if(!rec || !rec.allowed) return null;
      return {
        copay: (rec.base ?? 0) + (rec.add ?? 0),
        holdback: rec.cb ?? 0,
        serviceFee: rec.sf ?? 0,
        _source:"v9:aspheric-map"
      };
    }

    function applyOverrides(rows, state){
      const out = [];
      for (const raw of rows){
        const r = norm(raw);

        // Use authoritative BA… map when applicable
        if (r.code.startsWith("BA")){
          const priced = priceDigitalAspheric(state.family, r.code);
          if (priced){
            out.push({
              item: "Digital Aspheric",
              code: r.code,
              family: state.family,
              copay: priced.copay,
              holdback: priced.holdback,
              serviceFee: priced.serviceFee,
              source: priced._source
            });
            continue;
          }
        }

        // Default pass-through
        out.push({
          item: r.item || "Item",
          code: r.code || "",
          family: r.family || state.family,
          copay: r.copay ?? 0,
          holdback: r.holdback ?? 0,
          serviceFee: r.serviceFee ?? 0,
          source: "csv"
        });
      }
      return out;
    }

    /****************
     * PRESENTATION *
     ****************/
    function groupForScoreboard(rows){
      const buckets = { "Hi67": [], "Mid": [], "Poly": [], "CR": [] };
      for (const r of rows){
        if (r.code.startsWith("BA+BH") || r.code.startsWith("BJ")) buckets["Hi67"].push(r);
        else if (r.code.startsWith("BA+BB")) buckets["Mid"].push(r);
        else if (r.code.startsWith("BA+BD")) buckets["Poly"].push(r);
        else if (r.code==="AA" || r.item.toUpperCase()==="CR") buckets["CR"].push(r);
      }
      return buckets;
    }

    function money(n){ return `$${Number(n||0).toFixed(2).replace(/\.00$/,"")}`; }

    function totals(list){
      const copay = list.reduce((s,x)=>s+(x.copay||0),0);
      const hold  = list.reduce((s,x)=>s+(x.holdback||0),0);
      const fee   = list.reduce((s,x)=>s+(x.serviceFee||0),0);
      return { copay, hold, fee };
    }

    function renderCard(title, badge, list){
      const t = totals(list);
      return `
      <div class="card">
        <h2>${money(t.copay)}</h2>
        <div class="kicker">Patient Copay<br><span class="ok">Service Fee (Practice Profit): ${money(t.fee)}</span></div>
        <div class="pill"><span>${badge}</span></div>
        <table>
          <thead><tr><th>Item</th><th>Code</th><th class="right">Copay</th><th class="right">Holdback</th><th class="right">Service Fee</th></tr></thead>
          <tbody>
            ${list.map(x=>`
              <tr>
                <td>${x.item}</td>
                <td class="muted">${x.code}</td>
                <td class="right">${money(x.copay)}</td>
                <td class="right">${money(x.holdback)}</td>
                <td class="right">${money(x.serviceFee)}</td>
              </tr>`).join("")}
            <tr>
              <td class="muted">Totals</td><td></td>
              <td class="right"><b>${money(t.copay)}</b></td>
              <td class="right"><b>${money(t.hold)}</b></td>
              <td class="right"><b>${money(t.fee)}</b></td>
            </tr>
          </tbody>
        </table>
      </div>`;
    }

    function draw(buckets){
      CARDS.innerHTML = [
        renderCard("Hi67","Hi67", buckets["Hi67"]),
        renderCard("Mid","Mid", buckets["Mid"]),
        renderCard("Poly","Poly", buckets["Poly"]),
        renderCard("CR","CR", buckets["CR"]),
      ].join("");
    }

    /************
     * PIPELINE *
     ************/
    async function run(){
      const state = {
        family: document.getElementById("lensFamily").value,
        tint: document.getElementById("lensTint").value,
        ar: document.getElementById("ar").checked,
        aspheric: document.getElementById("aspheric").checked,
        oversize: document.getElementById("oversize").checked,
        glass: document.getElementById("glass").checked,
        noOnly: document.getElementById("noOnly").checked
      };
      enforceExclusivity(state);
      const rows = await loadCsv();
      const patched = applyOverrides(rows, state);
      const buckets = groupForScoreboard(patched);
      draw(buckets);
    }

    /**********
     * EVENTS *
     **********/
    document.getElementById("lensFamily").addEventListener("change",()=>{ sessionStorage.removeItem(CACHE_KEY); run();});
    document.getElementById("lensTint").addEventListener("change",run);
    ["ar","aspheric","oversize","glass","noOnly"].forEach(id=>{
      document.getElementById(id).addEventListener("change",run);
    });
    document.getElementById("refresh").addEventListener("click",()=>{
      sessionStorage.removeItem(CACHE_KEY); run();
    });
    document.getElementById("clear").addEventListener("click",()=>{
      sessionStorage.clear(); META.textContent="cache cleared"; run();
    });

    // Kickoff
    run();
  </script>
</body>
</html>
