<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RevSight AI — VSP Choice Tiering (Profit = sum of VSP service fees)</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#121822;--border:#2a3444;--text:#e7eefc;--muted:#9fb3d2;--accent:#7aa2ff;--good:#1fbf75;--mid:#f6c343;--best:#9867ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{padding:18px 16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .sub{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
    label{display:flex;align-items:center;gap:8px;margin:8px 0;font-size:14px;color:var(--muted)}
    input[type="checkbox"]{width:18px;height:18px}
    select,button{background:#0f1520;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font:inherit}
    button{cursor:pointer}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .bundle{border-left:4px solid var(--border);padding-left:10px;margin:6px 0}
    .bundle.good{border-color:var(--good)}
    .bundle.mid{border-color:var(--mid)}
    .bundle.best{border-color:var(--best)}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:4px 8px;font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid var(--border)}
    th{color:var(--muted);font-weight:600;text-align:left}
    .right{text-align:right}
    .tag{display:inline-block;padding:2px 6px;border-radius:6px;background:#0e1622;border:1px solid var(--border);font-size:12px;margin-right:6px;color:var(--muted)}
    .ok{color:var(--good)}.warn{color:var(--mid)}.boom{color:var(--best)}
    .foot{opacity:.7;font-size:12px;padding:10px 2px}
    .err{color:#ff7a7a}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>RevSight AI — VSP Choice Profit Engine</h1>
      <div class="sub">Profit = <b>sum of VSP service fees</b>. Toggles enforced globally (OFF = excluded everywhere). Loader now tries multiple CSV paths + has a cache reset.</div>
    </div>
    <div class="row" style="align-items:center">
      <span class="pill" id="csvStatus">CSV: not loaded</span>
      <button id="resetCache">Reset Cache</button>
      <button id="forceRefresh">Recalc</button>
    </div>
  </header>

  <main class="row" style="padding:16px">
    <section class="col card">
      <h3 style="margin-top:0">Inputs</h3>
      <div class="row">
        <div class="col">
          <label>Lens type
            <select id="lensType">
              <option value="SV">Single Vision (SV)</option>
              <option value="MF">Progressive / Multifocal (MF)</option>
            </select>
          </label>
        </div>
        <div class="col">
          <label>Material preference (optional)
            <select id="materialPref">
              <option value="">No preference</option>
              <option value="POLYCARBONATE">Polycarbonate</option>
              <option value="HIGH INDEX">High Index</option>
              <option value="PLASTIC">CR-39 / Standard</option>
              <option value="TRIVEX">Trivex</option>
              <option value="GLASS">Glass</option>
              <option value="ASPHERIC">Aspheric</option>
            </select>
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <div class="col">
          <div class="sub" style="margin-bottom:6px">Global Toggles (default states per spec)</div>
          <label><input id="toggleOversize" type="checkbox"> Oversize (default OFF)</label>
          <label><input id="toggleAR" type="checkbox" checked> AR Coating (default ON)</label>
          <label><input id="toggleAspheric" type="checkbox"> Aspheric (default OFF)</label>
          <label><input id="toggleGlass" type="checkbox"> Glass (default OFF)</label>
        </div>
      </div>

      <div class="foot">If a toggle is OFF, that category will be excluded from <i>all</i> bundles and will never appear as a line‑item.</div>
    </section>

    <section class="col card">
      <h3 style="margin-top:0">Recommended Bundles (by profit)</h3>
      <div id="bundles"></div>
    </section>

    <section class="col card">
      <h3 style="margin-top:0">Line‑item Economics</h3>
      <div id="lineItems"></div>
    </section>
  </main>

  <section class="card" style="margin:16px">
    <details open>
      <summary>Data/Diagnostics</summary>
      <div id="diag" class="muted" style="white-space:pre-wrap"></div>
    </details>
    <div class="foot">Autoload order: <code>localStorage.snapshot</code> → <code>./vsp_choice_master_v7_full_fixed.csv</code> → <code>[page-dir]/vsp_choice_master_v7_full_fixed.csv</code> → <code>/Revopt-site/vsp_choice_master_v7_full_fixed.csv</code>. A successful online load saves a fresh offline snapshot.</div>
  </section>

  <script>
    // --- CSV parser (quoted fields supported) ---
    function parseCSV(text){
      const rows=[]; let i=0, cur=''; let inQ=false; const push=()=>{ row.push(cur); cur=''; };
      let row=[];
      while(i<text.length){
        const c=text[i++];
        if(c==='"'){
          if(inQ && text[i]==='"'){ cur+='"'; i++; } else inQ=!inQ;
        } else if(c===',' && !inQ){ push(); }
        else if((c==='
'||c==='
') && !inQ){ if(cur!==''||row.length){ push(); rows.push(row); row=[]; } }
        else cur+=c;
      }
      if(cur!==''||row.length){ push(); rows.push(row); }
      const headers = rows.shift().map(h=>h.trim());
      return rows.filter(r=>r.length && r.some(x=>String(x).trim()!=='')).map(r=>{
        const o={}; headers.forEach((h,idx)=>o[h]=r[idx]===undefined?'' : r[idx]); return o;
      });
    }

    // --- Helpers ---
    function num(x){ const n=Number(String(x).replace(/[^0-9.\-]/g,'')); return Number.isFinite(n)?n:0; }
    function truthy(x){ x=String(x||'').trim().toLowerCase(); if(x==='') return true; return x==='1'||x==='y'||x==='yes'||x==='true'; }
    function falsy(x){ x=String(x||'').trim().toLowerCase(); return x==='0'||x==='n'||x==='no'||x==='false'; }
    function uc(s){ return String(s||'').toUpperCase(); }

    // PROFIT: per your rule, profit for a selectable line == VSP service fee on that line
    function computeProfit(row){ return num(row.vsp); }

    function classify(row){
      if('active' in row && falsy(row.active)) return null;

      const applies = uc(row.applies_to);
      let lensType = 'BOTH';
      if(applies.includes('MF') && !applies.includes('SV') && !applies.includes('ALL')) lensType = 'MF';
      else if(applies.includes('SV') && !applies.includes('MF') && !applies.includes('ALL')) lensType = 'SV';

      const group = uc(row.group);
      const exkey = uc(row.exclusive_key);

      const materialTxt    = uc(row.subtype);
      const enhancementTxt = uc(row.enhancement);
      const desc = row.enhancement || row.subtype || row.code || '';

      // Detect MF base (Progressive) vs SV base (Material)
      const isBaseSV = group.includes('MATERIAL') && (exkey.includes('BASE') || exkey.includes('MATERIAL') || exkey==='');
      const isBaseMF = group.includes('PROGRESSIVE');

      // Parse material hint from progressive description for MF
      let mfMat = '';
      if(isBaseMF){
        const e = enhancementTxt;
        if(e.includes('POLYCARBONATE')) mfMat = 'POLYCARBONATE';
        else if(e.includes('1.70')) mfMat = 'HI70';
        else if(e.includes('1.66') || e.includes('1.67')) mfMat = 'HI67';
        else if(e.includes('1.53') || e.includes('1.60')) mfMat = 'HI-MID';
        else if(e.includes('GLASS')) mfMat = 'GLASS';
        else if(e.includes('PLASTIC')) mfMat = 'PLASTIC';
        else mfMat = materialTxt || 'PLASTIC';
      }

      const t = (materialTxt + ' ' + enhancementTxt);
      const flags = {
        AR: t.includes(' AR') || t.startsWith('AR') || t.includes('ANTI-REFLECT'),
        ASPHERIC: t.includes('ASPHERIC'),
        GLASS: t.includes('GLASS'),
        OVERSIZE: t.includes('OVERSIZE') || t.includes('OVR') || t.includes('61MM')
      };

      return {
        lensType,
        material: isBaseSV ? materialTxt : (isBaseMF ? (uc(row.subtype||'') + ' ' + mfMat).trim() : ''),
        enhancement: (!isBaseSV && !isBaseMF) ? enhancementTxt : '',
        desc,
        profit: computeProfit(row),
        raw: row,
        f: flags,
        baseKind: isBaseMF ? 'MF' : (isBaseSV ? 'SV' : '')
      };
    }

    function byProfitDesc(a,b){ return b.profit - a.profit; }

    function buildUniverse(rows){
      const mapped = rows.map(classify).filter(Boolean);
      return mapped.filter(it=>{
        if(it.baseKind){ return true; }
        return !('composable' in it.raw) || truthy(it.raw.composable);
      });
    }

    function applyGlobalToggles(items, toggles){
      return items.filter(it=>{
        if(!toggles.AR && (it.enhancement.includes('AR') || it.f.AR)) return false;
        if(!toggles.ASPHERIC && (it.material.includes('ASPHERIC') || it.f.ASPHERIC)) return false;
        if(!toggles.GLASS && (it.material.includes('GLASS') || it.f.GLASS)) return false;
        if(!toggles.OVERSIZE && (it.enhancement.includes('OVERSIZE') || it.f.OVERSIZE)) return false;
        return true;
      });
    }

    function pickBundles(universe, lensType, materialPref, toggles){
      const pool = applyGlobalToggles(
        universe.filter(u=> !lensType || u.lensType===lensType || u.lensType==='BOTH'),
        toggles
      );

      const isMF = lensType==='MF';
      const bases = pool.filter(x => (isMF ? x.baseKind==='MF' : x.baseKind==='SV'));
      const enh   = pool.filter(x => !x.baseKind);

      const buckets = bases.reduce((m,x)=>{ const k=x.material||x.desc; (m[k]??=[]).push(x); return m; }, {});
      const keys = Object.keys(buckets);

      const candidateKeys = (materialPref && keys.includes(materialPref)) ? [materialPref] : keys;

      const bestAR       = toggles.AR       ? enh.filter(e=>e.f.AR).sort(byProfitDesc)[0]       : null;
      const bestOversize = toggles.OVERSIZE ? enh.filter(e=>e.f.OVERSIZE).sort(byProfitDesc)[0] : null;

      const bundles = [];
      for(const k of (candidateKeys.length ? candidateKeys : keys)){
        const base = (buckets[k]||[]).sort(byProfitDesc)[0];
        if(!base) continue;
        const parts=[base];
        if(bestAR) parts.push(bestAR);
        if(bestOversize) parts.push(bestOversize);

        const seen=new Set(); let profit=0; const lines=[];
        for(const p of parts){
          const key=(p.raw.group||'')+'|'+(p.material||'')+'|'+(p.enhancement||'')+'|'+(p.desc||'');
          if(seen.has(key)) continue; seen.add(key);
          lines.push(p); profit+=p.profit;
        }
        bundles.push({ material:k, parts:lines, profit });
      }

      bundles.sort((a,b)=>b.profit-a.profit);
      const uniq=[]; const seenKey=new Set();
      for(const b of bundles){ if(!seenKey.has(b.material)){ uniq.push(b); seenKey.add(b.material); } }

      const best = uniq[0];
      const mid  = uniq[1] || uniq[0];
      const good = uniq[uniq.length-1] || uniq[0];
      return { good, mid, best, poolSize: bundles.length };
    }

    function fmtCurrency(n){ return n==null?"—": "$"+ (Number(n).toFixed(2)); }

    function renderBundles(picks){
      const el = document.getElementById('bundles');
      if(!picks || !picks.best){ el.innerHTML = '<div class="muted">No bundles available with current filters.</div>'; return; }
      const make = (b,cls,label)=>{
        if(!b) return `<div class="bundle ${cls}"><div class="muted">No ${label} bundle available</div></div>`;
        const rows = b.parts.map(p=>`<tr><td>${p.desc || (p.material||p.enhancement)}</td><td class="right">${fmtCurrency(p.profit)}</td></tr>`).join('');
        return `<div class="bundle ${cls}">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div class="tag">${label}</div>
            <div class="tag">Material: ${b.material||'—'}</div>
            <div class="tag">Bundle Profit: ${fmtCurrency(b.profit)}</div>
          </div>
          <table><thead><tr><th>Line Item</th><th class="right">Profit</th></tr></thead><tbody>${rows}</tbody></table>
        </div>`;
      };
      el.innerHTML = make(picks.good,'good','Good') + make(picks.mid,'mid','Mid') + make(picks.best,'best','Best');
    }

    function renderLineItems(universe, lensType){
      const el = document.getElementById('lineItems');
      const list = universe.filter(u=>!lensType || u.lensType===lensType || u.lensType==='BOTH').sort(byProfitDesc).slice(0,200);
      if(!list.length){ el.innerHTML = '<div class="muted">No items.</div>'; return; }
      el.innerHTML = `<table><thead><tr><th>Type</th><th>Material</th><th>Enhancement</th><th>Description</th><th class="right">VSP fee (profit)</th></tr></thead><tbody>
      ${list.map(r=>`<tr><td>${r.lensType||'—'}</td><td>${r.material||'—'}</td><td>${r.enhancement||'—'}</td><td>${r.desc||''}</td><td class="right">${fmtCurrency(r.profit)}</td></tr>`).join('')}
      </tbody></table>`;
    }

    // Snapshot helpers
    function saveSnapshot(csvText){ try{ localStorage.setItem('vsp_choice_snapshot_v7', csvText); }catch(e){} }
    function loadSnapshot(){ try{ return localStorage.getItem('vsp_choice_snapshot_v7'); }catch(e){ return null; } }
    function clearSnapshot(){ try{ localStorage.removeItem('vsp_choice_snapshot_v7'); }catch(e){} }

    // SIMPLE loader (match first script behavior) — try only the two known-good paths
    async function loadCSV(){
      const badge = document.getElementById('csvStatus');
      const tried=[];

      // 1) If snapshot exists, use it (keeps offline behavior)
      const snap = loadSnapshot();
      if(snap){
        badge.textContent = 'CSV: offline snapshot';
        badge.style.borderColor = '#3c6';
        return parseCSV(snap);
      }

      const candidates = [
        'https://bblaker575.github.io/Revopt-site/vsp_choice_master_v7_full_fixed.csv',
        './vsp_choice_master_v7_full_fixed.csv',
        '/Revopt-site/vsp_choice_master_v7_full_fixed.csv'
      ];
      for(const u of candidates){
        try{
          const r = await fetch(u + '?t=' + Date.now(), {cache:'no-store'});
          if(!r.ok) throw new Error(r.status+': '+r.statusText);
          const text = await r.text();
          saveSnapshot(text);
          badge.textContent = 'CSV: loaded from ' + u;
          badge.style.borderColor = '#6cf';
          return parseCSV(text);
        }catch(e){ tried.push(u+' -> '+(e.message||e)); }
      }
      badge.textContent = 'CSV: not loaded';
      badge.style.borderColor = '#f66';
      document.getElementById('diag').textContent = 'Tried URLs:
- ' + tried.join('
- ');
      return [];
    }

    let UNIVERSE = [];

    async function recalc(){
      const lensType = document.getElementById('lensType').value;
      const materialPref = document.getElementById('materialPref').value;
      const toggles = {
        OVERSIZE: document.getElementById('toggleOversize').checked,
        AR: document.getElementById('toggleAR').checked,
        ASPHERIC: document.getElementById('toggleAspheric').checked,
        GLASS: document.getElementById('toggleGlass').checked,
      };

      const picks = pickBundles(UNIVERSE, lensType, materialPref, toggles);
      renderBundles(picks);
      renderLineItems(UNIVERSE, lensType);

      const diag = document.getElementById('diag');
      diag.textContent = JSON.stringify({ lensType, materialPref, toggles, universe: UNIVERSE.length, poolCandidates: picks.poolSize }, null, 2);
    }

    (async function init(){
      document.getElementById('resetCache').addEventListener('click', async ()=>{ clearSnapshot(); document.getElementById('csvStatus').textContent='CSV: cache cleared'; UNIVERSE = buildUniverse(await loadCSV()); recalc(); });
      const raw = await loadCSV();
      UNIVERSE = buildUniverse(raw);
      document.getElementById('forceRefresh').addEventListener('click', recalc);
      document.getElementById('lensType').addEventListener('change', recalc);
      document.getElementById('materialPref').addEventListener('change', recalc);
      document.getElementById('toggleOversize').addEventListener('change', recalc);
      document.getElementById('toggleAR').addEventListener('change', recalc);
      document.getElementById('toggleAspheric').addEventListener('change', recalc);
      document.getElementById('toggleGlass').addEventListener('change', recalc);
      recalc();
    })();
  </script>
</body>
</html>
