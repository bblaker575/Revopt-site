<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RevSight AI — VSP Choice Bundles</title>
  <style>
    :root{--bg:#0b0f14;--fg:#e7eefc;--muted:#9fb0c9;--card:#101722;--line:#233044}
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--line)}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px}
    main{padding:16px}
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:0 0 14px}
    .btn{background:#132034;border:1px solid var(--line);color:var(--fg);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#16263c}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{accent-color:#4f9cff}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px dashed #213043;padding:8px 6px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .badge{font-size:11px;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
    .good{border-color:#35506e}.better{border-color:#7c5c19}.best{border-color:#0f6a52}
    .money{font-weight:700}.nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>RevSight AI — VSP Choice Bundles</h1>
      <div class="sub">
        SV-first. Tiers ranked by <b>practice profit (copay − chargeback)</b>. AR default <b>ON</b> with tier step-down (Best→Better→Good).
        Sun is <b>mutually exclusive</b>: Clear / Tinted / Polarized / Transitions®. Offline cache enabled.
      </div>
    </div>
    <div class="sub" id="version">loading…</div>
  </header>

  <main>
    <div class="bar">
      <button class="btn" id="forceRefresh">Force Refresh</button>
      <button class="btn" id="clearCache">Clear Local Cache</button>

      <label class="switch">Lens family
        <select id="lensFamily">
          <option value="SV" selected>Single Vision</option>
          <option value="LINED">Lined Bi/Tri</option>
          <option value="PAL">Progressive</option>
        </select>
      </label>

      <label class="switch"><input type="checkbox" id="includeAR" checked> Include AR (tiered)</label>
      <label class="switch"><input type="checkbox" id="includeAspheric"> Aspheric</label>
      <label class="switch"><input type="checkbox" id="includeOversize"> Oversize</label>
      <label class="switch"><input type="checkbox" id="includeGlass"> Glass</label>

      <!-- Mutually exclusive sun selection -->
      <label class="switch">Lens tint
        <select id="lensTint">
          <option value="clear" selected>Clear</option>
          <option value="tinted">Tinted</option>
          <option value="polarized">Polarized</option>
          <option value="transitions">Transitions®</option>
        </select>
      </label>

      <span class="sub" id="status"></span>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="sub">Computed Bundles</div>
        <div class="sub" id="bundleCount">—</div>
      </div>
      <table id="bundleTable">
        <thead>
          <tr>
            <th>Tier</th>
            <th>Material</th>
            <th>Add-ons</th>
            <th class="nowrap">Patient Copay</th>
            <th class="nowrap">Chargeback</th>
            <th class="nowrap">Profit</th>
            <!-- Profit/Copay removed from UI (still computed internally) -->
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    // ---------------- Config ----------------
    const DEFAULT_CSV = 'data/vsp_choice_master_v7_full_fixed.csv';

    // ---------------- Utils -----------------
    const el = (id)=>document.getElementById(id);
    const sum = (a)=>a.reduce((x,y)=>x+y,0);
    const money = (v)=>`$${v.toFixed(2)}`;
    const num = (v)=>{ const x=parseFloat(String(v??'').replace(/[^0-9.-]/g,'')); return isFinite(x)?x:0; };
    const quickHash=(s)=>{ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0; } return ('00000000'+h.toString(16)).slice(-8); };

    // CSV parser with "" escape handling
    function parseCSV(text){
      const rows=[]; let row=[], field='', q=false;
      for(let i=0;i<text.length;i++){
        const ch=text[i];
        if(ch==='\"'){
          if(q && text[i+1]==='\"'){ field+='\"'; i++; }
          else { q=!q; }
          continue;
        }
        if(!q && ch===','){ row.push(field); field=''; continue; }
        if(!q && (ch==='\n' || ch==='\r')){ if(field!==''||row.length){ row.push(field); rows.push(row); row=[]; field=''; } continue; }
        field+=ch;
      }
      if(field!==''||row.length){ row.push(field); rows.push(row); }
      const headers = rows.shift().map(h=>h.replace(/^\"|\"$/g,'').trim());
      return rows.filter(r=>r.length>=headers.length).map(r=>{
        const o={}; headers.forEach((h,i)=>o[h]=(r[i]||'').replace(/^\"|\"$/g,'').trim()); return o;
      });
    }

    // Local cache
    const CACHE_KEY='rev-vsp-choice-csv-v1';
    const META_KEY='rev-vsp-choice-meta-v1';
    const setCache=(t,m)=>{ localStorage.setItem(CACHE_KEY,t); localStorage.setItem(META_KEY,JSON.stringify(m)); };
    const getCache=()=>({ text: localStorage.getItem(CACHE_KEY), meta: JSON.parse(localStorage.getItem(META_KEY)||'{}') });
    const clearCache=()=>{ localStorage.removeItem(CACHE_KEY); localStorage.removeItem(META_KEY); };

    // ---------------- Data ------------------
    let DATA=[];

    async function loadCSV(){
      const status=el('status'); status.textContent=' loading…';
      try{
        const res = await fetch(DEFAULT_CSV,{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();
        const meta = { plan:'VSP_choice', version:new Date().toISOString().slice(0,10)+'.gbb', source:'network:'+DEFAULT_CSV, sha:quickHash(text) };
        setCache(text, meta);
        DATA = parseCSV(text);
        renderMeta(DATA.length, meta);
        status.textContent = ` [ok] loaded ${DATA.length} rows`;
        computeBundles();
      }catch(err){
        const {text, meta} = getCache();
        if(text){
          DATA = parseCSV(text);
          renderMeta(DATA.length, {...meta, source:'cache'});
          el('status').textContent = ` Network failed (${err.message}). Using cached data (${DATA.length} rows).`;
          computeBundles();
        }else{
          el('status').textContent = ' Load failed: '+err.message+' (no cache available)';
        }
      }
    }

    function renderMeta(count, meta){
      el('version').textContent =
        `plan=${meta.plan||'VSP_choice'} • rows=${count||0} • version=${meta.version||'—'} • source=${meta.source||'—'} • sha=${meta.sha||'—'}`;
    }

    // ---------------- Business Logic ------------------
    const byKey = (k)=>DATA.filter(r=>(r.active||'yes').toLowerCase()==='yes' && (r.exclusive_key||'').toLowerCase()===k);

    function applies(row, fam){
      const a=(row.applies_to||'ALL').toUpperCase();
      if(a.includes('ALL')) return true;
      if(fam==='SV')     return a.includes('SV');
      if(fam==='LINED')  return a.includes('OCC');   // bifocal/occupational
      if(fam==='PAL')    return a.includes('MF');    // progressive/multifocal
      return true;
    }

    const profitOf = (row)=> num(row.copay) - num(row.chargeback); // LOCKED: copay − chargeback

    // Rank AR by explicit grade D>C>B>A when present; fallback to profit
    function rankAR(ars){
      const gradeVal = (s)=>{
        const m = String(s||'').match(/\b([A-D])\b/i);
        if(!m) return null;
        const g = m[1].toUpperCase();
        return {A:1,B:2,C:3,D:4}[g]||null; // larger is better
      };
      return [...ars].sort((a,b)=>{
        const ga = gradeVal(a.enhancement)||-1;
        const gb = gradeVal(b.enhancement)||-1;
        if(ga!==gb) return gb-ga;   // D..A
        return profitOf(b)-profitOf(a);
      });
    }

    // Pick best by profit from subset
    const pickBest = (arr)=> (arr && arr.length ? [...arr].sort((a,b)=>profitOf(b)-profitOf(a))[0] : null);

    // Build a bundle for a specific base + fixed add-ons
    function makeBundle(base, addOns){
      const items=[base, ...addOns.filter(Boolean)];
      const cop = sum(items.map(x=>num(x.copay)));
      const cb  = sum(items.map(x=>num(x.chargeback)));
      const pr  = cop - cb;
      const ratio = cop>0 ? (pr/cop) : 0; // internal only
      const label = base.enhancement || base.subtype || base.code || 'Base';
      return { label, items, copay:cop, chargeback:cb, profit:pr, ratio };
    }

    function computeBundles(){
      if(!DATA.length){ document.querySelector('#bundleTable tbody').innerHTML=''; return; }

      const fam = el('lensFamily').value;
      const wantAR = el('includeAR').checked;
      const wantAsp = el('includeAspheric').checked;
      const wantOS  = el('includeOversize').checked;
      const wantGlass = el('includeGlass').checked;
      const tintSel = el('lensTint').value; // clear|tinted|polarized|transitions

      // -------- Base candidates by family --------
      let base = [];
      if(fam==='SV'){
        base = byKey('base_material').filter(r=>applies(r,fam));
      }else if(fam==='LINED'){
        base = byKey('occupational').filter(r=>applies(r,fam));
      }else if(fam==='PAL'){
        base = byKey('progressive_level').filter(r=>applies(r,fam));
      }

      // Base filters
      base = base.filter(r=>{
        const name=(r.enhancement||'').toLowerCase();
        if(!wantAsp   && name.includes('aspheric')) return false;
        if(!wantGlass && name.includes('glass'))    return false;
        // Keep base independent of sun; sun comes from dropdown
        return true;
      });

      // -------- Add-ons (global pools) --------
      // AR pool
      const arPool = wantAR ? byKey('ar_level').filter(r=>applies(r,fam)) : [];
      const arRanked = wantAR ? rankAR(arPool) : [];

      // Sun tech pool (independent, mutually exclusive)
      const sunAll = byKey('sun_tech').filter(r=>applies(r,fam)).filter(r=>{
        const n=(r.enhancement||'').toLowerCase();
        if(!wantGlass && n.includes('glass')) return false;
        return true;
      });
      const sunPick = (()=> {
        const N = (x)=>String(x||'').toLowerCase();
        if(tintSel==='clear') return null;
        if(tintSel==='transitions') return pickBest(sunAll.filter(r=>/photochrom/.test(N(r.enhancement))));
        if(tintSel==='polarized')   return pickBest(sunAll.filter(r=>/polariz/.test(N(r.enhancement))));
        if(tintSel==='tinted')      return pickBest(sunAll.filter(r=>{
          const n=N(r.enhancement);
          return !/photochrom|polariz/.test(n) && /tint|tinted|solid|gradient|sunglass/.test(n);
        }));
        return null;
      })();

      // Oversize
      const overs = wantOS ? pickBest(byKey('oversize').filter(r=>applies(r,fam)).filter(r=>{
        const n=(r.enhancement||'').toLowerCase();
        if(!wantGlass && n.includes('glass')) return false;
        return true;
      })) : null;

      // Helper to pick AR by tier index with fallback
      function arForTier(idx){
        if(!wantAR || !arRanked.length) return null;
        if(idx < arRanked.length) return arRanked[idx];
        return arRanked[arRanked.length-1]; // fallback to best available if fewer than 3
      }

      // -------- Tier selection strategy (SV-first, applies to others too) --------
      // Best: max profit with highest AR grade (idx 0), fixed sun+oversize
      // Better: max profit on remaining materials with mid AR (idx 1)
      // Good: lowest copay on remaining materials with lowest AR (idx 2)
      function selectBest(candidates, arRow){
        let best=null;
        for(const m of candidates){
          const b = makeBundle(m, [arRow, sunPick, overs]);
          if(!best || b.profit>best.profit || (b.profit===best.profit && b.ratio>best.ratio)) best=b;
        }
        return best;
      }
      function selectMaxProfit(candidates, arRow, excludeLabels){
        let best=null;
        for(const m of candidates){
          const lbl=(m.enhancement||m.subtype||m.code||'Base');
          if(excludeLabels.has(lbl)) continue;
          const b = makeBundle(m, [arRow, sunPick, overs]);
          if(!best || b.profit>best.profit || (b.profit===best.profit && b.ratio>best.ratio)) best=b;
        }
        return best;
      }
      function selectMinCopay(candidates, arRow, excludeLabels){
        let best=null;
        for(const m of candidates){
          const lbl=(m.enhancement||m.subtype||m.code||'Base');
          if(excludeLabels.has(lbl)) continue;
          const b = makeBundle(m, [arRow, sunPick, overs]);
          if(!best || b.copay<best.copay || (b.copay===best.copay && b.profit>best.profit)) best=b;
        }
        return best;
      }

      const bestAR = arForTier(0), midAR = arForTier(1), lowAR = arForTier(2);

      const best = selectBest(base, bestAR);
      const used = new Set(best ? [best.label] : []);
      const mid  = selectMaxProfit(base, midAR, used) || selectMaxProfit(base, bestAR, used);
      if(mid) used.add(mid.label);
      const good = selectMinCopay(base, lowAR, used) || selectMinCopay(base, midAR||bestAR, used);

      // -------- Render --------
      const tbody=document.querySelector('#bundleTable tbody');
      tbody.innerHTML='';
      const rows=[['Good','good',good],['Better','better',mid],['Best','best',best]];
      for(const [name,cls,b] of rows){
        const tr=document.createElement('tr');
        if(!b){ tr.innerHTML=`<td>${name}</td><td colspan=5 class="sub">no viable bundle</td>`; tbody.appendChild(tr); continue; }
        const addons=b.items.slice(1);
        tr.innerHTML=`<td><span class="badge ${cls}">${name}</span></td>
          <td>${b.label}</td>
          <td>${addons.map(a=>`<span class="badge">${a.enhancement||a.subtype||a.code}</span>`).join(' ') || '<span class="sub">—</span>'}</td>
          <td class="money">${money(b.copay)}</td>
          <td class="money">${money(b.chargeback)}</td>
          <td class="money">${money(b.profit)}</td>`;
        tbody.appendChild(tr);
      }
      el('bundleCount').textContent='Computed: '+rows.filter(([,,b])=>!!b).length+' / 3';
    }

    // ---------------- Wire-up ----------------
    el('forceRefresh').onclick=()=>{ clearCache(); loadCSV(); };
    el('clearCache').onclick =()=>{ clearCache(); el('status').textContent=' cache cleared — click Force Refresh to reload'; };
    ['lensFamily','includeAR','includeAspheric','includeOversize','includeGlass','lensTint']
      .forEach(id=> el(id).onchange=computeBundles );

    // Boot
    (async()=>{ await loadCSV(); })();
  </script>
</body>
</html>
