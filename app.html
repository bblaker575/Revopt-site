<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RevSight AI — VSP Choice Tiering (Good/Better/Best by Profit)</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#121822;--border:#2a3444;--text:#e7eefc;--muted:#9fb3d2;--accent:#7aa2ff;--good:#1fbf75;--mid:#f6c343;--best:#9867ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{padding:18px 16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .sub{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
    label{display:flex;align-items:center;gap:8px;margin:8px 0;font-size:14px;color:var(--muted)}
    input[type="checkbox"]{width:18px;height:18px}
    select,button{background:#0f1520;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font:inherit}
    button{cursor:pointer}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .bundle{border-left:4px solid var(--border);padding-left:10px;margin:6px 0}
    .bundle.good{border-color:var(--good)}
    .bundle.mid{border-color:var(--mid)}
    .bundle.best{border-color:var(--best)}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:4px 8px;font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid var(--border)}
    th{color:var(--muted);font-weight:600;text-align:left}
    .right{text-align:right}
    .tag{display:inline-block;padding:2px 6px;border-radius:6px;background:#0e1622;border:1px solid var(--border);font-size:12px;margin-right:6px;color:var(--muted)}
    .ok{color:var(--good)}.warn{color:var(--mid)}.boom{color:var(--best)}
    .foot{opacity:.7;font-size:12px;padding:10px 2px}
    .err{color:#ff7a7a}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>RevSight AI — VSP Choice Profit Engine</h1>
      <div class="sub">Good/Better/Best picks are ranked by <b>profit</b>. Toggles are enforced: OFF = not selected anywhere.</div>
    </div>
    <div class="row" style="align-items:center">
      <span class="pill" id="csvStatus">CSV: not loaded</span>
      <button id="forceRefresh">Recalc</button>
    </div>
  </header>

  <main class="row" style="padding:16px">
    <section class="col card">
      <h3 style="margin-top:0">Inputs</h3>
      <div class="row">
        <div class="col">
          <label>Lens type
            <select id="lensType">
              <option value="SV">Single Vision (SV)</option>
              <option value="MF">Progressive / Multifocal (MF)</option>
            </select>
          </label>
        </div>
        <div class="col">
          <label>Material preference (optional)
            <select id="materialPref">
              <option value="">No preference</option>
              <option value="POLY">Polycarbonate</option>
              <option value="HI_INDEX">High Index</option>
              <option value="PLASTIC">CR-39 / Standard</option>
              <option value="TRIVEX">Trivex</option>
              <option value="GLASS">Glass</option>
              <option value="ASPHERIC">Aspheric</option>
            </select>
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <div class="col">
          <div class="sub" style="margin-bottom:6px">Global Toggles (default states per spec)</div>
          <label><input id="toggleOversize" type="checkbox"> Oversize (default OFF)</label>
          <label><input id="toggleAR" type="checkbox" checked> AR Coating (default ON)</label>
          <label><input id="toggleAspheric" type="checkbox"> Aspheric (default OFF)</label>
          <label><input id="toggleGlass" type="checkbox"> Glass (default OFF)</label>
        </div>
      </div>

      <div class="foot">Note: If a toggle is OFF, that category will be excluded from <i>all</i> bundles and will never appear as a line‑item.</div>
    </section>

    <section class="col card">
      <h3 style="margin-top:0">Recommended Bundles (by profit)</h3>
      <div id="bundles"></div>
    </section>

    <section class="col card">
      <h3 style="margin-top:0">Line‑item Economics</h3>
      <div id="lineItems"></div>
    </section>
  </main>

  <section class="card" style="margin:16px">
    <details>
      <summary>Data/Diagnostics</summary>
      <div id="diag" class="muted" style="white-space:pre-wrap"></div>
    </details>
    <div class="foot">Autoload order: <code>localStorage.snapshot</code> → <code>./vsp_choice_master_v7_full_fixed.csv</code>. If online load succeeds, a fresh offline snapshot is saved automatically.</div>
  </section>

  <script>
    // --- Minimal CSV parser that handles quoted fields (commas within quotes) ---
    function parseCSV(text){
      const rows=[]; let i=0, cur=''; let inQ=false; const push=()=>{ row.push(cur); cur=''; };
      let row=[];
      while(i<text.length){
        const c=text[i++];
        if(c==='"'){
          if(inQ && text[i]==='"'){ cur+='"'; i++; }
          else inQ=!inQ;
        }else if(c===',' && !inQ){ push(); }
        else if((c==='\n' || c==='\r') && !inQ){ if(cur!=='' || row.length){ push(); rows.push(row); row=[]; } }
        else cur+=c;
      }
      if(cur!=='' || row.length){ push(); rows.push(row); }
      // Convert to objects
      const headers = rows.shift().map(h=>h.trim());
      return rows.filter(r=>r.length && r.some(x=>String(x).trim()!=='')).map(r=>{
        const o={}; headers.forEach((h,idx)=>o[h]=r[idx]===undefined?'' : r[idx]); return o;
      });
    }

    // --- Heuristics to locate semantic fields across CSV variants ---
    const Field = {
      category: ["Category","Type","LensType","Family"],
      material: ["Material","LensMaterial","Mat"],
      enhancement: ["Enhancement","AddOn","Option","Feature"],
      arFlag: ["AR","AntiReflective","AR_Included"],
      asphericFlag: ["Aspheric","Asph","AsphericFlag"],
      glassFlag: ["Glass","GlassFlag"],
      oversizeFlag: ["Oversize","OS","OversizeFlag"],
      svFlag: ["SV","SingleVision"], mfFlag: ["MF","Progressive","PAL"],
      desc: ["Description","Desc","Name"],
      qty: ["Qty","Quantity"],
      price: ["OfficePrice","Retail","Charge","UCR","Price"],
      copay: ["PatientCopay","Copay","PtCopay"],
      remb: ["VSPReimbursement","Allowance","VSPPays","InsurancePays"],
      chargeback: ["Chargeback","LabBill","Cost","COGS"],
      profit: ["Profit","OfficeProfit","Net"]
    };
    function pick(obj, keys){ for(const k of keys){ if(k in obj && obj[k]!=="") return obj[k]; } return ""; }

    function computeProfit(row){
      const explicit = pick(row, Field.profit);
      if(explicit!=="") return Number(explicit)||0;
      const copay = Number(pick(row, Field.copay))||0;
      const remb  = Number(pick(row, Field.remb))||0;
      const cb    = Number(pick(row, Field.chargeback))||0;
      const price = Number(pick(row, Field.price))||0;
      // Try common structures in order
      // 1) Profit provided -> handled above
      // 2) (Copay + Reimb - Chargeback)
      let p = copay + remb - cb;
      // 3) If none present, fallback (Retail - Chargeback) or 0
      if(!Number.isFinite(p) || (copay===0 && remb===0 && cb===0)) p = price - cb;
      return Number.isFinite(p) ? p : 0;
    }

    function norm(v){ return String(v||"").trim().toUpperCase(); }

    function flags(row){
      // Accept multiple representations (Yes/No, 1/0, True/False, strings)
      const toBool = (x)=>{ x=String(x||"").trim().toLowerCase(); return x==="1"||x==="y"||x==="yes"||x==="true"; };
      return {
        AR: toBool(pick(row, Field.arFlag)),
        ASPHERIC: toBool(pick(row, Field.asphericFlag)),
        GLASS: toBool(pick(row, Field.glassFlag)),
        OVERSIZE: toBool(pick(row, Field.oversizeFlag))
      };
    }

    function classify(row){
      const ltSV = norm(pick(row, Field.svFlag));
      const ltMF = norm(pick(row, Field.mfFlag));
      let lt = "";
      if(ltSV==="1"||ltSV==="Y"||ltSV==="YES"||ltSV==="TRUE"||ltSV==="SV"||ltSV==="SINGLEVISION") lt="SV";
      if(ltMF==="1"||ltMF==="Y"||ltMF==="YES"||ltMF==="TRUE"||ltMF==="MF"||ltMF==="PROGRESSIVE"||ltMF==="PAL") lt="MF";
      if(!lt){ const cat = norm(pick(row, Field.category)); if(cat.includes("SV")) lt="SV"; if(cat.includes("PROG")||cat.includes("PAL")||cat.includes("MF")) lt="MF"; }
      return {
        lensType: lt||"",
        material: norm(pick(row, Field.material)),
        enhancement: norm(pick(row, Field.enhancement)),
        desc: pick(row, Field.desc) || pick(row,["Item","SKU"]) || "",
        profit: computeProfit(row),
        raw: row,
        f: flags(row)
      };
    }

    function byProfitDesc(a,b){ return b.profit - a.profit; }

    function buildUniverse(rows){
      return rows.map(classify).filter(r=>Number.isFinite(r.profit));
    }

    function applyGlobalToggles(items, toggles){
      // Exclude any line-items that conflict with toggles, at selection time.
      return items.filter(it=>{
        if(!toggles.AR && (it.enhancement.includes("AR") || it.f.AR)) return false;
        if(!toggles.ASPHERIC && (it.material.includes("ASPHERIC") || it.f.ASPHERIC)) return false;
        if(!toggles.GLASS && (it.material.includes("GLASS") || it.f.GLASS)) return false;
        if(!toggles.OVERSIZE && (it.enhancement.includes("OVERSIZE") || it.f.OVERSIZE)) return false;
        return true;
      });
    }

    function pickBundles(universe, lensType, materialPref, toggles){
      const pool = applyGlobalToggles(universe.filter(u=>!lensType || u.lensType===lensType), toggles);

      // Split by materials and enhancements for combinatorics
      const materials = pool.filter(x=>x.material).reduce((m,x)=>{ (m[x.material]??=[]).push(x); return m; },{});
      const enhancements = pool.filter(x=>x.enhancement).reduce((m,x)=>{ (m[x.enhancement]??=[]).push(x); return m; },{});

      // Define allowable base materials set based on toggles
      const disallowed = new Set();
      if(!toggles.ASPHERIC) disallowed.add("ASPHERIC");
      if(!toggles.GLASS) disallowed.add("GLASS");

      const materialKeys = Object.keys(materials).filter(k=>!disallowed.has(k));
      // If preference is set, prefer that material but still compute ranks globally for mid pick
      const baseCandidates = (materialPref && materialKeys.includes(materialPref)) ? [materialPref] : materialKeys;

      // Construct candidate bundles: one base material + optional AR + optional Oversize (if toggles on)
      function topBy(arr){ return [...arr].sort(byProfitDesc)[0]; }
      const arTop = toggles.AR && enhancements["AR"] ? topBy(enhancements["AR"]) : null;
      const oversizeTop = toggles.OVERSIZE && enhancements["OVERSIZE"] ? topBy(enhancements["OVERSIZE"]) : null;

      const bundles = [];
      for(const mat of materialKeys){
        const base = topBy(materials[mat]||[]); if(!base) continue;
        // Build a bundle with strictly one base material + permitted enhancements
        const parts = [base];
        if(arTop) parts.push(arTop);
        if(oversizeTop) parts.push(oversizeTop);
        // Profit is sum of distinct line‑items (avoid duplicates)
        const seen = new Set();
        let profit = 0; const lines=[];
        for(const p of parts){
          const key = (p.material||"")+"|"+(p.enhancement||"")+"|"+p.desc;
          if(seen.has(key)) continue; seen.add(key);
          lines.push(p);
          profit += p.profit;
        }
        bundles.push({ material:mat, parts:lines, profit });
      }

      // Rank bundles by profit
      bundles.sort((a,b)=>b.profit-a.profit);
      // Ensure unique materials for good/mid/best (no duplicate materials)
      const uniq=[]; const seenMat=new Set();
      for(const b of bundles){ if(!seenMat.has(b.material)){ uniq.push(b); seenMat.add(b.material);} }

      const best = uniq[0];
      const mid  = uniq[1] || uniq[0];
      const good = uniq[uniq.length-1] || uniq[0];

      // If materialPref provided, try to align mid with 2nd best overall even if different material; best remains top profit.
      return { good, mid, best, poolSize:bundles.length };
    }

    function fmtCurrency(n){ return n==null?"—": "$"+ (Number(n).toFixed(2)); }

    function renderBundles(picks){
      const el = document.getElementById('bundles');
      if(!picks || !picks.best){ el.innerHTML = '<div class="muted">No bundles available with current filters.</div>'; return; }
      const make = (b,cls,label)=>{
        if(!b) return `<div class="bundle ${cls}"><div class="muted">No ${label} bundle available</div></div>`;
        const rows = b.parts.map(p=>`<tr><td>${p.desc || (p.material||p.enhancement)}</td><td class="right">${fmtCurrency(p.profit)}</td></tr>`).join('');
        return `<div class="bundle ${cls}">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div class="tag">${label}</div>
            <div class="tag">Material: ${b.material||'—'}</div>
            <div class="tag">Bundle Profit: ${fmtCurrency(b.profit)}</div>
          </div>
          <table><thead><tr><th>Line Item</th><th class="right">Profit</th></tr></thead><tbody>${rows}</tbody></table>
        </div>`;
      };
      el.innerHTML = make(picks.good,'good','Good') + make(picks.mid,'mid','Mid') + make(picks.best,'best','Best');
    }

    function renderLineItems(universe, lensType){
      const el = document.getElementById('lineItems');
      const list = universe.filter(u=>!lensType || u.lensType===lensType).sort(byProfitDesc).slice(0,100);
      if(!list.length){ el.innerHTML = '<div class="muted">No items.</div>'; return; }
      el.innerHTML = `<table><thead><tr><th>Type</th><th>Material</th><th>Enhancement</th><th>Description</th><th class="right">Profit</th></tr></thead><tbody>
      ${list.map(r=>`<tr><td>${r.lensType||'—'}</td><td>${r.material||'—'}</td><td>${r.enhancement||'—'}</td><td>${r.desc||''}</td><td class="right">${fmtCurrency(r.profit)}</td></tr>`).join('')}
      </tbody></table>`;
    }

    function saveSnapshot(csvText){ try{ localStorage.setItem('vsp_choice_snapshot_v7', csvText); }catch(e){} }
    function loadSnapshot(){ try{ return localStorage.getItem('vsp_choice_snapshot_v7'); }catch(e){ return null; } }

    async function loadCSV(){
      const badge = document.getElementById('csvStatus');
      // 1) Offline snapshot first
      const snap = loadSnapshot();
      if(snap){
        badge.textContent = 'CSV: offline snapshot';
        badge.style.borderColor = '#3c6';
        return parseCSV(snap);
      }
      // 2) Try same-origin file
      try{
        const resp = await fetch('./vsp_choice_master_v7_full_fixed.csv', {cache:'no-store'});
        if(resp.ok){
          const text = await resp.text();
          saveSnapshot(text);
          badge.textContent = 'CSV: loaded from /vsp_choice_master_v7_full_fixed.csv';
          badge.style.borderColor = '#6cf';
          return parseCSV(text);
        }
      }catch(err){ /* fallthrough */ }
      badge.textContent = 'CSV: not found';
      badge.style.borderColor = '#f66';
      return [];
    }

    let UNIVERSE = [];

    async function recalc(){
      const lensType = document.getElementById('lensType').value;
      const materialPref = document.getElementById('materialPref').value;
      const toggles = {
        OVERSIZE: document.getElementById('toggleOversize').checked,
        AR: document.getElementById('toggleAR').checked,
        ASPHERIC: document.getElementById('toggleAspheric').checked,
        GLASS: document.getElementById('toggleGlass').checked,
      };

      const picks = pickBundles(UNIVERSE, lensType, materialPref, toggles);
      renderBundles(picks);
      renderLineItems(UNIVERSE, lensType);

      // Diagnostics
      const diag = document.getElementById('diag');
      diag.textContent = JSON.stringify({ lensType, materialPref, toggles, universe: UNIVERSE.length, poolCandidates: picks.poolSize }, null, 2);
    }

    (async function init(){
      const raw = await loadCSV();
      UNIVERSE = buildUniverse(raw);
      document.getElementById('forceRefresh').addEventListener('click', recalc);
      document.getElementById('lensType').addEventListener('change', recalc);
      document.getElementById('materialPref').addEventListener('change', recalc);
      document.getElementById('toggleOversize').addEventListener('change', recalc);
      document.getElementById('toggleAR').addEventListener('change', recalc);
      document.getElementById('toggleAspheric').addEventListener('change', recalc);
      document.getElementById('toggleGlass').addEventListener('change', recalc);
      recalc();
    })();
  </script>
</body>
</html>
