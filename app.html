<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RevSight AI — VSP Choice Bundles</title>
  <style>
    :root{--bg:#0b0f14;--fg:#e7eefc;--muted:#9fb0c9;--card:#101722;--line:#233044}
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--line)}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px}
    main{padding:16px}
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:0 0 14px}
    .btn{background:#132034;border:1px solid var(--line);color:var(--fg);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#16263c}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{accent-color:#4f9cff}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px dashed #213043;padding:8px 6px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .badge{font-size:11px;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
    .good{border-color:#35506e}.better{border-color:#7c5c19}.best{border-color:#0f6a52}
    .money{font-weight:700}.nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>RevSight AI — VSP Choice Bundles</h1>
      <div class="sub">Good/Better/Best ranked by <b>practice profit</b>. AR default <b>ON</b>. Polarized/Transitions are <b>add-ons</b>, not base materials.</div>
    </div>
    <div class="sub" id="version">loading…</div>
  </header>

  <main>
    <div class="bar">
      <button class="btn" id="forceRefresh">Force Refresh</button>
      <button class="btn" id="clearLocal">Clear Local Cache</button>

      <label class="switch">Lens family
        <select id="lensFamily" class="input">
          <option value="SV">Single Vision</option>
          <option value="LINED">Lined Bi/Tri</option>
          <option value="PAL">Progressive</option>
        </select>
      </label>

      <label class="switch"><input type="checkbox" id="includeAR" checked> Include AR</label>
      <label class="switch"><input type="checkbox" id="includeAspheric"> Aspheric</label>
      <label class="switch"><input type="checkbox" id="includeOversize"> Oversize</label>
      <label class="switch"><input type="checkbox" id="includeGlass"> Glass</label>
      <label class="switch"><input type="checkbox" id="addTransitions"> Add Transitions®</label>
      <label class="switch"><input type="checkbox" id="addPolarized"> Add Polarized</label>
      <span class="sub" id="status"></span>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="sub">Computed Bundles</div>
        <div class="sub" id="bundleCount">—</div>
      </div>
      <table id="bundleTable">
        <thead>
          <tr>
            <th>Tier</th>
            <th>Material</th>
            <th>Add-ons</th>
            <th class="nowrap">Patient Copay</th>
            <th class="nowrap">Chargeback</th>
            <th class="nowrap">Profit</th>
            <th class="nowrap">Profit/Copay</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    // ---- Config ----
    const DEFAULT_CSV = 'data/vsp_choice_master_v7.csv';

    // ---- Utils ----
    const $ = (id)=>document.getElementById(id);
    const sum = (a)=>a.reduce((x,y)=>x+y,0);
    const money = (v)=>`$${v.toFixed(2)}`;
    const num = (v)=>{ const x=parseFloat(String(v??'').toString().replace(/[^0-9.\-]/g,'')); return isFinite(x)?x:0; };
    const hash=(s)=>{ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0; } return ('00000000'+h.toString(16)).slice(-8); };

    // Robust CSV parser (quoted fields)
    function parseCSV(text){
      const out=[], row=[], push=()=>{ out.push(row.splice(0)); };
      let f='', q=false, r=[];
      for(let i=0;i<text.length;i++){
        const c=text[i];
        if(c==='\"'){ q=!q; f+=c; continue; }
        if(!q && c===','){ r.push(f); f=''; continue; }
        if(!q && (c==='\n' || c==='\r')){ if(f!==''||r.length){ r.push(f); out.push(r); r=[]; f=''; } continue; }
        f+=c;
      }
      if(f!==''||r.length){ r.push(f); out.push(r); }
      const headers = out.shift().map(h=>h.replace(/^\"|\"$/g,'').trim());
      return out.filter(r=>r.length>=headers.length).map(r=>{
        const o={}; headers.forEach((h,i)=> o[h]=(r[i]||'').replace(/^\"|\"$/g,'').trim() ); return o;
      });
    }

    // Local cache
    const CK='vsp-choice-csv', MK='vsp-choice-meta';
    const setCache=(t,m)=>{ localStorage.setItem(CK,t); localStorage.setItem(MK,JSON.stringify(m)); };
    const getCache=()=>({ text: localStorage.getItem(CK), meta: JSON.parse(localStorage.getItem(MK)||'{}') });
    const clearCache=()=>{ localStorage.removeItem(CK); localStorage.removeItem(MK); $('status').textContent=' cache cleared'; };

    // ---- Data store ----
    let ROWS=[];      // normalized rows

    // Normalize a raw CSV row so matching is bulletproof
    function norm(r){
      const lower = (x)=> String(x||'').toLowerCase().trim();
      const ek = lower(r.exclusive_key);
      const grp = lower(r.group);
      const enh = (r.enhancement||'').trim();
      const subtype = (r.subtype||'').trim();
      const code = (r.code||'').trim();
      const applies = String(r.applies_to||'').toUpperCase().split(/[|,\/\s]+/).filter(Boolean);
      return {
        group: grp,
        subtype, enhancement: enh, code,
        copay: num(r.copay), chargeback: num(r.chargeback),
        exclusive_key: ek,
        applies_to_tokens: applies,
        active: String(r.active||'yes').toLowerCase().startsWith('y')
      };
    }

    function appliesToFamily(row, fam){
      if(!row.applies_to_tokens.length) return true;
      if(fam==='LINED') return row.applies_to_tokens.some(t=> t==='LINED' || t==='OCC' || t==='BF' || t==='BIFOCAL');
      return row.applies_to_tokens.includes(fam);
    }

    function byExclusive(key){ // tolerant to whitespace/case
      key = key.toLowerCase().trim();
      return ROWS.filter(r=>r.active && r.exclusive_key===key);
    }

    function byExclusiveAny(keys){ // first match among a set
      const S = new Set(keys.map(k=>k.toLowerCase().trim()));
      return ROWS.filter(r=>r.active && S.has(r.exclusive_key));
    }

    function loadCounts(fam){
      const mats = byExclusive('material').filter(r=>appliesToFamily(r,fam));
      const ars  = byExclusive('ar').filter(r=>appliesToFamily(r,fam));
      const pals = byExclusive('progressive').filter(r=>appliesToFamily(r,fam));
      const lins = byExclusive('lined').filter(r=>appliesToFamily(r,fam));
      const trans= byExclusiveAny(['photochromic','transitions']).filter(r=>appliesToFamily(r,fam));
      const pol  = byExclusive('polarized').filter(r=>appliesToFamily(r,fam));
      const over = byExclusive('oversize').filter(r=>appliesToFamily(r,fam));
      return {mats, ars, pals, lins, trans, pol, over};
    }

    function pickBestProfit(rows){
      if(!rows.length) return null;
      // Highest (copay - chargeback). If tie, prefer lower chargeback then nicer name.
      return rows.slice().sort((a,b)=>{
        const pa=(a.copay-a.chargeback), pb=(b.copay-b.chargeback);
        if(pb!==pa) return pb-pa;
        if(a.chargeback!==b.chargeback) return a.chargeback-b.chargeback;
        return (a.enhancement||a.subtype||a.code).localeCompare(b.enhancement||b.subtype||b.code);
      })[0];
    }

    function compute(){
      if(!ROWS.length){ $('bundleTable').querySelector('tbody').innerHTML=''; return; }

      const fam = $('lensFamily').value;
      const wantAR = $('includeAR').checked;
      const wantAsp = $('includeAspheric').checked;
      const wantOS  = $('includeOversize').checked;
      const wantGlass = $('includeGlass').checked;
      const addTR = $('addTransitions').checked;
      const addPO = $('addPolarized').checked;

      const {mats, ars, pals, lins, trans, pol, over} = loadCounts(fam);

      // Base materials (exclude Polarized/Transitions as base, and respect aspheric/glass toggles)
      const materials = mats.filter(m=>{
        const n = (m.enhancement||'').toLowerCase();
        if(n.includes('polarized') || n.includes('transition')) return false;
        if(!wantAsp && /aspheric/i.test(n)) return false;
        if(!wantGlass && /glass/i.test(n)) return false;
        return true;
      });

      // Pick the best add-on (by profit) in each category if selected
      const selAR  = wantAR ? pickBestProfit(ars)   : null;
      const selPAL = fam==='PAL'   ? pickBestProfit(pals) : null;
      const selLIN = fam==='LINED' ? pickBestProfit(lins) : null;
      const selTR  = addTR ? pickBestProfit(trans) : null;
      const selPO  = addPO ? pickBestProfit(pol)   : null;
      const selOS  = wantOS? pickBestProfit(over)  : null;

      const bundles = materials.map(m=>{
        const items = [m];
        if(selAR)  items.push(selAR);
        if(selPAL) items.push(selPAL);
        if(selLIN) items.push(selLIN);
        if(selTR)  items.push(selTR);
        if(selPO)  items.push(selPO);
        if(selOS)  items.push(selOS);
        const cop = sum(items.map(x=>x.copay));
        const cb  = sum(items.map(x=>x.chargeback));
        const pr  = cop - cb;
        return {
          material: m.enhancement || m.subtype || m.code,
          addOns: items.filter(i=>i!==m),
          copay: cop, chargeback: cb, profit: pr,
          ratio: cop>0 ? (pr/cop) : (pr>0?Infinity:0)
        };
      });

      // Good/Better/Best
      const byProfit = bundles.slice().sort((a,b)=>b.profit-a.profit);
      const byCopay  = bundles.slice().sort((a,b)=>a.copay-b.copay);
      const best  = byProfit[0] || null;
      const mid   = byProfit.find(b => best && b.material!==best.material) || byProfit[1] || null;
      const good  = byCopay[0] || null;

      // Render
      const tbody = $('bundleTable').querySelector('tbody'); tbody.innerHTML='';
      const rows = [['Good','good',good],['Better','better',mid],['Best','best',best]];
      for(const [name, cls, b] of rows){
        const tr = document.createElement('tr');
        if(!b){ tr.innerHTML = `<td>${name}</td><td colspan="6" class="sub">no viable bundle</td>`; tbody.appendChild(tr); continue; }
        const addBadges = b.addOns.map(a=>`<span class="badge">${a.enhancement||a.subtype||a.code}</span>`).join(' ');
        tr.innerHTML = `
          <td><span class="badge ${cls}">${name}</span></td>
          <td>${b.material}</td>
          <td>${addBadges||''}</td>
          <td class="money">${money(b.copay)}</td>
          <td class="money">${money(b.chargeback)}</td>
          <td class="money">${money(b.profit)}</td>
          <td>${(b.ratio===Infinity?'∞':b.ratio.toFixed(2))}</td>`;
        tbody.appendChild(tr);
      }
      $('bundleCount').textContent = 'Computed: '+rows.filter(r=>r[2]).length+' / 3';
    }

    async function boot(){
      $('status').textContent=' loading…';
      try{
        const res = await fetch(DEFAULT_CSV,{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const txt = await res.text();
        const meta = { plan:'VSP_choice', version:new Date().toISOString().slice(0,10)+'.gbb', source:'network:'+DEFAULT_CSV, sha:hash(txt) };
        setCache(txt, meta);
        const raw = parseCSV(txt);
        ROWS = raw.map(norm);          // << normalization fixes toggle issues
        $('version').textContent = `plan=${meta.plan} • version=${meta.version} • source=${meta.source} • sha=${meta.sha}`;
        $('status').textContent = ` [ok] loaded ${ROWS.length} rows`;
        compute();
      }catch(e){
        $('status').textContent=' load failed: '+e.message;
      }
    }

    // Wire-up
    $('forceRefresh').onclick = ()=>{ clearCache(); boot(); };
    $('clearLocal').onclick   = ()=> clearCache();
    ['lensFamily','includeAR','includeAspheric','includeOversize','includeGlass','addTransitions','addPolarized']
      .forEach(id=> $(id).onchange = compute);

    boot(); // start
  </script>
</body>
</html>
