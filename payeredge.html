<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PayerEdge — VSP Bundles</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#090e16;--bg-elev:#0c1320;--fg:#eaf1ff;--muted:#9fb0c9;--line:#263448;--accent:#72a8ff;--accent-2:#7be0c3;
      --tier-best:#ffd166;--tier-better:#a9c2ff;--tier-good:#7be0c3;
      --shadow-lg:0 18px 40px rgba(0,0,0,.35);--shadow-md:0 10px 26px rgba(0,0,0,.28);
      --radius:18px;--radius-sm:12px;
      --fz-11:11px;--fz-12:12px;--fz-13:13px;--fz-14:14px;--fz-15:15px;--fz-18:18px;--fz-20:20px;--fz-36:36px;
      --min-scale:0.82;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:
        radial-gradient(1200px 600px at 20% -10%, rgba(90,168,255,.12), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(123,224,195,.10), transparent 60%),
        var(--bg);
      color:var(--fg);font:var(--fz-15)/1.45 Inter,system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-variant-numeric:tabular-nums
    }
    header{
      position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:center;gap:14px;padding:10px 14px;
      background:linear-gradient(180deg, rgba(9,14,22,.95), rgba(9,14,22,.78));
      border-bottom:1px solid var(--line);backdrop-filter:blur(10px)
    }
    h1{margin:0;font-weight:800;font-size:clamp(16px,1.8vw,20px);letter-spacing:.2px}
    .sub{color:var(--muted);font-size:var(--fz-12)}
    .version{color:var(--muted)}
    main{padding:12px}

    .bar{
      display:flex;align-items:center;flex-wrap:wrap;gap:10px 12px;
      background:linear-gradient(180deg,var(--bg-elev),#0b1220);
      border:1px solid var(--line);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow-md)
    }
    .group{display:flex;gap:8px;align-items:center;padding:6px 8px;border-radius:999px;background:#0b1424}
    .btn{background:#121f35;border:1px solid var(--line);color:var(--fg);padding:6px 9px;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;transition:.15s}
    .btn:hover{background:#162844;border-color:#2e4260}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch select,.switch input[type="checkbox"]{accent-color:var(--accent)}
    select{background:#0e1a30;color:#fff;border:1px solid var(--line);border-radius:10px;padding:6px 8px;outline:none}
    select:focus{box-shadow:0 0 0 3px rgba(114,168,255,.25)}
    #status{margin-left:auto;padding:6px 10px;border-radius:999px;border:1px dashed var(--line);background:#0b1422;color:#c7d6ef;font-size:var(--fz-12);max-width:52vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .viewport-frame{transform-origin:top left;width:100%}
    .stack{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px;align-items:stretch;margin-top:12px;overflow:visible;min-width:0}

    .tier{background:linear-gradient(180deg,#0f1726,#0c1422);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:12px;min-width:0}
    .tier[data-invalid="1"]{outline:2px solid #ff6b6b}
    .tierHead{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;margin-bottom:8px;min-width:0}
    .stars{font-weight:800;display:flex;align-items:center;gap:8px;min-width:0}
    .stars .tag{font-size:var(--fz-12);color:var(--muted);padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0c1424;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .stars.best{color:var(--tier-best)} .stars.better{color:var(--tier-better)} .stars.good{color:var(--tier-good)}
    .figures{text-align:right;display:grid;gap:2px}
    .hero{font-size:clamp(22px,2.8vw,36px);font-weight:800;line-height:1.0;letter-spacing:.2px;color:#cfe6ff;text-shadow:0 6px 18px rgba(114,168,255,.18)}
    .caption{color:var(--muted);font-size:var(--fz-12)}
    .svc{font-weight:800;color:var(--accent-2)}

    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    th,td{border-bottom:1px dashed #203043;padding:7px 6px;text-align:left;font-size:var(--fz-12);vertical-align:top}
    th{color:var(--muted);font-weight:700}
    .cell-item{word-break:keep-all;hyphens:none;overflow-wrap:break-word}
    .cell-code{white-space:nowrap}
    .cell-money{white-space:nowrap;font-weight:800;font-size:clamp(11px,1.1vw,13px)}
    .cell-label{white-space:nowrap}

    .break{margin:6px 0 8px;background:#0b1424;border:1px solid var(--line);border-radius:10px}
    .break .grid{display:grid;grid-template-columns:1fr repeat(3,minmax(0,0.9fr));gap:6px 8px;padding:8px;align-items:center}
    .break .hdr{color:var(--muted);font-weight:600;font-size:11px}
    .codepill{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border:1px solid var(--line);border-radius:999px;
      font-family:ui-monospace,Menlo,Consolas,monospace;font-size:11px;color:#cfe1ff;background:#0e1a30;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:34px}
    .break .money{white-space:nowrap;font-weight:800;font-size:clamp(10px,1vw,12px)}

    @media (max-width:1280px){.stack{gap:12px}.tier{padding:10px}.hero{font-size:clamp(20px,2.5vw,32px)}}
    @media (max-width:1080px){.tier{padding:9px;border-radius:14px}.hero{font-size:clamp(18px,2.2vw,28px)}}
    @media (max-width:900px){th,td{padding:6px 5px}.hero{font-size:clamp(16px,2.0vw,24px)}}

    :focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:8px}
    @media print{header,.bar{display:none} body{background:#fff;color:#000}.tier{break-inside:avoid;border:1px solid #000;box-shadow:none} table,th,td{border-color:#000}}
  </style>
</head>
<body>
<header>
  <div>
    <h1>PayerEdge — VSP Bundles</h1>
    <div class="sub">Scoreboard shows <b>patient copay</b> and <b>service fee</b> (Copay − Holdback). Sun choices are exclusive.</div>
  </div>
  <div class="version sub" id="version">loading…</div>
</header>

<main>
  <div class="bar" role="toolbar" aria-label="Bundle controls">
    <div class="group">
      <button class="btn" id="forceRefresh">Force Refresh</button>
      <button class="btn" id="clearCache">Clear Cache</button>
    </div>
    <div class="group">
      <label class="switch">Lens family
        <select id="lensFamily" aria-label="Lens family">
          <option value="SV" selected>Single Vision</option>
          <option value="LINED">Lined Bi/Tri</option>
          <option value="PAL">Progressive</option>
        </select>
      </label>
      <label class="switch">Lens tint
        <select id="lensTint" aria-label="Lens tint">
          <option value="clear" selected>Clear</option>
          <option value="tinted_solid">Tinted — Solid</option>
          <option value="tinted_gradient">Tinted — Gradient</option>
          <option value="polarized">Polarized</option>
          <option value="transitions">Transitions®</option>
        </select>
      </label>
    </div>
    <div class="group">
      <label class="switch"><input type="checkbox" id="includeAR" checked> Include AR (tiered)</label>
      <label class="switch"><input type="checkbox" id="includeAspheric"> Aspheric</label>
      <label class="switch"><input type="checkbox" id="includeOversize"> Oversize</label>
      <label class="switch"><input type="checkbox" id="includeGlass"> Glass</label>
      <label class="switch"><input type="checkbox" id="includeCM"> Custom measurements (N/O only)</label>
    </div>
    <span id="status" aria-live="polite" title=""></span>
  </div>

  <div id="frame" class="viewport-frame">
    <div id="stack" class="stack"></div>
  </div>
</main>

<script>
/* ========================== PRICING-STRICT UI ========================== */
if(!window.__PAYEREDGE_STRICT_V1__){
  window.__PAYEREDGE_STRICT_V1__=true;

  /* ----- toggles ----- */
  const STRICT_PRICING = true;     // reject any bundle that can’t be proven from CSV
  const SHOW_INVALID   = false;    // if true, cards with mismatch outline in red (debug)
  const CSV_CANDIDATES=['./vsp_choice_master_v8.4.csv','./data/vsp_choice_master_v8.4.csv'];

  /* ----- helpers ----- */
  const el=id=>document.getElementById(id);
  const sum=a=>a.reduce((x,y)=>x+y,0);
  const num=v=>{ const x=parseFloat(String(v??'').replace(/[^0-9.-]/g,'')); return isFinite(x)?x:0; };
  const quickHash=s=>{ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0; } return ('00000000'+h.toString(16)).slice(-8); };
  const N=s=>String(s||'').toLowerCase();
  const splitCodes=s=>String(s||'').toUpperCase().replace(/[^\w+&/,\s-]/g,'').split(/[\s+&/,\-]+/).map(t=>t.trim()).filter(Boolean);
  const parseCopayNumbers=s=>{ const m=String(s||'').match(/[0-9]+(?:\.[0-9]{1,2})?/g); return m?m.map(x=>parseFloat(x)):[]; };

  let DATA=[], SIMPLE_BY_CODE=new Map();
  function buildSimpleIndex(){
    SIMPLE_BY_CODE.clear();
    for(const r of DATA){
      const parts=splitCodes(r.code);
      if(parts.length===1){
        const c=parts[0];
        if(!SIMPLE_BY_CODE.has(c)) SIMPLE_BY_CODE.set(c,[]);
        SIMPLE_BY_CODE.get(c).push(r);
      }
    }
  }
  function applies(row,fam){
    const a=(row.applies_to||'ALL').toUpperCase();
    if(a.includes('ALL')) return true;
    if(fam==='SV') return a.includes('SV');
    if(fam==='LINED') return a.includes('OCC');
    if(fam==='PAL') return a.includes('MF');
    return true;
  }
  function chooseVariantForFamily(rows,fam){
    if(!rows||!rows.length) return null;
    if(rows.length===1) return rows[0];
    const sorted=[...rows].sort((a,b)=>num(a.copay)-num(b.copay));
    return fam==='PAL'?sorted[sorted.length-1]:sorted[0];
  }
  function pickByCode(code){
    const fam=el('lensFamily').value;
    const wantGlass=el('includeGlass').checked;
    const list=(SIMPLE_BY_CODE.get(code)||[])
      .filter(r=>applies(r,fam))
      .filter(r=> wantGlass ? true : !/glass/i.test(r.enhancement||r.subtype||''));
    return chooseVariantForFamily(list,fam);
  }
  function inferProgressiveBaseCodeFromDesc(desc){
    const s=N(desc||'');
    if(/^progressive\s+n\b/.test(s)) return 'NA';
    if(/^progressive\s+o\b/.test(s)) return 'OA';
    if(/^progressive\s+f\b/.test(s)) return 'FA';
    if(/^progressive\s+j\b/.test(s)) return 'JA';
    if(/^progressive\s+k\b/.test(s)) return 'KA';
    return null;
  }
  function parseSplitFromNotes(notes,fam){
    const s=String(notes||'');
    const sv=s.match(/(\d+)\s*\+\s*(\d+)\s*\(SV\)/i);
    const mf=s.match(/(\d+)\s*\+\s*(\d+)\s*\(MF\)/i);
    const plain=(!sv && !mf) ? s.match(/(\d+)\s*\+\s*(\d+)/) : null;
    const svBase=sv?+sv[1]:null, svAdd=sv?+sv[2]:null;
    const mfBase=mf?+mf[1]:null, mfAdd=mf?+mf[2]:null;
    if(fam==='PAL' && !mf && plain) return {svBase,svAdd,mfBase:+plain[1],mfAdd:+plain[2]};
    if(!sv && !mf && plain)       return {svBase:+plain[1],svAdd:+plain[2],mfBase,mfAdd};
    return {svBase,svAdd,mfBase,mfAdd};
  }

  const CACHE_KEY='rev-vsp-choice-csv-v1', META_KEY='rev-vsp-choice-meta-v1';
  const setCache=(t,m)=>{ localStorage.setItem(CACHE_KEY,t); localStorage.setItem(META_KEY,JSON.stringify(m)); };
  const getCache=()=>({ text:localStorage.getItem(CACHE_KEY), meta: JSON.parse(localStorage.getItem(META_KEY)||'{}') });

  async function tryFetch(url){
    try{ const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); return {ok:true,text:await res.text(),url}; }
    catch(e){ return {ok:false,err:String(e),url}; }
  }
  function parseCSV(text){
    const rows=[]; let row=[], field='', q=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i];
      if(ch==='\"'){ if(q && text[i+1]==='\"'){ field+='\"'; i++; } else { q=!q; } continue; }
      if(!q && ch===','){ row.push(field); field=''; continue; }
      if(!q && (ch==='\n'||ch==='\r')){ if(field!==''||row.length){ row.push(field); rows.push(row); row=[]; field=''; } continue; }
      field+=ch;
    }
    if(field!==''||row.length){ row.push(field); rows.push(row); }
    const headers=rows.shift().map(h=>h.replace(/^\"|\"$/g,'').trim());
    return rows.filter(r=>r.length>=headers.length).map(r=>{ const o={}; headers.forEach((h,i)=>o[h]=(r[i]||'').replace(/^\"|\"$/g,'').trim()); return o; });
  }
  function renderMeta(count,meta){
    el('version').textContent=`plan=${meta.plan||'VSP_choice'} • rows=${count||0} • version=${meta.version||'—'} • source=${meta.source||'—'} • sha=${meta.sha||'—'}`;
  }

  /* ---------- UI helpers ---------- */
  const tdMoney=v=>`<td class="cell-money">$${v.toFixed(2)}</td>`;
  function breakdownGrid(parts){
    if(!parts?.length) return '';
    const rows = parts.map(p => `
      <div class="codepill" title="${p.code}">${p.code}</div>
      <div class="money">$${p.copay.toFixed(2)}</div>
      <div class="money">$${p.chargeback.toFixed(2)}</div>
      <div class="money">$${p.profit.toFixed(2)}</div>
    `).join('');
    return `<div class="break"><div class="grid">
      <div class="hdr">Code</div><div class="hdr">Copay</div><div class="hdr">Holdback</div><div class="hdr">Service Fee</div>
      ${rows}
    </div></div>`;
  }
  function renderTier({name,cls,b,invalid}){
    const div=document.createElement('div'); div.className='tier';
    if(invalid && !SHOW_INVALID) return null;
    if(invalid && SHOW_INVALID) div.setAttribute('data-invalid','1');

    if(!b){
      div.innerHTML=`<div class="tierHead"><div class="stars ${cls}"><span class="tag">${name}</span></div>
        <div class="figures"><div class="hero">—</div><div class="caption">Patient Copay</div></div></div><div class="sub">No viable bundle</div>`;
      return div;
    }
    const stars=name==='Best'?'★★★':name==='Better'?'★★':name==='Good'?'★':'◎';
    const head=`<div class="tierHead">
      <div class="stars ${cls}"><div aria-label="${name}" title="${name}" style="font-size:18px">${stars}</div><span class="tag">${b.label}</span></div>
      <div class="figures"><div class="hero" data-prev="0">$${b.copay.toFixed(2)}</div>
      <div class="caption">Patient Copay</div><div class="caption">Service Fee (Practice Profit): <span class="svc">$${b.profit.toFixed(2)}</span></div></div></div>`;

    const lines=b.lines.map(li=>{
      const main=`<tr><td class="cell-item">${li.name}</td><td class="cell-code">${li.code||'—'}</td>
        ${tdMoney(li.copay)}${tdMoney(li.chargeback)}${tdMoney(li.profit)}</tr>`;
      const parts=breakdownGrid(li.parts);
      return main + (parts?`<tr><td colspan="5">${parts}</td></tr>`:'');
    }).join('');

    div.innerHTML=head+`<table>
      <colgroup><col style="width:42%"><col style="width:12%"><col style="width:15%"><col style="width:15%"><col style="width:16%"></colgroup>
      <thead><tr><th class="cell-label">Item</th><th class="cell-label">Code</th><th class="cell-label">Copay</th><th class="cell-label">Holdback</th><th class="cell-label">Service Fee</th></tr></thead>
      <tbody>${lines}</tbody>
      <tfoot><tr><th colspan="2" style="text-align:right">Totals</th>${tdMoney(b.copay)}${tdMoney(b.chargeback)}${tdMoney(b.profit)}</tr></tfoot>
    </table>`;
    return div;
  }
  function fitText(el,{min=10,max=36,step=0.4}={}){
    if(!el) return; el.style.fontSize='';
    const maxPx=Math.min(max,parseFloat(getComputedStyle(el).fontSize)||max);
    let size=maxPx;
    const parent=el.parentElement; if(!parent) return;
    const fits=()=>el.scrollWidth<=parent.clientWidth;
    while(size>min && !fits()){ size-=step; el.style.fontSize=size+'px'; }
  }
  function fitTextAll(){
    document.querySelectorAll('.hero').forEach(n=>fitText(n,{min:14,max:36}));
    document.querySelectorAll('.tierHead .tag').forEach(n=>fitText(n,{min:9,max:13}));
  }
  function fitViewportScale(){
    const frame=document.getElementById('frame');
    const CARD_MIN=360, GAP=14*3;
    const needed=CARD_MIN*4+GAP;
    const vw=document.documentElement.clientWidth;
    let scale=Math.min(1,vw/needed);
    const minScale=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--min-scale'))||0.82;
    if(scale<minScale) scale=minScale;
    frame.style.transform=`scale(${scale})`;
    frame.style.width=(100/scale)+'%';
  }
  const ro=new ResizeObserver(()=>{ fitTextAll(); fitViewportScale(); });
  ro.observe(document.body);

  /* ---------- pricing engine ---------- */
  function isPAL(){ return el('lensFamily').value==='PAL'; }

  function resolveSingle(code){
    // exact code → row for family/glass filters
    const row=pickByCode(code);
    if(!row) return null;
    return {
      name: row.enhancement||row.subtype||'',
      code: code,
      copay: num(row.copay),
      chargeback: num(row.chargeback),
      profit: num(row.copay)-num(row.chargeback),
      raw: row
    };
  }

  function buildCompositeFromNotes(baseCode, addonCode, row){
    // use notes “copay = A + B (SV/MF)” strictly
    const fam=el('lensFamily').value;
    const {svBase,svAdd,mfBase,mfAdd}=parseSplitFromNotes(row.notes,fam);
    const baseCop = fam==='PAL' ? mfBase : svBase;
    const addCop  = fam==='PAL' ? mfAdd  : svAdd;
    if(baseCop==null || addCop==null) return null;

    const baseRow=resolveSingle(baseCode);
    const addRow =resolveSingle(addonCode);
    if(!baseRow || !addRow) return null;

    // override copay with note split; holdback/service from rows
    const partA={code:baseCode,copay:baseCop,chargeback:baseRow.chargeback,profit:baseCop-baseRow.chargeback};
    const partB={code:addonCode,copay:addCop,chargeback:addRow.chargeback,profit:addCop-addRow.chargeback};

    const sumCop=partA.copay+partB.copay;
    if(STRICT_PRICING){
      const csvTotal=num(row.copay)||sumCop;
      if(Math.abs(sumCop-csvTotal)>0.01) return null;
    }
    return [partA,partB];
  }

  function buildCompositeByParts(parts, row){
    // Resolve each code, take exact rows; if any missing → invalid
    const resolved=[];
    for(const c of parts){
      const r=resolveSingle(c);
      if(!r) return null;
      resolved.push({code:c,copay:r.copay,chargeback:r.chargeback,profit:r.copay-r.chargeback});
    }
    // STRICT check: if CSV line has numbers, they must equal sums
    const sumCop=sum(resolved.map(p=>p.copay));
    const sumCB =sum(resolved.map(p=>p.chargeback));
    if(STRICT_PRICING){
      const csvCop=num(row.copay)||sumCop;
      const csvCB =num(row.chargeback)||sumCB;
      if(Math.abs(sumCop-csvCop)>0.01 || Math.abs(sumCB-csvCB)>0.01) return null;
    }
    return resolved;
  }

  function line(row){
    // Always build from actual rows; never invent values
    const desc=row.enhancement||row.subtype||'—';
    let codeStr=String(row.code||'').trim().toUpperCase();
    if(!codeStr && /^Progressive/i.test(desc||'')){
      const inferred=inferProgressiveBaseCodeFromDesc(desc); if(inferred) codeStr=inferred;
    }
    const parts=splitCodes(codeStr);
    if(parts.length===0) return null;

    if(parts.length===1){
      const resolved=resolveSingle(parts[0]);
      if(!resolved) return null;
      return {name:desc,code:parts[0],copay:resolved.copay,chargeback:resolved.chargeback,profit:resolved.profit,parts:[]};
    }

    // composite
    let resolvedParts=null;
    if(row.notes){ // try strict note split first
      const fromNotes=buildCompositeFromNotes(parts[0],parts[1],row);
      if(fromNotes) resolvedParts=fromNotes;
    }
    if(!resolvedParts){
      resolvedParts=buildCompositeByParts(parts,row);
      if(!resolvedParts) return null;
    }

    const cop=sum(resolvedParts.map(p=>p.copay));
    const cb =sum(resolvedParts.map(p=>p.chargeback));
    return {name:desc,code:parts.join('+'),copay:cop,chargeback:cb,profit:cop-cb,parts:resolvedParts};
  }

  function chooseSun(baseRow){
    const tintSel=el('lensTint').value;
    if(tintSel==='tinted_solid') return resolveSingle('MN');
    if(tintSel==='tinted_gradient') return resolveSingle('MP');
    if(tintSel==='transitions'){
      const want = (/glass/i.test(baseRow.name||'')) ? 'PM' : 'PR';
      return resolveSingle(want);
    }
    return null;
  }

  function maybeCM(baseRow){
    if(!(el('includeCM')?.checked && isPAL())) return null;
    const c=(splitCodes(baseRow.code||'')[0]||'').toUpperCase();
    const ok=(c==='NA' || c==='OA');
    if(!ok) return null;
    const row=DATA.find(r=>applies(r,'PAL') && /custom\s*measure/i.test(N(r.enhancement||r.subtype||'')));
    if(!row) return null;
    const resolved=resolveSingle(splitCodes(row.code)[0]||'CM');
    if(!resolved) return null;
    return resolved;
  }

  function makeBundle(base, addOns){
    const rows=[base,...addOns.filter(Boolean)];
    const lines=rows.map(line);
    if(lines.some(x=>!x)) return {invalid:true};

    const cop=sum(lines.map(x=>x.copay));
    const cb =sum(lines.map(x=>x.chargeback));
    const pr =cop-cb;
    const label=base.enhancement||base.subtype||base.code||'Base';

    // verify header vs totals (defensive)
    if(STRICT_PRICING){
      for(const li of lines){
        if(li.profit.toFixed(2)!==(li.copay-li.chargeback).toFixed(2)) return {invalid:true};
      }
    }
    return {label,lines,copay:cop,chargeback:cb,profit:pr};
  }

  /* ---------- pipeline ---------- */
  let REJECT_REASONS=0;
  function computeBundles(){
    const fam=el('lensFamily').value;
    const wantAR=el('includeAR').checked;
    const wantAsp=el('includeAspheric').checked;
    const wantOS =el('includeOversize').checked;
    const wantGlass=el('includeGlass').checked;
    const tintSel=el('lensTint').value;

    // base pool
    let base=[];
    if(fam==='PAL'){
      base=DATA.filter(r=> (r.active||'yes').toLowerCase()==='yes' && (r.exclusive_key||'').toLowerCase()==='progressive_level' && applies(r,fam))
        .filter(r=>{
          const name=N(r.enhancement||'');
          if(wantGlass && !/glass/.test(name)) return false;
          if(!wantGlass && /glass/.test(name)) return false;
          if(/custom\s*measure/i.test(name)) return false;
          if(tintSel==='polarized') return /polariz/.test(name);
          return !/(photochrom|polariz|tint|tinted|sunglass|gradient|color|colored)/.test(name);
        });
    }else{
      if(tintSel==='polarized'){
        base=DATA.filter(r=> (r.active||'yes').toLowerCase()==='yes' && (r.exclusive_key||'').toLowerCase()==='sun_tech' && applies(r,fam))
          .filter(r=>{
            const n=N(r.enhancement||'');
            if(!/polariz/.test(n)) return false;
            if(wantGlass) return /glass/.test(n);
            return !/glass/.test(n) && /^[d]/i.test(r.code||'');
          });
      }else{
        let pool=(fam==='SV'?DATA.filter(r=>(r.exclusive_key||'').toLowerCase()==='base_material'):DATA.filter(r=>(r.exclusive_key||'').toLowerCase()==='occupational'));
        pool=pool.filter(r=> (r.active||'yes').toLowerCase()==='yes' && applies(r,fam))
          .filter(r=>{
            const name=N(r.enhancement||'');
            if(wantGlass && !/glass/.test(name)) return false;
            if(!wantGlass && /glass/.test(name)) return false;
            if(/photochrom|polariz|tint|tinted|sunglass|gradient|color|colored/.test(name)) return false;
            const asph = /aspheric/.test(name) || /^BA\b/.test((r.code||'').trim().toUpperCase());
            return wantAsp?asph:!asph;
          });
        // collapse duplicates by base code per family
        const byCode=new Map();
        for(const r of pool){ const c=splitCodes(r.code)[0]; if(!byCode.has(c)) byCode.set(c,[]); byCode.get(c).push(r); }
        pool=[...byCode.values()].map(rows=>chooseVariantForFamily(rows,fam)).filter(Boolean);
        base=pool;
      }
    }

    // AR pool
    function rankAR(ars){
      const gradeVal=s=>{ const m=String(s||'').match(/\b([A-D])\b/i); if(!m) return -1; return {A:4,B:3,C:2,D:1}[m[1].toUpperCase()]||-1; };
      return [...ars].sort((a,b)=>{
        const ga=gradeVal(a.enhancement), gb=gradeVal(b.enhancement);
        if(ga!==gb) return gb-ga;
        // prefer higher service fee
        const sa=num(a.copay)-num(a.chargeback), sb=num(b.copay)-num(b.chargeback);
        return sb-sa;
      });
    }
    const arOptions = (wantAR ? rankAR(DATA.filter(r=> (r.active||'yes').toLowerCase()==='yes' && (r.exclusive_key||'').toLowerCase()==='ar_level' && applies(r,fam))) : []).slice(0) || [];
    const arList = wantAR && arOptions.length ? arOptions : [null];

    const overs = wantOS ? (DATA.find(r=> (r.exclusive_key||'').toLowerCase()==='oversize' && applies(r,fam))||null) : null;

    const all=[];
    REJECT_REASONS=0;
    for(const m of base){
      for(const ar of arList){
        const cm = maybeCM(m);
        const sun=chooseSun(m);
        const bundle=makeBundle(m,[ar,sun,cm,overs]);
        if(bundle.invalid){ REJECT_REASONS++; continue; }
        all.push(bundle);
      }
    }

    // pick Best/Better/Good/Cheapest deterministically
    if(!all.length){ renderStack([{name:'Best',cls:'best',b:null},{name:'Better',cls:'better',b:null},{name:'Good',cls:'good',b:null},{name:'Cheapest',cls:'good',b:null}], true); return; }
    const sorted=[...all].sort((a,b)=>a.copay-b.copay);
    const best = all.reduce((p,c)=>(!p||c.profit>p.profit||(c.profit===p.profit&&c.copay<c.copay)?c:p),null);
    const maxPrice=Math.max(...all.map(b=>b.copay));
    const cap=(k)=>maxPrice*k;
    const under=(cap)=>all.filter(b=>b.copay<=cap).sort((a,b)=> (b.profit-a.profit)|| (a.copay-b.copay))[0] || all.sort((a,b)=>a.copay-b.copay)[0];
    const better=under(0.75);
    const good  =under(0.60);
    const cheapest=sorted[0];

    // de-dupe
    const picks=[best,better,good,cheapest].filter(Boolean);
    const uniq=[], seen=new Set();
    for(const b of picks){
      const sig=[b.label,b.copay.toFixed(2),b.chargeback.toFixed(2),b.profit.toFixed(2)].join('|');
      if(!seen.has(sig)){ seen.add(sig); uniq.push(b); }
    }
    renderStack([
      {name:'Best',cls:'best',b:uniq[0]||null},
      {name:'Better',cls:'better',b:uniq[1]||null},
      {name:'Good',cls:'good',b:uniq[2]||null},
      {name:'Cheapest',cls:'good',b:uniq[3]||null},
    ]);
  }

  function renderStack(rows,empty=false){
    const stack=el('stack'); stack.innerHTML='';
    for(const r of rows){
      const node=renderTier({...r,invalid:false});
      if(node) stack.appendChild(node);
    }
    fitTextAll(); fitViewportScale();

    const msg = empty ? `no bundles` : `ok • ${rows.filter(x=>x.b).length} picks • rejects=${REJECT_REASONS}${STRICT_PRICING?' • STRICT':''}`;
    el('status').textContent = msg;
    el('status').title = `Bundles rejected by pricing guard: ${REJECT_REASONS}. STRICT mode ensures all totals are proven from CSV (notes + exact code rows) — no inferred math.`;
  }

  /* ---------- boot ---------- */
  async function loadCSV(){
    const status=el('status'); status.textContent=' loading…';
    let loaded=null;
    for(const url of CSV_CANDIDATES){ const r=await tryFetch(url); if(r.ok){ loaded=r; break; } }
    if(loaded){
      const meta={plan:'VSP_choice',version:new Date().toISOString().slice(0,10)+'.strict-ui',source:'network:'+loaded.url,sha:quickHash(loaded.text)};
      setCache(loaded.text,meta); DATA=parseCSV(loaded.text); buildSimpleIndex(); renderMeta(DATA.length,meta);
      status.textContent=` [ok] ${loaded.url} • ${DATA.length} rows`; computeBundles(); return;
    }
    const {text,meta}=getCache();
    if(text){ DATA=parseCSV(text); buildSimpleIndex(); renderMeta(DATA.length,{...meta,source:'cache'}); status.textContent=` cache • ${DATA.length} rows`; computeBundles(); return; }
    status.textContent=' load failed — no data';
  }

  document.getElementById('forceRefresh').onclick=()=>{ localStorage.removeItem('rev-vsp-choice-csv-v1'); localStorage.removeItem('rev-vsp-choice-meta-v1'); loadCSV(); };
  document.getElementById('clearCache').onclick =()=>{ localStorage.removeItem('rev-vsp-choice-csv-v1'); localStorage.removeItem('rev-vsp-choice-meta-v1'); el('status').textContent=' cache cleared — click Force Refresh to reload'; };
  ['lensFamily','lensTint','includeAR','includeAspheric','includeOversize','includeGlass','includeCM'].forEach(id=>{ const n=el(id); if(n) n.onchange=computeBundles; });

  loadCSV();
}
</script>
</body>
</html>
