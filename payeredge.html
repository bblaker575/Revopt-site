<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PayerEdge — VSP Bundles</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#090e16;--bg-elev:#0c1320;--fg:#eaf1ff;--muted:#9fb0c9;--line:#263448;--accent:#72a8ff;--accent-2:#7be0c3;
  --tier-best:#ffd166;--tier-better:#a9c2ff;--tier-good:#7be0c3;
  --shadow-lg:0 18px 40px rgba(0,0,0,.35);--shadow-md:0 10px 26px rgba(0,0,0,.28);
  --radius:18px;--radius-sm:12px;
  --fz-11:11px;--fz-12:12px;--fz-13:13px;--fz-14:14px;--fz-15:15px;--fz-18:18px;--fz-20:20px;--fz-36:36px;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;background:
    radial-gradient(1200px 600px at 20% -10%, rgba(90,168,255,.12), transparent 60%),
    radial-gradient(900px 500px at 110% 10%, rgba(123,224,195,.10), transparent 60%),
    var(--bg);
  color:var(--fg);font:var(--fz-15)/1.45 Inter,system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-variant-numeric:tabular-nums
}
header{
  position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:center;gap:14px;padding:12px 16px;
  background:linear-gradient(180deg, rgba(9,14,22,.95), rgba(9,14,22,.78));border-bottom:1px solid var(--line);backdrop-filter:blur(10px)
}
h1{margin:0;font-weight:800;font-size:clamp(16px,1.8vw,20px);letter-spacing:.2px}
.sub{color:var(--muted);font-size:var(--fz-12)} .version{color:var(--muted)}
main{padding:14px}

/* toolbar */
.bar{display:flex;align-items:center;flex-wrap:wrap;gap:10px 12px;background:linear-gradient(180deg,var(--bg-elev),#0b1220);
  border:1px solid var(--line);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow-md)}
.group{display:flex;gap:8px;align-items:center;padding:6px 8px;border-radius:999px;background:#0b1424}
.btn{background:#121f35;border:1px solid var(--line);color:var(--fg);padding:6px 9px;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;transition:.15s}
.btn:hover{background:#162844;border-color:#2e4260}
.switch{display:inline-flex;align-items:center;gap:8px}
select{background:#0e1a30;color:#fff;border:1px solid var(--line);border-radius:10px;padding:6px 8px;outline:none}
select:focus{box-shadow:0 0 0 3px rgba(114,168,255,.25)}
#status{margin-left:auto;padding:6px 10px;border-radius:999px;border:1px dashed var(--line);background:#0b1422;color:#c7d6ef;font-size:var(--fz-12);max-width:52vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* card grid */
.viewport-frame { transform-origin: top left; width: 100%; }
.stack{display:grid;grid-template-columns:repeat(4,minmax(320px,1fr));gap:14px;align-items:stretch;margin-top:12px;overflow:visible;min-width:0}

/* tier card */
.tier{background:linear-gradient(180deg,#0f1726,#0c1422);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:12px;min-width:0}
.tierHead{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;margin-bottom:8px;min-width:0}
.stars{font-weight:800;display:flex;align-items:center;gap:8px;min-width:0}
.stars.best{color:var(--tier-best)} .stars.better{color:var(--tier-better)} .stars.good{color:var(--tier-good)}
.figures{text-align:right;display:grid;gap:2px}
.hero{font-size:clamp(20px,2.6vw,36px);font-weight:800;line-height:1.0;letter-spacing:.2px;color:#cfe6ff;text-shadow:0 6px 18px rgba(114,168,255,.18)}
.caption{color:var(--muted);font-size:var(--fz-12)} .svc{font-weight:800;color:var(--accent-2)}

/* table */
table.bundle{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
table.bundle th,td{padding:6px 6px;text-align:left;font-size:var(--fz-12);vertical-align:top;overflow:hidden;text-overflow:ellipsis}
table.bundle thead th{color:var(--muted);font-weight:700;white-space:nowrap;padding-top:4px;padding-bottom:5px}
.cell-item{overflow-wrap:break-word}
.cell-item .label{-webkit-line-clamp:2;-webkit-box-orient:vertical;display:-webkit-box;overflow:hidden;text-overflow:ellipsis;line-height:1.32}
.cell-code{white-space:nowrap}
.cell-money{white-space:nowrap;font-weight:800;font-size:clamp(11px,1.1vw,13px);font-variant-numeric:tabular-nums;padding-left:18px;min-width:116px;text-align:right}

/* row rules */
table.bundle tbody td{border-bottom:1px dashed #203043}
table.bundle tfoot th,table.bundle tfoot td{border-top:1px solid rgba(255,255,255,.08);border-bottom:0;padding-top:9px;padding-bottom:8px}

/* breakdown */
details.break summary{cursor:pointer;opacity:.85;font-size:12px;letter-spacing:.1px}
.breakbox{padding:4px 8px 8px}
.breakgrid{display:grid;grid-template-columns:1fr repeat(3,minmax(0,0.9fr));gap:4px 8px;align-items:center}
.breakgrid .money{text-align:right;font-variant-numeric:tabular-nums;padding-left:8px;font-weight:800;font-size:12px}
.codepill{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border:1px solid var(--line);border-radius:999px;
  font-family:ui-monospace,Menlo,Consolas,monospace;font-size:11px;color:#cfe1ff;background:#0e1a30;white-space:nowrap;max-width:84px;overflow:hidden;text-overflow:ellipsis}

/* responsive text */
@media (max-width:1280px){.hero{font-size:clamp(18px,2.2vw,30px)}}
:focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:8px}
@media print{header,.bar{display:none} body{background:#fff;color:#000}.tier{break-inside:avoid;border:1px solid #000;box-shadow:none} table,th,td{border-color:#000}}
</style>
</head>
<body>
<header>
  <div>
    <h1>PayerEdge — VSP Bundles</h1>
    <div class="sub">Scoreboard shows <b>patient copay</b> and <b>service fee</b> (Copay − Holdback). Sun choices are exclusive.</div>
  </div>
  <div class="version sub" id="version">loading…</div>
</header>
<main>
  <div class="bar">
    <div class="group"><button class="btn" id="forceRefresh">Force Refresh</button><button class="btn" id="clearCache">Clear Cache</button></div>
    <div class="group">
      <label class="switch">Lens family
        <select id="lensFamily"><option value="SV">Single Vision</option><option value="LINED">Lined Bi/Tri</option><option value="PAL" selected>Progressive</option></select>
      </label>
      <label class="switch">Lens tint
        <select id="lensTint"><option value="clear" selected>Clear</option><option value="tinted_solid">Tinted — Solid</option><option value="tinted_gradient">Tinted — Gradient</option><option value="polarized">Polarized</option><option value="transitions">Transitions®</option></select>
      </label>
    </div>
    <div class="group">
      <label class="switch"><input type="checkbox" id="includeAR" checked> Include AR</label>
      <label class="switch"><input type="checkbox" id="includeAspheric"> Aspheric</label>
      <label class="switch"><input type="checkbox" id="includeOversize"> Oversize</label>
      <label class="switch"><input type="checkbox" id="includeGlass"> Glass</label>
      <label class="switch"><input type="checkbox" id="includeCM"> Custom measurements (N/O only)</label>
    </div>
    <span id="status"></span>
  </div>
  <div id="frame" class="viewport-frame"><div id="stack" class="stack"></div></div>
</main>

<script>
if(!window.__PAYEREDGE_V16_9_1__){
  window.__PAYEREDGE_V16_9_1__=true;
  const CSV_CANDIDATES=['./vsp_choice_master_v8.4.csv','./data/vsp_choice_master_v8.4.csv'];
  const el=id=>document.getElementById(id);
  const num=v=>{const x=parseFloat(String(v??'').replace(/[^0-9.-]/g,''));return isFinite(x)?x:0;};
  const quickHash=s=>{let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619)>>>0;}return ('00000000'+h.toString(16)).slice(-8);};

  function parseCSV(text){const rows=[];let row=[],field='',q=false;for(let i=0;i<text.length;i++){const ch=text[i];if(ch==='\"'){if(q&&text[i+1]==='\"'){field+='\"';i++;}else{q=!q;}continue;}if(!q&&ch===','){row.push(field);field='';continue;}if(!q&&(ch==='\n'||ch==='\r')){if(field!==''||row.length){row.push(field);rows.push(row);row=[];field='';}continue;}field+=ch;}if(field!==''||row.length){row.push(field);rows.push(row);}const headers=rows.shift().map(h=>h.replace(/^\"|\"$/g,''));return rows.filter(r=>r.length>=headers.length).map(r=>{const o={};headers.forEach((h,i)=>o[h]=(r[i]||'').replace(/^\"|\"$/g,''));return o;});}
  let DATA=[];

  async function loadCSV(){
    const status=el('status');status.textContent=' loading…';
    for(const url of CSV_CANDIDATES){
      try{const res=await fetch(url,{cache:'no-store'});if(res.ok){const text=await res.text();DATA=parseCSV(text);renderMeta(DATA.length,{url,sha:quickHash(text)});computeBundles();return;}}catch(e){}
    }
    status.textContent=' load failed';
  }
  function renderMeta(count,meta){el('version').textContent=`rows=${count} • sha=${meta.sha||'—'} • ${meta.url||''}`;}

  function computeBundles(){ // dummy demo
    renderStack([{name:'Best',cls:'best',b:{label:'Demo',copay:200,chargeback:100,profit:100,lines:[{name:'NA Progressive N – Plastic',code:'NA',copay:175,chargeback:80,profit:95,parts:[]},{name:'Add-on',code:'NJ',copay:125,chargeback:48,profit:77,parts:[]}]}},
                 {name:'Better',cls:'better',b:null},{name:'Good',cls:'good',b:null},{name:'Cheapest',cls:'good',b:null}]);}

  function tdMoney(v){return `<td class="cell-money">$${v.toFixed(2)}</td>`;}
  function renderTier({name,cls,b}){
    const div=document.createElement('div');div.className='tier';
    if(!b){div.innerHTML=`<div class="tierHead"><div class="stars ${cls}"><span>${name}</span></div><div class="figures"><div class="hero">—</div><div class="caption">Patient Copay</div></div></div>`;return div;}
    const stars=name==='Best'?'★★★':name==='Better'?'★★':name==='Good'?'★':'◎';
    const head=`<div class="tierHead"><div class="stars ${cls}"><div style="font-size:18px">${stars}</div><span class="tag">${b.label}</span></div>
      <div class="figures"><div class="hero">$${b.copay.toFixed(2)}</div><div class="caption">Patient Copay</div><div class="caption">Profit: <span class="svc">$${b.profit.toFixed(2)}</span></div></div></div>`;
    const lines=b.lines.map(li=>`<tr><td class="cell-item"><span class="label" title="${li.name}">${li.name}</span></td><td class="cell-code">${li.code}</td>${tdMoney(li.copay)}${tdMoney(li.chargeback)}${tdMoney(li.profit)}</tr>`).join('');
    div.innerHTML=head+`<table class="bundle"><colgroup><col style="width:35%"><col style="width:10%"><col style="width:19%"><col style="width:18%"><col style="width:18%"></colgroup>
      <thead><tr><th>Item</th><th>Code</th><th>Copay</th><th>Holdback</th><th>Service Fee</th></tr></thead>
      <tbody>${lines}</tbody><tfoot><tr><th colspan="2" style="text-align:right">Totals</th>${tdMoney(b.copay)}${tdMoney(b.chargeback)}${tdMoney(b.profit)}</tr></tfoot></table>`;
    return div;
  }
  function renderStack(rows){const stack=el('stack');stack.innerHTML='';rows.forEach(r=>stack.appendChild(renderTier(r)));}
  loadCSV();
}
</script>
</body>
</html>
