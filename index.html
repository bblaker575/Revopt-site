<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PayerEdge — VSP Bundles</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#090e16;--bg-elev:#0c1320;--fg:#eaf1ff;--muted:#9fb0c9;--line:#263448;--accent:#72a8ff;--accent-2:#7be0c3;
      --tier-best:#ffd166;--tier-better:#a9c2ff;--tier-good:#7be0c3;
      --shadow-lg:0 18px 40px rgba(0,0,0,.35);--shadow-md:0 10px 26px rgba(0,0,0,.28);
      --radius:18px;
      --w-item:34%; --w-code:20%; --w-money:23%;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;background:
        radial-gradient(1200px 600px at 20% -10%, rgba(90,168,255,.12), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(123,224,195,.10), transparent 60%),
        var(--bg);
      color:var(--fg);font:15px/1.45 Inter,system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-variant-numeric:tabular-nums
    }
    header{position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:center;gap:14px;padding:12px 16px;
      background:linear-gradient(180deg, rgba(9,14,22,.95), rgba(9,14,22,.78));border-bottom:1px solid var(--line);backdrop-filter:blur(10px)}
    h1{margin:0;font-weight:800;font-size:clamp(16px,1.8vw,20px)}
    .sub{color:var(--muted);font-size:12px}
    main{padding:14px}
    .bar{display:flex;align-items:center;flex-wrap:wrap;gap:10px 12px;background:linear-gradient(180deg,var(--bg-elev),#0b1220);
      border:1px solid var(--line);border-radius:18px;padding:10px;box-shadow:var(--shadow-md)}
    .group{display:flex;gap:8px;align-items:center;padding:6px 8px;border-radius:999px;background:#0b1424}
    .btn{background:#121f35;border:1px solid var(--line);color:var(--fg);padding:6px 9px;border-radius:12px;cursor:pointer;font-weight:600;transition:.15s}
    .btn:hover{background:#162844;border-color:#2e4260}
    #status{margin-left:auto;padding:6px 10px;border-radius:999px;border:1px dashed var(--line);background:#0b1422;color:#c7d6ef;font-size:12px;max-width:52vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .viewport-frame{transform-origin:top left;width:100%}
    .stack{display:grid;grid-template-columns:repeat(4,minmax(320px,1fr));gap:14px;align-items:stretch;margin-top:12px}
    .tier{background:linear-gradient(180deg,#0f1726,#0c1422);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow-lg);padding:12px}
    .tierHead{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;margin-bottom:8px}
    .stars{font-weight:800;display:flex;align-items:center;gap:8px}
    .stars.best{color:var(--tier-best)} .stars.better{color:var(--tier-better)} .stars.good{color:var(--tier-good)}
    .figures{text-align:right;display:grid;gap:2px}
    .hero{font-size:clamp(20px,2.6vw,36px);font-weight:600;line-height:1;letter-spacing:.2px;color:#cfe6ff}
    .caption{color:var(--muted);font-size:12px}
    .svc{font-weight:600;color:var(--accent-2)}
    table.bundle{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    th,td{border-bottom:1px dashed #203043;padding:8px 6px;font-size:12px;vertical-align:top}
    thead th{color:var(--muted);font-weight:700;line-height:1.15;white-space:nowrap}
    .bundle col:nth-child(1){width:var(--w-item)} .bundle col:nth-child(2){width:var(--w-code)}
    .bundle col:nth-child(3),.bundle col:nth-child(4){width:var(--w-money)}
    .cell-item{line-height:1.32;padding-bottom:2px}
    .cell-item .label{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;font-size:.95em}
    .cell-code{white-space:normal;word-break:break-word;overflow:visible;text-overflow:clip}
    .cell-money{white-space:nowrap;font-weight:600;text-align:right;font-size:clamp(11px,1.05vw,13px);
      font-variant-numeric:tabular-nums;padding-left:16px;padding-right:6px;min-width:110px}
    @media (max-width:900px){.stack{grid-template-columns:1fr}}

    /* OCR preview panel */
    .ocr-panel{margin-top:12px;display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
    .card{background:linear-gradient(180deg,#0f1726,#0c1422);border:1px solid var(--line);border-radius:14px;padding:10px}
    .card h3{margin:0 0 6px 0;font-size:13px;color:#cfe6ff}
    .card pre{white-space:pre-wrap;word-break:break-word;font:12px/1.35 ui-monospace,Menlo,Consolas,monospace;color:#bcd3ff;max-height:260px;overflow:auto;margin:0}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px 10px}
    .kv .k{color:#9fb0c9}
    .kv .v{font-weight:700}
  </style>
</head>
<body>
<header>
  <div>
    <h1>PayerEdge — VSP Bundles</h1>
    <div class="sub">Scoreboard shows <b>patient copay</b> and <b>service fee</b>. Sun choices are exclusive.</div>
  </div>
  <div class="sub" id="version">loading…</div>
</header>

<main>
  <div class="bar" role="toolbar" aria-label="Bundle controls">
    <div class="group">
      <button class="btn" id="forceRefresh">Force Refresh</button>
      <button class="btn" id="clearCache">Clear Cache</button>
    </div>

    <!-- your other controls here... -->

    <!-- OCR group -->
    <div class="group">
      <button class="btn" id="scanBenefitsBtn">Scan Benefits (Camera / PDF)</button>
      <!-- Accept BOTH image/* and application/pdf explicitly -->
      <input id="scanBenefitsFile" type="file" accept="application/pdf,image/*" capture="environment" style="display:none">
    </div>

    <span id="status" aria-live="polite"></span>
  </div>

  <div id="frame" class="viewport-frame">
    <div id="stack" class="stack"></div>
  </div>

  <!-- OCR preview and extracted values -->
  <div class="ocr-panel">
    <div class="card">
      <h3>OCR Text Preview</h3>
      <pre id="ocrText">—</pre>
    </div>
    <div class="card">
      <h3>Detected Benefits</h3>
      <div class="kv" id="ocrKV">
        <div class="k">Frame Allowance</div><div class="v" id="kv_frame">—</div>
        <div class="k">Exam Copay</div><div class="v" id="kv_exam">—</div>
        <div class="k">SV Lens Copay</div><div class="v" id="kv_sv">—</div>
        <div class="k">PAL Copay</div><div class="v" id="kv_pal">—</div>
        <div class="k">AR</div><div class="v" id="kv_ar">—</div>
        <div class="k">Photochromic</div><div class="v" id="kv_photo">—</div>
        <div class="k">Polarized</div><div class="v" id="kv_polar">—</div>
      </div>
    </div>
  </div>
</main>

<!-- OCR + PDF libs -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- Use PDF.js v3 (UMD) for widest compatibility on GitHub Pages -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
  // Worker for v3
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
</script>

<script>
/* ============ Base app: status & error surfacing ============ */
window.onerror = function(msg, src, line, col){
  const s=document.getElementById('status');
  if(s) s.textContent = ' script error: ' + msg + ' @' + (src||'') + ':' + (line||'?');
};
const el=id=>document.getElementById(id);
function setStatus(s){ const n=el('status'); if(n) n.textContent=s; }

/* ============ OCR UI bindings ============ */
const scanBtn   = el('scanBenefitsBtn');
const scanInput = el('scanBenefitsFile');
scanBtn?.addEventListener('click', ()=> scanInput?.click());
scanInput?.addEventListener('change', async ()=>{
  const file = scanInput.files?.[0]; if(!file) return;
  try{
    setStatus(`file received (${file.type||file.name})…`);
    scanBtn.disabled = true;

    let canvas;
    if (/pdf$/i.test(file.name) || file.type === 'application/pdf') {
      setStatus('rendering PDF…');
      canvas = await pdfFirstPageToCanvas(file);
    } else {
      setStatus('loading image…');
      canvas = await fileToCanvas(file);
    }

    // Preprocess & OCR passes
    setStatus('cleaning image…');
    const prep1 = preprocess(canvas, {scale:1.8, grayscale:true, threshold:'otsu', unsharp:true});
    const prep2 = preprocess(canvas, {scale:1.4, grayscale:true, threshold:'sauvola', unsharp:true});

    setStatus('reading (pass 1/2)…');
    const t1 = await runTess(prep1, { psm: 6 });
    setStatus('reading (pass 2/2)…');
    const t2 = await runTess(prep2, { psm: 4 });

    let text = chooseBestText(t1, t2);
    if(!text || !text.trim()){
      setStatus('retrying with fallback…');
      const t3 = await runTess(canvas, { psm: 3 });
      text = t3 || '';
    }

    el('ocrText').textContent = text || '—';
    if(!text.trim()){
      setStatus('no text detected — try clearer photo / export PDF again');
      alert('No readable text found. Try taking a straight, well-lit photo, or export the benefits page as a PDF and retry.');
      return;
    }

    setStatus('parsing benefits…');
    const benefits = parseBenefitsSmart(text);
    window.lastBenefits = benefits;
    paintKV(benefits);

    alert([
      `Frame Allowance: ${fmt(benefits.frameAllowance)}`,
      `Exam Copay: ${fmt(benefits.examCopay)}`,
      `PAL (Progressive) Copay: ${fmt(benefits.progressiveCopay)}`,
      `AR: ${benefits.arTier ? 'Tier '+benefits.arTier : fmt(benefits.arCopay)}`,
      `Photochromic: ${fmt(benefits.photochromicCopay)}`,
      `Polarized: ${fmt(benefits.polarizedCopay)}`
    ].join('\n'));

    setStatus('scan complete');
  }catch(e){
    console.error(e);
    setStatus(`scan failed: ${e?.message||e}`);
    alert(`Scan failed.\n\nReason: ${e?.message||e}\n\nTry another photo or export the PDF and retry.`);
  }finally{
    scanBtn.disabled = false;
    scanInput.value='';
  }
});

/* ============ File→Canvas helpers (PDF + images + HEIC) ============ */
async function pdfFirstPageToCanvas(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;
  const page = await pdf.getPage(1);
  const viewport = page.getViewport({scale:2.0});
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = viewport.width; canvas.height = viewport.height;
  await page.render({canvasContext:ctx, viewport}).promise;
  return canvas;
}
function fileToCanvas(file){
  return new Promise((resolve,reject)=>{
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = ()=> {
      try{
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        URL.revokeObjectURL(url);
        resolve(canvas);
      }catch(err){ URL.revokeObjectURL(url); reject(err); }
    };
    img.onerror = () => {
      // Fallback (e.g., HEIC): decode via createImageBitmap
      createImageBitmap(file).then(bitmap=>{
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width; canvas.height = bitmap.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bitmap,0,0);
        URL.revokeObjectURL(url);
        resolve(canvas);
      }).catch(err=>{ URL.revokeObjectURL(url); reject(err); });
    };
    img.src = url;
  });
}

/* ============ Preprocess + OCR ============ */
function preprocess(sourceCanvas, {scale=2, grayscale=true, threshold='otsu', unsharp=true}={}){
  const w = Math.round(sourceCanvas.width * scale);
  const h = Math.round(sourceCanvas.height * scale);
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(sourceCanvas, 0, 0, w, h);

  let imgData = ctx.getImageData(0,0,w,h);
  const d = imgData.data;

  if(grayscale){
    for(let i=0;i<d.length;i+=4){
      const y = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
      d[i]=d[i+1]=d[i+2]=y;
    }
  }
  if(unsharp){
    const blurred = boxBlur(imgData, w, h, 1);
    for(let i=0;i<d.length;i+=4){
      const hp = d[i] - blurred.data[i];
      const v = clamp(d[i] + hp*0.8);
      d[i]=d[i+1]=d[i+2]=v;
    }
  }
  if(threshold){
    if(threshold==='otsu'){
      const t = otsuThreshold(imgData);
      for(let i=0;i<d.length;i+=4){
        const v = d[i] >= t ? 255:0;
        d[i]=d[i+1]=d[i+2]=v;
      }
    } else if(threshold==='sauvola'){
      const win=25, k=0.3;
      const g = new Uint8ClampedArray(d.length/4);
      for(let i=0,pi=0;i<d.length;i+=4,pi++) g[pi]=d[i];
      const mean = boxBlurGray(g, w, h, Math.floor(win/2));
      const std  = localStd(g, mean, w, h, Math.floor(win/2));
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          const i = y*w+x;
          const m = mean[i], s = std[i];
          const T = m*(1 + k*((s/128)-1));
          const v = g[i] > T ? 255:0;
          const di = i*4;
          d[di]=d[di+1]=d[di+2]=v; d[di+3]=255;
        }
      }
    }
  }

  ctx.putImageData(imgData,0,0);
  return canvas;
}
function clamp(v){ return v<0?0:v>255?255:v; }
function boxBlur(imgData, w, h, r){
  const out = new ImageData(w,h);
  const src = imgData.data, dst = out.data;
  const tmp = new Uint32Array(w*h);
  for(let y=0;y<h;y++){
    let sum=0;
    for(let x=0;x<w+r;x++){
      if(x<w){ sum += src[(y*w+x)*4]; }
      if(x>=r){ const xi=x-r; tmp[y*w+xi]=sum/(Math.min(x+1,w)-Math.max(0,x-r)); }
      if(x>=2*r+1){ sum -= src[(y*w+(x-2*r-1))*4]; }
    }
  }
  for(let x=0;x<w;x++){
    let sum=0;
    for(let y=0;y<h+r;y++){
      if(y<h){ sum += tmp[y*w+x]; }
      if(y>=r){
        const yi=y-r;
        const val = sum/(Math.min(y+1,h)-Math.max(0,y-r));
        const di=(yi*w+x)*4;
        dst[di]=dst[di+1]=dst[di+2]=val; dst[di+3]=255;
      }
      if(y>=2*r+1){ sum -= tmp[(y-2*r-1)*w+x]; }
    }
  }
  return out;
}
function boxBlurGray(g, w, h, r){
  const out = new Uint8ClampedArray(w*h);
  const tmp = new Float32Array(w*h);
  for(let y=0;y<h;y++){
    let sum=0;
    for(let x=0;x<w+r;x++){
      if(x<w) sum += g[y*w+x];
      if(x>=r){ const xi=x-r; tmp[y*w+xi]=sum/(Math.min(x+1,w)-Math.max(0,x-r)); }
      if(x>=2*r+1) sum -= g[y*w+(x-2*r-1)];
    }
  }
  for(let x=0;x<w;x++){
    let sum=0;
    for(let y=0;y<h+r;y++){
      if(y<h) sum += tmp[y*w+x];
      if(y>=r){
        const yi=y-r;
        out[yi*w+x]=sum/(Math.min(y+1,h)-Math.max(0,y-r));
      }
      if(y>=2*r+1) sum -= tmp[(y-2*r-1)*w+x];
    }
  }
  return out;
}
function localStd(g, mean, w, h, r){
  const out = new Uint8ClampedArray(w*h);
  const sq = new Uint32Array(w*h);
  for(let i=0;i<g.length;i++) sq[i]=g[i]*g[i];
  const meanSq = boxBlurGray(sq, w, h, r);
  for(let i=0;i<g.length;i++){
    const v = Math.sqrt(Math.max(0, meanSq[i]-mean[i]*mean[i]));
    out[i]=v;
  }
  return out;
}
function otsuThreshold(imgData){
  const hist=new Array(256).fill(0);
  const d=imgData.data;
  for(let i=0;i<d.length;i+=4) hist[d[i]]++;
  const total = d.length/4;
  let sum=0; for(let i=0;i<256;i++) sum += i*hist[i];
  let sumB=0, wB=0, wF=0, varMax=0, t=127;
  for(let i=0;i<256;i++){
    wB += hist[i]; if(wB===0) continue;
    wF = total - wB; if(wF===0) break;
    sumB += i*hist[i];
    const mB = sumB / wB;
    const mF = (sum - sumB) / wF;
    const v = wB*wF*(mB-mF)*(mB-mF);
    if(v>varMax){ varMax=v; t=i; }
  }
  return t;
}
async function runTess(canvas, {psm=6}={}){
  const opts = {
    logger: m => { /* console.log(m); */ },
    tessedit_pageseg_mode: String(psm),
    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789$.,:-/() '
  };
  const out = await Tesseract.recognize(canvas, 'eng', opts);
  return (out && out.data && out.data.text) ? out.data.text : '';
}
function chooseBestText(a,b){
  const score = t => ((t.match(/\$/g)||[]).length*3) + (t.length/500) - ((t.match(/\b[Iil]\b/g)||[]).length);
  return score(a)>=score(b)?a:b;
}

/* ============ Parsing ============ */
function centsOf(s){ if(!s) return null; const m=String(s).replace(/[^\d.]/g,''); if(!m) return null; const [a,b='0']=m.split('.'); return parseInt(a||'0',10)*100+parseInt((b+'00').slice(0,2),10); }
function money(c){ if(c==null) return null; return {cents:c,raw:`$${(c/100).toFixed(2)}`}; }
function fmt(m){ return m?.raw || '—'; }

function parseBenefitsSmart(raw){
  const text = (raw||'').replace(/\r/g,'');
  const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);

  const pickMoneyNear = (keywords, fallbackRegex=/\$\s*\d[\d,]*(?:\.\d{2})?/g) =>{
    let best=null, bestScore=-1;
    for(const line of lines){
      const l=line.toLowerCase();
      const kwScore = keywords.reduce((acc,k)=> acc + (l.includes(k)?1:0), 0);
      if(!kwScore) continue;
      const m = line.match(fallbackRegex);
      if(m && m.length){
        const val = m[m.length-1];
        const c = centsOf(val);
        const score = kwScore*10 + 2;
        if(c!=null && score>bestScore){ best = c; bestScore = score; }
      } else if(/included|covered|no cost|\$0/i.test(line)){
        const score = kwScore*10 + 1;
        if(score>bestScore){ best = 0; bestScore = score; }
      }
    }
    return best!=null ? money(best) : null;
  };

  let arTier = null;
  for(const line of lines){
    const m = /(?:anti[\s-]*reflective|\bAR\b)[^\n]{0,24}(?:tier|level)\s*([ABCD])/i.exec(line);
    if(m){ arTier = m[1].toUpperCase(); break; }
  }
  const arCopay = arTier ? null : pickMoneyNear(['anti-reflective','antireflective',' ar ']);

  const benefits = {
    source: 'VSP',
    frameAllowance: pickMoneyNear(['frame','allowance']),
    examCopay:      pickMoneyNear(['exam','copay']),
    svLensCopay:    pickMoneyNear(['single vision','sv']),
    progressiveCopay: pickMoneyNear(['progressive','pal']),
    arTier,
    arCopay,
    photochromicCopay: pickMoneyNear(['photochrom','transitions']),
    polarizedCopay:    pickMoneyNear(['polariz']),
    rawText: raw
  };
  return benefits;
}
function paintKV(b){
  el('kv_frame').textContent = fmt(b.frameAllowance);
  el('kv_exam').textContent  = fmt(b.examCopay);
  el('kv_sv').textContent    = fmt(b.svLensCopay);
  el('kv_pal').textContent   = fmt(b.progressiveCopay);
  el('kv_ar').textContent    = b.arTier ? ('Tier '+b.arTier) : fmt(b.arCopay);
  el('kv_photo').textContent = fmt(b.photochromicCopay);
  el('kv_polar').textContent = fmt(b.polarizedCopay);
}

/* ============ (Optional) your bundle code bootstrapping ============ */
function loadCSV(){ /* left as-is in your app; omitted here for brevity */ }
(function boot(){
  setStatus('ready');
})();
</script>
</body>
</html>
