<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>PayerEdge — VSP Bundles (v12.8)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--bg:#0b0f14;--fg:#e7eefc;--muted:#9fb0c9;--card:#101722;--line:#233044;--ok:#10b981}
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;border-bottom:1px solid #1b2535}
    h1{font-size:18px;margin:0}
    .meta{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;padding:12px 20px}
    .group{background:#0f1621;border:1px solid var(--line);border-radius:12px;padding:8px 10px;display:flex;gap:10px;align-items:center}
    select{background:#152033;border:1px solid var(--line);color:var(--fg);padding:6px 10px;border-radius:8px}
    .btn{background:#162130;border:1px solid var(--line);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(260px,1fr));gap:14px;padding:0 20px 40px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .card h2{margin:0 0 2px 0;font-size:32px}
    .kicker{color:var(--muted);font-size:12px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-top:1px solid #1b2535;text-align:left}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)}
    .banner{margin:12px 20px;background:#1a1320;border:1px dashed #6b4fa3;padding:10px 12px;border-radius:10px;display:none}
    .small{font-size:12px}
    @media(max-width:1200px){.cards{grid-template-columns:repeat(2,minmax(260px,1fr))}}
    @media(max-width:700px){.cards{grid-template-columns:1fr}}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:11px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>PayerEdge — VSP Bundles</h1>
      <div class="meta">Scoreboard shows <b>patient copay</b> and <b>service fee</b> (Copay − Holdback). Sun choices are exclusive.</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span class="meta">plan=<b id="planName">VSP_choice</b> • version=<b>v12.8</b> • source=<span id="src" class="muted">…</span></span>
      <button class="btn" id="refresh">Force Refresh</button>
      <button class="btn" id="clear">Clear Cache</button>
    </div>
  </header>

  <div class="row">
    <div class="group">
      <span class="muted">Lens family</span>
      <select id="lensFamily"><!-- options filled after CSV loads --></select>
    </div>

    <div class="group">
      <span class="muted">Lens tint</span>
      <select id="lensTint">
        <option>Clear</option>
        <option>Solid</option>
        <option>Gradient</option>
        <option>Photochromic</option>
        <option>Polarized</option>
      </select>
    </div>

    <div class="group" style="gap:12px">
      <label><input type="checkbox" id="ar" checked/> Include AR (tiered)</label>
    </div>

    <div class="group" id="debugBox"><span class="muted">[debug]</span> <span id="meta" class="meta">…</span></div>
  </div>

  <div id="net" class="banner"></div>
  <div class="cards" id="cards"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    /*************** CONFIG ***************/
    const CSV_PATH = "./data/vsp_choice_master_v9_strict.csv";
    const PLAN = "VSP_choice";
    const CACHE_KEY = "payeredge_v128_cache";
    // BA holdback defaults if BA row is absent
    const BA_HOLDBACK_DEFAULT = { SV: 24, MF: 34 };

    const MATERIAL_CARDS = [
      {key:"Hi67", level:"Hi67", title:"Hi67"},
      {key:"Mid",  level:"Mid",  title:"Mid"},
      {key:"Poly", level:"Poly", title:"Poly"},
      {key:"CR",   level:"CR",   title:"CR"}
    ];

    const $cards = document.getElementById("cards");
    const $meta  = document.getElementById("meta");
    const $net   = document.getElementById("net");
    const $fam   = document.getElementById("lensFamily");
    document.getElementById("src").textContent = CSV_PATH;

    const money = n => `$${Number(n||0).toFixed(2).replace(/\.00$/,'')}`;

    /*************** CSV LOAD ***************/
    function normRow(r){
      const o = {};
      for (const [k,v] of Object.entries(r)){
        o[String(k).trim().toLowerCase()] = typeof v === "string" ? v.trim() : v;
      }
      const n = (k)=>{
        const v = o[k];
        if (v==null || v==="") return null;
        const z = String(v).replace(/[^0-9.\-]/g,"");
        return z===""? null : Number(z);
      };
      return {
        plan: o.plan || "",
        kind: (o.kind||"").toLowerCase(),          // pair | base | addon
        code: (o.code||"").toUpperCase(),
        item: o.item || "",
        family: (o.family||"BOTH").toUpperCase(),  // SV | MF | BOTH
        // optional extensions:
        segment: (o.segment||"Any"),               // SV | Prog | Bifocal | Any
        pair_components: (o.pair_components||""),
        // filters:
        material_level: (o.material_level||"—"),
        sun: (o.sun||"—"),
        exclusive_group: o.exclusive_group || "",
        requires_flags: (o.requires_flags||"").toLowerCase().split(/\s*,\s*/).filter(Boolean),
        forbids_flags: (o.forbids_flags||"").toLowerCase().split(/\s*,\s*/).filter(Boolean),
        applies_to: (o.applies_to||"all").toLowerCase(),
        pair_with: (o.pair_with||"").toUpperCase(),
        // numbers
        copay_sv: n("copay_sv"),
        holdback_sv: n("holdback_sv"),
        copay_mf: n("copay_mf"),
        holdback_mf: n("holdback_mf"),
        notes: o.notes || ""
      };
    }

    async function loadCsv(){
      const cached = sessionStorage.getItem(CACHE_KEY);
      if (cached){
        const {rows, when} = JSON.parse(cached);
        const nrows = rows.map(normRow);
        $meta.textContent = `rows=${nrows.length} • cache ${(new Date(when)).toLocaleTimeString()}`;
        return nrows;
      }
      try{
        const res = await fetch(CSV_PATH, {cache:"no-store"});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
        const rows = parsed.data.map(normRow);
        sessionStorage.setItem(CACHE_KEY, JSON.stringify({rows: parsed.data, when: Date.now()}));
        $meta.textContent = `rows=${rows.length} • fresh`;
        return rows;
      }catch(e){
        $net.style.display="block";
        $net.textContent = "Network failed. Using cached data if available.";
        const c2 = sessionStorage.getItem(CACHE_KEY);
        if (c2){
          const {rows} = JSON.parse(c2);
          const r2 = rows.map(normRow);
          $meta.textContent = `rows=${r2.length} • cache (offline)`;
          return r2;
        }
        $meta.textContent = "rows=0 • offline";
        return [];
      }
    }

    /*************** HELPERS ***************/
    function famSegOptionsFromRows(rows){
      // If CSV provides segment, expose SV / Progressive / Lined Bifocal; else SV / Multifocal
      const hasSeg = rows.some(r => ["Prog","Bifocal"].includes(r.segment));
      if (hasSeg){
        return [
          {label:"Single Vision", family:"SV", segment:"SV"},
          {label:"Progressive",   family:"MF", segment:"Prog"},
          {label:"Lined Bifocal", family:"MF", segment:"Bifocal"},
        ];
      }else{
        return [
          {label:"Single Vision", family:"SV", segment:"SV"},
          {label:"Multifocal",    family:"MF", segment:"Any"},
        ];
      }
    }

    function selectedFamSeg(){
      const opt = $fam.options[$fam.selectedIndex];
      return {family: opt.dataset.family, segment: opt.dataset.segment};
    }

    function familyRowVal(row, fam){
      if (fam === "SV") return {copay: row.copay_sv||0, hold: row.holdback_sv||0};
      return {copay: row.copay_mf||0, hold: row.holdback_mf||0};
    }

    function flagsFromUI(){
      return {
        arOn: document.getElementById("ar").checked,
        oversize: document.getElementById("oversize")?.checked || false,
        glass: document.getElementById("glass")?.checked || false,
        aspheric: document.getElementById("aspheric")?.checked || false,
        no_only: document.getElementById("noOnly")?.checked || false,
      };
    }

    function flagsAllow(row, flags){
      for (const f of row.requires_flags){ if (!flags[f]) return false; }
      for (const f of row.forbids_flags){ if (flags[f]) return false; }
      return true;
    }

    function isPositiveSignalAddon(r){
      if ((r.exclusive_group||"").trim()) return true; // e.g., sun
      const req = r.requires_flags||[];
      return req.includes("oversize") || req.includes("no_only") || req.includes("glass");
      // AR handled separately
    }

    function pickExclusive(rows){
      const winners = new Map();
      const passthrough = [];
      for (const r of rows){
        const g = r.exclusive_group||"";
        if (!g){ passthrough.push(r); continue; }
        const prev = winners.get(g);
        if (!prev){ winners.set(g, r); continue; }
        const cA = (r.copay_sv||0)+(r.copay_mf||0);
        const cB = (prev.copay_sv||0)+(prev.copay_mf||0);
        if (cA > cB) winners.set(g, r);
      }
      return [...passthrough, ...winners.values()];
    }

    function getArTiers(rowsForFam, fam){
      const codes = ["QM","QT","QV"];
      const tiers = [];
      for (const code of codes){
        const r = rowsForFam.find(x => x.kind==="addon" && (x.requires_flags||[]).includes("ar") && x.code===code);
        if (!r) continue;
        const {copay, hold} = familyRowVal(r, fam);
        tiers.push({code, copay:copay||0, hold:hold||0, fee:(copay||0)-(hold||0), row:r});
      }
      return tiers;
    }

    function chooseMostProfitableTier(tiers){
      if (!tiers.length) return null;
      // Highest fee, tie-break lower copay
      return tiers.slice().sort((a,b)=> (b.fee - a.fee) || (a.copay - b.copay))[0];
    }

    function pickAR(rowsForFam, fam, flags){
      if (!flags.arOn) return null;
      const tiers = getArTiers(rowsForFam, fam);
      const choice = chooseMostProfitableTier(tiers);
      return choice ? choice.row : null;
    }

    function getBaBaseHoldback(rowsForFam, fam){
      const ba = rowsForFam.find(r => r.code==="BA");
      if (ba){
        const {hold} = familyRowVal(ba, fam);
        if (hold != null) return hold;
      }
      return BA_HOLDBACK_DEFAULT[fam] || 0;
    }

    function byPlan(rows, plan){ return rows.filter(r=> !r.plan || r.plan===plan); }

    function componentBreakdown(pairRow, rowsForFamSeg, fam){
      const raw = (pairRow.pair_components||"").trim();
      if (!raw) return [];
      const codes = raw.split(",").map(s=>s.trim()).filter(Boolean);
      return codes.map(code => {
        const r = rowsForFamSeg.find(x => x.code===code);
        if (!r) return null;
        const {copay, hold} = familyRowVal(r, fam);
        return {code, copay:copay||0, hold:hold||0, fee:(copay||0)-(hold||0)};
      }).filter(Boolean);
    }

    /*************** PIPELINE ***************/
    function bundleRows(rows, fam, seg, level, tint, flags){
      const rowsForFamSeg = rows.filter(r=>{
        const famOk = (r.family==="BOTH" || r.family===fam);
        const segVal = r.segment || "Any";
        const segOk = (segVal==="Any" || segVal===seg || (seg==="SV" && segVal==="SV"));
        return famOk && segOk;
      });

      const pair = rowsForFamSeg.find(r=> r.kind==="pair" && r.material_level===level && r.sun!=="Polarized");
      const cr   = rowsForFamSeg.find(r=> r.kind==="base" && r.code==="AA");

      const addOnsAll = rowsForFamSeg.filter(r=> r.kind==="addon" && isPositiveSignalAddon(r));
      const addOns = addOnsAll.filter(r=> flagsAllow(r, flags) && (r.sun==="Any" || r.sun==="—" || r.sun===tint));
      const addOnsExclusive = pickExclusive(addOns);

      const arRow = pickAR(rowsForFamSeg, fam, flags);

      // BA holdback silently included on bundles, not CR
      const baHold = getBaBaseHoldback(rowsForFamSeg, fam);

      return {pair, cr, addOns:addOnsExclusive, arRow, baHold, rowsForFamSeg};
    }

    function familyLines(row, fam){
      const {copay, hold} = familyRowVal(row, fam);
      return {copay:copay||0, hold:hold||0, fee:(copay||0)-(hold||0)};
    }

    function renderCard(title, mainRow, fam, extras, opts){
      if (!mainRow){
        return `<div class="card"><div class="meta">Missing data for ${title}.</div></div>`;
      }

      // Base lines
      const lines = extras.map(r=> ({r, l: familyLines(r, fam)}));
      const main = familyLines(mainRow, fam);

      // Silent BA holdback on bundles (not CR)
      let baAdj = {copay:0, hold:0, fee:0};
      if (opts.includeBaHoldback){
        baAdj = {copay:0, hold: opts.baHold||0, fee: -(opts.baHold||0)};
      }

      const totals = lines.reduce((s,x)=>({
        copay: s.copay + x.l.copay,
        hold : s.hold  + x.l.hold,
        fee  : s.fee   + x.l.fee
      }), {copay: main.copay + baAdj.copay, hold: main.hold + baAdj.hold, fee: main.fee + baAdj.fee});

      const rowsHtml = [
        {r: mainRow, l: main},
        ...lines
      ].map(({r,l})=>`
        <tr>
          <td>${r.item}</td>
          <td class="muted">${r.code}</td>
          <td class="right">${money(l.copay)}</td>
          <td class="right">${money(l.hold)}</td>
          <td class="right">${money(l.fee)}</td>
        </tr>`).join("");

      // Optional components breakdown (for combo pairs NA+NJ etc.)
      let compHtml = "";
      if (opts.components && opts.components.length){
        compHtml = `
          <tr>
            <td colspan="5">
              <div class="muted small" style="margin:6px 0">
                <span class="pill">Code breakdown</span>
              </div>
              <table style="width:100%;font-size:12px">
                <thead><tr><th>Code</th><th class="right">Copay</th><th class="right">Holdback</th><th class="right">Svc Fee</th></tr></thead>
                <tbody>
                  ${opts.components.map(c=>`
                    <tr>
                      <td class="muted">${c.code}</td>
                      <td class="right">${money(c.copay)}</td>
                      <td class="right">${money(c.hold)}</td>
                      <td class="right">${money(c.fee)}</td>
                    </tr>`).join("")}
                </tbody>
              </table>
            </td>
          </tr>`;
      }

      return `
        <div class="card">
          <h2>${money(totals.copay)}</h2>
          <div class="kicker">Patient Copay<br><span class="ok">Service Fee (Practice Profit): ${money(totals.fee)}</span></div>
          <div class="meta" style="margin-bottom:6px">${title}</div>
          <table>
            <thead><tr><th>Item</th><th>Code</th><th class="right">Copay</th><th class="right">Holdback</th><th class="right">Service Fee</th></tr></thead>
            <tbody>
              ${rowsHtml}
              ${compHtml}
              <tr>
                <td class="muted">Totals</td><td></td>
                <td class="right"><b>${money(totals.copay)}</b></td>
                <td class="right"><b>${money(totals.hold)}</b></td>
                <td class="right"><b>${money(totals.fee)}</b></td>
              </tr>
            </tbody>
          </table>
        </div>`;
    }

    /*************** MAIN ***************/
    let ALL_ROWS = [];

    async function init(){
      ALL_ROWS = byPlan(await loadCsv(), "VSP_choice");
      const options = famSegOptionsFromRows(ALL_ROWS);
      $fam.innerHTML = options.map(o=>`<option data-family="${o.family}" data-segment="${o.segment}">${o.label}</option>`).join("");
      run();
    }

    async function run(){
      const famSeg = selectedFamSeg();
      const fam = famSeg.family;
      const seg = famSeg.segment;
      const tint = document.getElementById("lensTint").value;
      const flags = flagsFromUI();

      const out = [];
      for (const c of MATERIAL_CARDS){
        const {pair, cr, addOns, arRow, baHold, rowsForFamSeg} =
          bundleRows(ALL_ROWS, fam, seg, c.level, tint, flags);

        if (c.level === "CR"){
          if (!cr){ out.push(`<div class="card"><div class="meta">Missing AA (CR) row.</div></div>`); continue; }
          const extras = [...addOns.filter(a=> a.applies_to!="bundle_only")];
          if (flags.arOn && arRow) extras.push(arRow);
          out.push(renderCard("CR", cr, fam, extras, {includeBaHoldback:false, baHold:0, components:[]}));
        } else {
          if (!pair){ out.push(`<div class="card"><div class="meta">Missing pair for ${c.level}.</div></div>`); continue; }
          const extras = [...addOns.filter(a=> a.applies_to!="cr_only")];
          if (flags.arOn && arRow) extras.push(arRow);
          const comps = componentBreakdown(pair, rowsForFamSeg, fam);
          out.push(renderCard(c.title, pair, fam, extras, {
            includeBaHoldback:true, baHold, components: comps
          }));
        }
      }
      $cards.innerHTML = out.join("");
    }

    // events
    document.getElementById("lensTint").addEventListener("change", run);
    document.getElementById("ar").addEventListener("change", run);
    document.getElementById("refresh").addEventListener("click", ()=>{ sessionStorage.removeItem(CACHE_KEY); init(); });
    document.getElementById("clear").addEventListener("click", ()=>{ sessionStorage.clear(); $meta.textContent="cache cleared"; init(); });
    $fam.addEventListener("change", run);

    init();
  </script>
</body>
</html>
